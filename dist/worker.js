var bt=Object.create;var rt=Object.defineProperty;var wt=Object.getOwnPropertyDescriptor;var Et=Object.getOwnPropertyNames;var At=Object.getPrototypeOf,Bt=Object.prototype.hasOwnProperty;var Tt=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var zt=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Et(e))!Bt.call(t,o)&&o!==r&&rt(t,o,{get:()=>e[o],enumerable:!(s=wt(e,o))||s.enumerable});return t};var st=(t,e,r)=>(r=t!=null?bt(At(t)):{},zt(e||!t||!t.__esModule?rt(r,"default",{value:t,enumerable:!0}):r,t));var Q=Tt(B=>{"use strict";var g=function(){var t=new Date,e=4,r=3,s=2,o=1,a=e,h={setLogLevel:function(d){d==this.debug?a=o:d==this.info?a=s:d==this.warn?a=r:(d==this.error,a=e)},debug:function(d,p){console.debug===void 0&&(console.debug=console.log),o>=a&&console.debug("["+g.getDurationString(new Date-t,1e3)+"]","["+d+"]",p)},log:function(d,p){this.debug(d.msg)},info:function(d,p){s>=a&&console.info("["+g.getDurationString(new Date-t,1e3)+"]","["+d+"]",p)},warn:function(d,p){r>=a&&console.warn("["+g.getDurationString(new Date-t,1e3)+"]","["+d+"]",p)},error:function(d,p){e>=a&&console.error("["+g.getDurationString(new Date-t,1e3)+"]","["+d+"]",p)}};return h}();g.getDurationString=function(t,e){var r;function s(l,f){for(var c=""+l,_=c.split(".");_[0].length<f;)_[0]="0"+_[0];return _.join(".")}t<0?(r=!0,t=-t):r=!1;var o=e||1,a=t/o,h=Math.floor(a/3600);a-=h*3600;var d=Math.floor(a/60);a-=d*60;var p=a*1e3;return a=Math.floor(a),p-=a*1e3,p=Math.floor(p),(r?"-":"")+h+":"+s(d,2)+":"+s(a,2)+"."+s(p,3)};g.printRanges=function(t){var e=t.length;if(e>0){for(var r="",s=0;s<e;s++)s>0&&(r+=","),r+="["+g.getDurationString(t.start(s))+","+g.getDurationString(t.end(s))+"]";return r}else return"(empty)"};typeof B<"u"&&(B.Log=g);var b=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};b.prototype.getPosition=function(){return this.position};b.prototype.getEndPosition=function(){return this.buffer.byteLength};b.prototype.getLength=function(){return this.buffer.byteLength};b.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0};b.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()};b.prototype.readAnyInt=function(t,e){var r=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?r=this.dataview.getInt8(this.position):r=this.dataview.getUint8(this.position);break;case 2:e?r=this.dataview.getInt16(this.position):r=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";r=this.dataview.getUint8(this.position)<<16,r|=this.dataview.getUint8(this.position+1)<<8,r|=this.dataview.getUint8(this.position+2);break;case 4:e?r=this.dataview.getInt32(this.position):r=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";r=this.dataview.getUint32(this.position)<<32,r|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,r}else throw"Not enough bytes in buffer"};b.prototype.readUint8=function(){return this.readAnyInt(1,!1)};b.prototype.readUint16=function(){return this.readAnyInt(2,!1)};b.prototype.readUint24=function(){return this.readAnyInt(3,!1)};b.prototype.readUint32=function(){return this.readAnyInt(4,!1)};b.prototype.readUint64=function(){return this.readAnyInt(8,!1)};b.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",r=0;r<t;r++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"};b.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)};b.prototype.readInt8=function(){return this.readAnyInt(1,!0)};b.prototype.readInt16=function(){return this.readAnyInt(2,!0)};b.prototype.readInt32=function(){return this.readAnyInt(4,!0)};b.prototype.readInt64=function(){return this.readAnyInt(8,!1)};b.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),r=0;r<t;r++)e[r]=this.readUint8();return e};b.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),r=0;r<t;r++)e[r]=this.readInt16();return e};b.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),r=0;r<t;r++)e[r]=this.readUint16();return e};b.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),r=0;r<t;r++)e[r]=this.readUint32();return e};b.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),r=0;r<t;r++)e[r]=this.readInt32();return e};typeof B<"u"&&(B.MP4BoxStream=b);var u=function(t,e,r){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=r??u.LITTLE_ENDIAN};u.prototype={};u.prototype.getPosition=function(){return this.position};u.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,r=this._buffer.byteLength;if(e<=r){e>this._byteLength&&(this._byteLength=e);return}for(r<1&&(r=1);e>r;)r*=2;var s=new ArrayBuffer(r),o=new Uint8Array(this._buffer),a=new Uint8Array(s,0,o.length);a.set(o),this.buffer=s,this._byteLength=e}};u.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),r=new Uint8Array(this._buffer,0,e.length);e.set(r),this.buffer=t}};u.BIG_ENDIAN=!1;u.LITTLE_ENDIAN=!0;u.prototype._byteLength=0;Object.defineProperty(u.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}});Object.defineProperty(u.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}});Object.defineProperty(u.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}});Object.defineProperty(u.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}});u.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e};u.prototype.isEof=function(){return this.position>=this._byteLength};u.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e};u.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var r=new Int32Array(t);return u.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),u.arrayToNative(r,e??this.endianness),this.position+=r.byteLength,r};u.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var r=new Int16Array(t);return u.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),u.arrayToNative(r,e??this.endianness),this.position+=r.byteLength,r};u.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e};u.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var r=new Uint32Array(t);return u.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),u.arrayToNative(r,e??this.endianness),this.position+=r.byteLength,r};u.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var r=new Uint16Array(t);return u.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),u.arrayToNative(r,e??this.endianness),this.position+=r.byteLength,r};u.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e};u.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var r=new Float64Array(t);return u.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),u.arrayToNative(r,e??this.endianness),this.position+=r.byteLength,r};u.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var r=new Float32Array(t);return u.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),u.arrayToNative(r,e??this.endianness),this.position+=r.byteLength,r};u.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e};u.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e};u.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t};u.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e};u.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e};u.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t};u.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e};u.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e};u.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0;u.memcpy=function(t,e,r,s,o){var a=new Uint8Array(t,e,o),h=new Uint8Array(r,s,o);a.set(h)};u.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)};u.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)};u.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),r=0;r<t.byteLength;r+=t.BYTES_PER_ELEMENT)for(var s=r+t.BYTES_PER_ELEMENT-1,o=r;s>o;s--,o++){var a=e[o];e[o]=e[s],e[s]=a}return t};u.prototype.failurePosition=0;String.fromCharCodeUint8=function(t){for(var e=[],r=0;r<t.length;r++)e[r]=t[r];return String.fromCharCode.apply(null,e)};u.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))};u.prototype.readCString=function(t){var e=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position),s=e;t!=null&&(s=Math.min(t,e));for(var o=0;o<s&&r[o]!==0;o++);var a=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(o)]);return t!=null?this.position+=s-o:o!=e&&(this.position+=1),a};var O=Math.pow(2,32);u.prototype.readInt64=function(){return this.readInt32()*O+this.readUint32()};u.prototype.readUint64=function(){return this.readUint32()*O+this.readUint32()};u.prototype.readInt64=function(){return this.readUint32()*O+this.readUint32()};u.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()};typeof B<"u"&&(B.DataStream=u);u.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var r=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.setAttribute("href",r),s.setAttribute("download",t),s.setAttribute("target","_self"),s.click(),window.URL.revokeObjectURL(r)}else throw"DataStream.save: Can't create object URL."};u.prototype._dynamicSize=!0;Object.defineProperty(u.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}});u.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),r=new Uint8Array(e),s=new Uint8Array(this._buffer,t,r.length);r.set(s),this.buffer=e,this.position-=t};u.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeInt32(t[r],e)};u.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeInt16(t[r],e)};u.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])};u.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeUint32(t[r],e)};u.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeUint16(t[r],e)};u.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])};u.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeFloat64(t[r],e)};u.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeFloat32(t[r],e)};u.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4};u.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2};u.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1};u.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4};u.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2};u.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1};u.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4};u.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8};u.prototype.writeUCS2String=function(t,e,r){r==null&&(r=t.length);for(var s=0;s<t.length&&s<r;s++)this.writeUint16(t.charCodeAt(s),e);for(;s<r;s++)this.writeUint16(0)};u.prototype.writeString=function(t,e,r){var s=0;if(e==null||e=="ASCII")if(r!=null){var o=Math.min(t.length,r);for(s=0;s<o;s++)this.writeUint8(t.charCodeAt(s));for(;s<r;s++)this.writeUint8(0)}else for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,r)))};u.prototype.writeCString=function(t,e){var r=0;if(e!=null){var s=Math.min(t.length,e);for(r=0;r<s;r++)this.writeUint8(t.charCodeAt(r));for(;r<e;r++)this.writeUint8(0)}else{for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));this.writeUint8(0)}};u.prototype.writeStruct=function(t,e){for(var r=0;r<t.length;r+=2){var s=t[r+1];this.writeType(s,e[t[r]],e)}};u.prototype.writeType=function(t,e,r){var s;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,r);var o=null,a="ASCII",h=this.position;switch(typeof t=="string"&&/:/.test(t)&&(s=t.split(":"),t=s[0],o=parseInt(s[1])),typeof t=="string"&&/,/.test(t)&&(s=t.split(","),t=s[0],a=parseInt(s[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,u.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,u.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,u.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,u.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,u.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,u.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,u.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,u.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,u.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,u.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,u.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,u.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,o);break;case"string":this.writeString(e,a,o);break;case"u16string":this.writeUCS2String(e,this.endianness,o);break;case"u16stringle":this.writeUCS2String(e,u.LITTLE_ENDIAN,o);break;case"u16stringbe":this.writeUCS2String(e,u.BIG_ENDIAN,o);break;default:if(t.length==3){for(var d=t[1],p=0;p<e.length;p++)this.writeType(d,e[p]);break}else{this.writeStruct(t,e);break}}o!=null&&(this.position=h,this._realloc(o),this.position=h+o)};u.prototype.writeUint64=function(t){var e=Math.floor(t/O);this.writeUint32(e),this.writeUint32(t&4294967295)};u.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)};u.prototype.adjustUint32=function(t,e){var r=this.position;this.seek(t),this.writeUint32(e),this.seek(r)};u.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var r=new Int32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(r,e??this.endianness),this.position+=t*4,r};u.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var r=new Int16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(r,e??this.endianness),this.position+=t*2,r};u.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e};u.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var r=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(r,e??this.endianness),this.position+=t*4,r};u.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var r=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(r,e??this.endianness),this.position+=t*2,r};u.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var r=new Float64Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(r,e??this.endianness),this.position+=t*8,r};u.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var r=new Float32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(r,e??this.endianness),this.position+=t*4,r};var T=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};T.prototype=new u(new ArrayBuffer,0,u.BIG_ENDIAN);T.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,g.debug("MultiBufferStream","Stream ready for parsing"),!0):(g.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(g.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)};ArrayBuffer.concat=function(t,e){g.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var r=new Uint8Array(t.byteLength+e.byteLength);return r.set(new Uint8Array(t),0),r.set(new Uint8Array(e),t.byteLength),r.buffer};T.prototype.reduceBuffer=function(t,e,r){var s;return s=new Uint8Array(r),s.set(new Uint8Array(t,e,r)),s.buffer.fileStart=t.fileStart+e,s.buffer.usedBytes=0,s.buffer};T.prototype.insertBuffer=function(t){for(var e=!0,r=0;r<this.buffers.length;r++){var s=this.buffers[r];if(t.fileStart<=s.fileStart){if(t.fileStart===s.fileStart)if(t.byteLength>s.byteLength){this.buffers.splice(r,1),r--;continue}else g.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=s.fileStart||(t=this.reduceBuffer(t,0,s.fileStart-t.fileStart)),g.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(r,0,t),r===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<s.fileStart+s.byteLength){var o=s.fileStart+s.byteLength-t.fileStart,a=t.byteLength-o;if(a>0)t=this.reduceBuffer(t,o,a);else{e=!1;break}}}e&&(g.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),r===0&&(this.buffer=t))};T.prototype.logBufferLevel=function(t){var e,r,s,o,a=[],h,d="";for(s=0,o=0,e=0;e<this.buffers.length;e++)r=this.buffers[e],e===0?(h={},a.push(h),h.start=r.fileStart,h.end=r.fileStart+r.byteLength,d+="["+h.start+"-"):h.end===r.fileStart?h.end=r.fileStart+r.byteLength:(h={},h.start=r.fileStart,d+=a[a.length-1].end-1+"], ["+h.start+"-",h.end=r.fileStart+r.byteLength,a.push(h)),s+=r.usedBytes,o+=r.byteLength;a.length>0&&(d+=h.end-1+"]");var p=t?g.info:g.debug;this.buffers.length===0?p("MultiBufferStream","No more buffer in memory"):p("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+s+"/"+o+" bytes), continuous ranges: "+d)};T.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(g.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)};T.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,r=this.buffer.usedBytes,s=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=r,this.buffer.fileStart=s,g.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1};T.prototype.findPosition=function(t,e,r){var s,o=null,a=-1;for(t===!0?s=0:s=this.bufferIndex;s<this.buffers.length&&(o=this.buffers[s],o.fileStart<=e);){a=s,r&&(o.fileStart+o.byteLength<=e?o.usedBytes=o.byteLength:o.usedBytes=e-o.fileStart,this.logBufferLevel());s++}return a!==-1?(o=this.buffers[a],o.fileStart+o.byteLength>=e?(g.debug("MultiBufferStream","Found position in existing buffer #"+a),a):-1):-1};T.prototype.findEndContiguousBuf=function(t){var e,r,s,o=t!==void 0?t:this.bufferIndex;if(r=this.buffers[o],this.buffers.length>o+1)for(e=o+1;e<this.buffers.length&&(s=this.buffers[e],s.fileStart===r.fileStart+r.byteLength);e++)r=s;return r.fileStart+r.byteLength};T.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t};T.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()};T.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()};T.prototype.seek=function(t,e,r){var s;return s=this.findPosition(e,t,r),s!==-1?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=t-this.buffer.fileStart,g.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(g.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)};T.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position};T.prototype.getLength=function(){return this.byteLength};T.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength};typeof B<"u"&&(B.MultiBufferStream=T);var X=function(){var t=3,e=4,r=5,s=6,o=[];o[t]="ES_Descriptor",o[e]="DecoderConfigDescriptor",o[r]="DecoderSpecificInfo",o[s]="SLConfigDescriptor",this.getDescriptorName=function(d){return o[d]};var a=this,h={};return this.parseOneDescriptor=function(d){var p=0,l=0,f,c,_;for(f=d.readUint8(),p++,_=d.readUint8(),p++;_&128;)l=(_&127)<<7,_=d.readUint8(),p++;return l+=_&127,g.debug("MPEG4DescriptorParser","Found "+(o[f]||"Descriptor "+f)+", size "+l+" at position "+d.getPosition()),o[f]?c=new h[o[f]](l):c=new h.Descriptor(l),c.parse(d),c},h.Descriptor=function(d,p){this.tag=d,this.size=p,this.descs=[]},h.Descriptor.prototype.parse=function(d){this.data=d.readUint8Array(this.size)},h.Descriptor.prototype.findDescriptor=function(d){for(var p=0;p<this.descs.length;p++)if(this.descs[p].tag==d)return this.descs[p];return null},h.Descriptor.prototype.parseRemainingDescriptors=function(d){for(var p=d.position;d.position<p+this.size;){var l=a.parseOneDescriptor(d);this.descs.push(l)}},h.ES_Descriptor=function(d){h.Descriptor.call(this,t,d)},h.ES_Descriptor.prototype=new h.Descriptor,h.ES_Descriptor.prototype.parse=function(d){if(this.ES_ID=d.readUint16(),this.flags=d.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=d.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var p=d.readUint8();this.URL=d.readString(p),this.size-=p+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=d.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(d)},h.ES_Descriptor.prototype.getOTI=function(d){var p=this.findDescriptor(e);return p?p.oti:0},h.ES_Descriptor.prototype.getAudioConfig=function(d){var p=this.findDescriptor(e);if(!p)return null;var l=p.findDescriptor(r);if(l&&l.data){var f=(l.data[0]&248)>>3;return f===31&&l.data.length>=2&&(f=32+((l.data[0]&7)<<3)+((l.data[1]&224)>>5)),f}else return null},h.DecoderConfigDescriptor=function(d){h.Descriptor.call(this,e,d)},h.DecoderConfigDescriptor.prototype=new h.Descriptor,h.DecoderConfigDescriptor.prototype.parse=function(d){this.oti=d.readUint8(),this.streamType=d.readUint8(),this.bufferSize=d.readUint24(),this.maxBitrate=d.readUint32(),this.avgBitrate=d.readUint32(),this.size-=13,this.parseRemainingDescriptors(d)},h.DecoderSpecificInfo=function(d){h.Descriptor.call(this,r,d)},h.DecoderSpecificInfo.prototype=new h.Descriptor,h.SLConfigDescriptor=function(d){h.Descriptor.call(this,s,d)},h.SLConfigDescriptor.prototype=new h.Descriptor,this};typeof B<"u"&&(B.MPEG4DescriptorParser=X);var n={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){n.FullBox.prototype=new n.Box,n.ContainerBox.prototype=new n.Box,n.SampleEntry.prototype=new n.Box,n.TrackGroupTypeBox.prototype=new n.FullBox,n.BASIC_BOXES.forEach(function(t){n.createBoxCtor(t)}),n.FULL_BOXES.forEach(function(t){n.createFullBoxCtor(t)}),n.CONTAINER_BOXES.forEach(function(t){n.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,r){this.type=t,this.size=e,this.uuid=r},FullBox:function(t,e,r){n.Box.call(this,t,e,r),this.flags=0,this.version=0},ContainerBox:function(t,e,r){n.Box.call(this,t,e,r),this.boxes=[]},SampleEntry:function(t,e,r,s){n.ContainerBox.call(this,t,e),this.hdr_size=r,this.start=s},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){n.FullBox.call(this,t,e)},createBoxCtor:function(t,e){n.boxCodes.push(t),n[t+"Box"]=function(r){n.Box.call(this,t,r)},n[t+"Box"].prototype=new n.Box,e&&(n[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){n[t+"Box"]=function(r){n.FullBox.call(this,t,r)},n[t+"Box"].prototype=new n.FullBox,n[t+"Box"].prototype.parse=function(r){this.parseFullHeader(r),e&&e.call(this,r)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,r=0;r<e;r++)this[t[r]+"s"]=[]}},createContainerBoxCtor:function(t,e,r){n[t+"Box"]=function(s){n.ContainerBox.call(this,t,s),n.addSubBoxArrays.call(this,r)},n[t+"Box"].prototype=new n.ContainerBox,e&&(n[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,r){n.sampleEntryCodes[t]=[],n[t+"SampleEntry"]=function(s,o){n.SampleEntry.call(this,s,o),n.addSubBoxArrays.call(this,r)},n[t+"SampleEntry"].prototype=new n.SampleEntry,e&&(n[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,r,s){n.sampleEntryCodes[t].push(e),n[e+"SampleEntry"]=function(o){n[t+"SampleEntry"].call(this,e,o),n.addSubBoxArrays.call(this,s)},n[e+"SampleEntry"].prototype=new n[t+"SampleEntry"],r&&(n[e+"SampleEntry"].prototype.parse=r)},createEncryptedSampleEntryCtor:function(t,e,r){n.createSampleEntryCtor.call(this,t,e,r,["sinf"])},createSampleGroupCtor:function(t,e){n[t+"SampleGroupEntry"]=function(r){n.SampleGroupEntry.call(this,t,r)},n[t+"SampleGroupEntry"].prototype=new n.SampleGroupEntry,e&&(n[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){n[t+"TrackGroupTypeBox"]=function(r){n.TrackGroupTypeBox.call(this,t,r)},n[t+"TrackGroupTypeBox"].prototype=new n.TrackGroupTypeBox,e&&(n[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,r,s){n.UUIDs.push(t),n.UUIDBoxes[t]=function(o){e?n.FullBox.call(this,"uuid",o,t):r?n.ContainerBox.call(this,"uuid",o,t):n.Box.call(this,"uuid",o,t)},n.UUIDBoxes[t].prototype=e?new n.FullBox:r?new n.ContainerBox:new n.Box,s&&(e?n.UUIDBoxes[t].prototype.parse=function(o){this.parseFullHeader(o),s&&s.call(this,o)}:n.UUIDBoxes[t].prototype.parse=s)}};n.initialize();n.TKHD_FLAG_ENABLED=1;n.TKHD_FLAG_IN_MOVIE=2;n.TKHD_FLAG_IN_PREVIEW=4;n.TFHD_FLAG_BASE_DATA_OFFSET=1;n.TFHD_FLAG_SAMPLE_DESC=2;n.TFHD_FLAG_SAMPLE_DUR=8;n.TFHD_FLAG_SAMPLE_SIZE=16;n.TFHD_FLAG_SAMPLE_FLAGS=32;n.TFHD_FLAG_DUR_EMPTY=65536;n.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072;n.TRUN_FLAGS_DATA_OFFSET=1;n.TRUN_FLAGS_FIRST_FLAG=4;n.TRUN_FLAGS_DURATION=256;n.TRUN_FLAGS_SIZE=512;n.TRUN_FLAGS_FLAGS=1024;n.TRUN_FLAGS_CTS_OFFSET=2048;n.Box.prototype.add=function(t){return this.addBox(new n[t+"Box"])};n.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t};n.Box.prototype.set=function(t,e){return this[t]=e,this};n.Box.prototype.addEntry=function(t,e){var r=e||"entries";return this[r]||(this[r]=[]),this[r].push(t),this};typeof B<"u"&&(B.BoxParser=n);n.parseUUID=function(t){return n.parseHex16(t)};n.parseHex16=function(t){for(var e="",r=0;r<16;r++){var s=t.readUint8().toString(16);e+=s.length===1?"0"+s:s}return e};n.parseOneBox=function(t,e,r){var s,o=t.getPosition(),a=0,h,d;if(t.getEndPosition()-o<8)return g.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:n.ERR_NOT_ENOUGH_DATA};if(r&&r<8)return g.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:n.ERR_NOT_ENOUGH_DATA};var p=t.readUint32(),l=t.readString(4),f=l;if(g.debug("BoxParser","Found box of type '"+l+"' and size "+p+" at position "+o),a=8,l=="uuid"){if(t.getEndPosition()-t.getPosition()<16||r-a<16)return t.seek(o),g.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:n.ERR_NOT_ENOUGH_DATA};d=n.parseUUID(t),a+=16,f=d}if(p==1){if(t.getEndPosition()-t.getPosition()<8||r&&r-a<8)return t.seek(o),g.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+l+'" box'),{code:n.ERR_NOT_ENOUGH_DATA};p=t.readUint64(),a+=8}else if(p===0){if(r)p=r;else if(l!=="mdat")return g.error("BoxParser","Unlimited box size not supported for type: '"+l+"'"),s=new n.Box(l,p),{code:n.OK,box:s,size:s.size}}return p!==0&&p<a?(g.error("BoxParser","Box of type "+l+" has an invalid size "+p+" (too small to be a box)"),{code:n.ERR_NOT_ENOUGH_DATA,type:l,size:p,hdr_size:a,start:o}):p!==0&&r&&p>r?(g.error("BoxParser","Box of type '"+l+"' has a size "+p+" greater than its container size "+r),{code:n.ERR_NOT_ENOUGH_DATA,type:l,size:p,hdr_size:a,start:o}):p!==0&&o+p>t.getEndPosition()?(t.seek(o),g.info("BoxParser","Not enough data in stream to parse the entire '"+l+"' box"),{code:n.ERR_NOT_ENOUGH_DATA,type:l,size:p,hdr_size:a,start:o}):e?{code:n.OK,type:l,size:p,hdr_size:a,start:o}:(n[l+"Box"]?s=new n[l+"Box"](p):l!=="uuid"?(g.warn("BoxParser","Unknown box type: '"+l+"'"),s=new n.Box(l,p),s.has_unparsed_data=!0):n.UUIDBoxes[d]?s=new n.UUIDBoxes[d](p):(g.warn("BoxParser","Unknown uuid type: '"+d+"'"),s=new n.Box(l,p),s.uuid=d,s.has_unparsed_data=!0),s.hdr_size=a,s.start=o,s.write===n.Box.prototype.write&&s.type!=="mdat"&&(g.info("BoxParser","'"+f+"' box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),h=t.getPosition()-(s.start+s.size),h<0?(g.warn("BoxParser","Parsing of box '"+f+"' did not read the entire indicated box data size (missing "+-h+" bytes), seeking forward"),t.seek(s.start+s.size)):h>0&&(g.error("BoxParser","Parsing of box '"+f+"' read "+h+" more bytes than the indicated box data size, seeking backwards"),s.size!==0&&t.seek(s.start+s.size)),{code:n.OK,box:s,size:s.size})};n.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)};n.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size};n.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size};n.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4};n.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)};n.ContainerBox.prototype.parse=function(t){for(var e,r;t.getPosition()<this.start+this.size;)if(e=n.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===n.OK)if(r=e.box,this.boxes.push(r),this.subBoxNames&&this.subBoxNames.indexOf(r.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(r.type)]+"s"].push(r);else{var s=r.type!=="uuid"?r.type:r.uuid;this[s]?g.warn("Box of type "+s+" already stored in field of this type"):this[s]=r}else return};n.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)};n.SAMPLE_ENTRY_TYPE_VISUAL="Visual";n.SAMPLE_ENTRY_TYPE_AUDIO="Audio";n.SAMPLE_ENTRY_TYPE_HINT="Hint";n.SAMPLE_ENTRY_TYPE_METADATA="Metadata";n.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle";n.SAMPLE_ENTRY_TYPE_SYSTEM="System";n.SAMPLE_ENTRY_TYPE_TEXT="Text";n.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8};n.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)};n.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size};n.SampleEntry.prototype.parseFooter=function(t){n.ContainerBox.prototype.parse.call(this,t)};n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_HINT);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SYSTEM);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_TEXT);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)});n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avc1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avc2");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avc3");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avc4");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"av01");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"dav1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"hev1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vp08");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vp09");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avs3");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"uncv");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"Opus");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mha1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mha2");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"encv");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"enca");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SYSTEM,"encs");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_TEXT,"enct");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA,"encm");n.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,r=((e&1)+1)*16;this.layer_size=[];for(var s=0;s<3;s++)r==16?this.layer_size[s]=t.readUint16():this.layer_size[s]=t.readUint32()});n.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()});n.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)});n.createBoxCtor("av1C",function(t){var e,r,s=t.readUint8();if(s>>7&!1){g.error("av1C marker problem");return}if(this.version=s&127,this.version!==1){g.error("av1C version "+this.version+" not supported");return}if(s=t.readUint8(),this.seq_profile=s>>5&7,this.seq_level_idx_0=s&31,s=t.readUint8(),this.seq_tier_0=s>>7&1,this.high_bitdepth=s>>6&1,this.twelve_bit=s>>5&1,this.monochrome=s>>4&1,this.chroma_subsampling_x=s>>3&1,this.chroma_subsampling_y=s>>2&1,this.chroma_sample_position=s&3,s=t.readUint8(),this.reserved_1=s>>5&7,this.reserved_1!==0){g.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=s>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=s&15;else if(this.reserved_2=s&15,this.reserved_2!==0){g.error("av1C reserved_2 parsing problem");return}var o=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(o)});n.createBoxCtor("avcC",function(t){var e,r;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,r=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),r-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),r--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),r-=2+this.PPS[e].length;r>0&&(this.ext=t.readUint8Array(r))});n.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()});n.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()});n.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())});n.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()});n.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()});n.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())});n.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())});n.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint16(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}});n.createFullBoxCtor("co64",function(t){var e,r;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(r=0;r<e;r++)this.chunk_offsets.push(t.readUint64())});n.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()});n.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))});n.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()});n.createFullBoxCtor("cslg",function(t){var e;this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())});n.createFullBoxCtor("ctts",function(t){var e,r;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(r=0;r<e;r++){this.sample_counts.push(t.readUint32());var s=t.readInt32();s<0&&g.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(s)}else if(this.version==1)for(r=0;r<e;r++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())});n.createBoxCtor("dac3",function(t){var e=t.readUint8(),r=t.readUint8(),s=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|r>>6&3,this.acmod=r>>3&7,this.lfeon=r>>2&1,this.bit_rate_code=r&3|s>>5&7});n.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var r=0;r<this.num_ind_sub+1;r++){var s={};this.ind_subs.push(s);var o=t.readUint8(),a=t.readUint8(),h=t.readUint8();s.fscod=o>>6,s.bsid=o>>1&31,s.bsmod=(o&1)<<4|a>>4&15,s.acmod=a>>1&7,s.lfeon=a&1,s.num_dep_sub=h>>1&15,s.num_dep_sub>0&&(s.chan_loc=(h&1)<<8|t.readUint8())}});n.createFullBoxCtor("dfLa",function(t){var e=127,r=128,s=[],o=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];this.parseFullHeader(t);do{var a=t.readUint8(),h=Math.min(a&e,o.length-1);if(h?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),s.push(o[h]),a&r)break}while(!0);this.numMetadataBlocks=s.length+" ("+s.join(", ")+")"});n.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()});n.createBoxCtor("dmax",function(t){this.time=t.readUint32()});n.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()});n.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}});n.createFullBoxCtor("dref",function(t){var e,r;this.entries=[];for(var s=t.readUint32(),o=0;o<s;o++)if(e=n.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===n.OK)r=e.box,this.entries.push(r);else return});n.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()});n.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)});n.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var s={};this.entries.push(s),this.version===1?(s.segment_duration=t.readUint64(),s.media_time=t.readInt64()):(s.segment_duration=t.readUint32(),s.media_time=t.readInt32()),s.media_rate_integer=t.readInt16(),s.media_rate_fraction=t.readInt16()}});n.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)});n.createEntityToGroupCtor=function(t,e){n[t+"Box"]=function(r){n.FullBox.call(this,t,r)},n[t+"Box"].prototype=new n.FullBox,n[t+"Box"].prototype.parse=function(r){if(this.parseFullHeader(r),e)e.call(this,r);else for(this.group_id=r.readUint32(),this.num_entities_in_group=r.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var s=r.readUint32();this.entity_ids.push(s)}}};n.createEntityToGroupCtor("aebr");n.createEntityToGroupCtor("afbr");n.createEntityToGroupCtor("albc");n.createEntityToGroupCtor("altr");n.createEntityToGroupCtor("brst");n.createEntityToGroupCtor("dobr");n.createEntityToGroupCtor("eqiv");n.createEntityToGroupCtor("favc");n.createEntityToGroupCtor("fobr");n.createEntityToGroupCtor("iaug");n.createEntityToGroupCtor("pano");n.createEntityToGroupCtor("slid");n.createEntityToGroupCtor("ster");n.createEntityToGroupCtor("tsyn");n.createEntityToGroupCtor("wbbr");n.createEntityToGroupCtor("prgr");n.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof X<"u"){var r=new X;this.esd=r.parseOneDescriptor(new u(e.buffer,0,u.BIG_ENDIAN))}});n.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()});n.createBoxCtor("frma",function(t){this.data_format=t.readString(4)});n.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var r=0;e>=4;)this.compatible_brands[r]=t.readString(4),e-=4,r++});n.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))});n.createBoxCtor("hvcC",function(t){var e,r,s,o,a;this.configurationVersion=t.readUint8(),a=t.readUint8(),this.general_profile_space=a>>6,this.general_tier_flag=(a&32)>>5,this.general_profile_idc=a&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),a=t.readUint8(),this.constantFrameRate=a>>6,this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var h=t.readUint8();for(e=0;e<h;e++){var d=[];this.nalu_arrays.push(d),a=t.readUint8(),d.completeness=(a&128)>>7,d.nalu_type=a&63;var p=t.readUint16();for(r=0;r<p;r++){var l={};d.push(l),o=t.readUint16(),l.data=t.readUint8Array(o)}}});n.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var r=0;r<this.entry_count;r++)if(e=n.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===n.OK)e.box.type!=="infe"&&g.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[r]=e.box;else return});n.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var r=0;if(this.version<2)r=t.readUint16();else if(this.version===2)r=t.readUint32();else throw"version of iloc box not supported";for(var s=0;s<r;s++){var o={};if(this.items.push(o),this.version<2)o.item_ID=t.readUint16();else if(this.version===2)o.item_ID=t.readUint16();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?o.construction_method=t.readUint16()&15:o.construction_method=0,o.data_reference_index=t.readUint16(),this.base_offset_size){case 0:o.base_offset=0;break;case 4:o.base_offset=t.readUint32();break;case 8:o.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var a=t.readUint16();o.extents=[];for(var h=0;h<a;h++){var d={};if(o.extents.push(d),this.version===1||this.version===2)switch(this.index_size){case 0:d.extent_index=0;break;case 4:d.extent_index=t.readUint32();break;case 8:d.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:d.extent_offset=0;break;case 4:d.extent_offset=t.readUint32();break;case 8:d.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:d.extent_length=0;break;case 4:d.extent_length=t.readUint32();break;case 8:d.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}});n.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1});n.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),g.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))});n.createFullBoxCtor("ipma",function(t){var e,r;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var s={};this.associations.push(s),this.version<1?s.id=t.readUint16():s.id=t.readUint32();var o=t.readUint8();for(s.props=[],r=0;r<o;r++){var a=t.readUint8(),h={};s.props.push(h),h.essential=(a&128)>>7===1,this.flags&1?h.property_index=(a&127)<<8|t.readUint8():h.property_index=a&127}}});n.createFullBoxCtor("iref",function(t){var e,r,s;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=n.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===n.OK)this.version===0?s=new n.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):s=new n.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),s.write===n.Box.prototype.write&&s.type!=="mdat"&&(g.warn("BoxParser",s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.references.push(s);else return});n.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3});n.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()});n.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()});n.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var r=0;r<e;r++){var s={};this.levels[r]=s,s.track_ID=t.readUint32();var o=t.readUint8();switch(s.padding_flag=o>>7,s.assignment_type=o&127,s.assignment_type){case 0:s.grouping_type=t.readString(4);break;case 1:s.grouping_type=t.readString(4),s.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:s.sub_track_id=t.readUint32();break;default:g.warn("BoxParser","Unknown leva assignement type")}}});n.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()});n.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});n.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=t.readUint16(),this.display_primaries[0].y=t.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=t.readUint16(),this.display_primaries[1].y=t.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=t.readUint16(),this.display_primaries[2].y=t.readUint16(),this.white_point={},this.white_point.x=t.readUint16(),this.white_point.y=t.readUint16(),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()});n.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()});n.createFullBoxCtor("mehd",function(t){this.flags&1&&(g.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()});n.createFullBoxCtor("meta",function(t){this.boxes=[],n.ContainerBox.prototype.parse.call(this,t)});n.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()});n.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()});n.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()});n.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()});n.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()});n.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var r=0;r<Math.floor((e+1)/2);r++)this.padbits=t.readUint8()});n.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()});n.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)});n.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)});n.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var r=0;r<e;r++)this.rate[r]=t.readUint32(),this.initial_delay[r]=t.readUint32()});n.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()});n.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()});n.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()});n.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()});n.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()});n.createFullBoxCtor("pssh",function(t){if(this.system_id=n.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var r=0;r<e;r++)this.kid[r]=n.parseHex16(t)}var s=t.readUint32();s>0&&(this.data=t.readUint8Array(s))});n.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()});n.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()});n.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()});n.createContainerBoxCtor("tapt",null,["clef","prof","enof"]);n.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)});n.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var r=0;r<e;r++)this.version===0?this.offset[r]=t.readUint32():this.offset[r]=t.readUint64()});n.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var r=0;r<e;r++)this.sample_info_size[r]=t.readUint8()});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)});n.createSampleGroupCtor("alst",function(t){var e,r=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<r;e++)this.sample_offset[e]=t.readUint32();var s=this.description_length-4-4*r;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<s/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()});n.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()});n.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var r=t.readUint8(),s=0;s<r;s++){var o={};this.dependency.push(o),o.subSeqDirectionFlag=t.readUint8(),o.layerNumber=t.readUint8(),o.subSequenceIdentifier=t.readUint16()}});n.createSampleGroupCtor("dtrt",function(t){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("mvif",function(t){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()});n.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127});n.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)g.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}});n.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()});n.SampleGroupEntry.prototype.parse=function(t){g.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)};n.createSampleGroupCtor("scif",function(t){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("scnm",function(t){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=n.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))});n.createSampleGroupCtor("stsa",function(t){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63});n.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7});n.createSampleGroupCtor("tsas",function(t){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("tscl",function(t){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("vipr",function(t){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var s={};this.entries.push(s),s.sample_count=t.readInt32(),s.group_description_index=t.readInt32()}});n.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))});n.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)});n.createFullBoxCtor("sdtp",function(t){var e,r=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var s=0;s<r;s++)e=t.readUint8(),this.is_leading[s]=e>>6,this.sample_depends_on[s]=e>>4&3,this.sample_is_depended_on[s]=e>>2&3,this.sample_has_redundancy[s]=e&3});n.createFullBoxCtor("senc");n.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),g.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var s;n[this.grouping_type+"SampleGroupEntry"]?s=new n[this.grouping_type+"SampleGroupEntry"](this.grouping_type):s=new n.SampleGroupEntry(this.grouping_type),this.entries.push(s),this.version===1?this.default_length===0?s.description_length=t.readUint32():s.description_length=this.default_length:s.description_length=this.default_length,s.write===n.SampleGroupEntry.prototype.write&&(g.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),s.data=t.readUint8Array(s.description_length),t.position-=s.description_length),s.parse(t)}});n.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),r=0;r<e;r++){var s={};this.references.push(s);var o=t.readUint32();s.reference_type=o>>31&1,s.referenced_size=o&2147483647,s.subsegment_duration=t.readUint32(),o=t.readUint32(),s.starts_with_SAP=o>>31&1,s.SAP_type=o>>28&7,s.SAP_delta_time=o&268435455}});n.SingleItemTypeReferenceBox=function(t,e,r,s){n.Box.call(this,t,e),this.hdr_size=r,this.start=s};n.SingleItemTypeReferenceBox.prototype=new n.Box;n.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var r=0;r<e;r++)this.references[r]={},this.references[r].to_item_ID=t.readUint16()};n.SingleItemTypeReferenceBoxLarge=function(t,e,r,s){n.Box.call(this,t,e),this.hdr_size=r,this.start=s};n.SingleItemTypeReferenceBoxLarge.prototype=new n.Box;n.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var r=0;r<e;r++)this.references[r]={},this.references[r].to_item_ID=t.readUint32()};n.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()});n.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()});n.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),r=0;r<e;r++){var s={};this.subsegments.push(s),s.ranges=[];for(var o=t.readUint32(),a=0;a<o;a++){var h={};s.ranges.push(h),h.level=t.readUint8(),h.range_size=t.readUint24()}}});n.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var r=0;r<e;r++)this.chunk_offsets.push(t.readUint32())});n.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var r=0;r<e;r++)this.priority[r]=t.readUint16()});n.createFullBoxCtor("sthd");n.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var r=0;r<e;r++)this.attribute_list[r]=t.readUint32()});n.createFullBoxCtor("stsc",function(t){var e,r;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(r=0;r<e;r++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())});n.createFullBoxCtor("stsd",function(t){var e,r,s,o;for(this.entries=[],s=t.readUint32(),e=1;e<=s;e++)if(r=n.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),r.code===n.OK)n[r.type+"SampleEntry"]?(o=new n[r.type+"SampleEntry"](r.size),o.hdr_size=r.hdr_size,o.start=r.start):(g.warn("BoxParser","Unknown sample entry type: "+r.type),o=new n.SampleEntry(r.type,r.size,r.hdr_size,r.start)),o.write===n.SampleEntry.prototype.write&&(g.info("BoxParser","SampleEntry "+o.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),o.parseDataAndRewind(t)),o.parse(t),this.entries.push(o);else return});n.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var r=0;r<e;r++)this.group_description_index[r]=t.readUint32()});n.createFullBoxCtor("stsh",function(t){var e,r;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(r=0;r<e;r++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())});n.createFullBoxCtor("stss",function(t){var e,r;if(r=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<r;e++)this.sample_numbers.push(t.readUint32())});n.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size});n.createFullBoxCtor("stts",function(t){var e,r,s;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(r=0;r<e;r++)this.sample_counts.push(t.readUint32()),s=t.readInt32(),s<0&&(g.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)});n.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var r=t.readUint32();this.stereo_indication_type=t.readString(r);var s,o;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(s=n.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),s.code===n.OK)o=s.box,this.boxes.push(o),this[o.type]=o;else return});n.createBoxCtor("styp",function(t){n.ftypBox.prototype.parse.call(this,t)});n.createFullBoxCtor("stz2",function(t){var e,r,s;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),s=t.readUint32(),this.field_size===4)for(e=0;e<s;e+=2){var o=t.readUint8();this.sample_sizes[e]=o>>4&15,this.sample_sizes[e+1]=o&15}else if(this.field_size===8)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint16();else g.error("BoxParser","Error in length field in stz2 box")});n.createFullBoxCtor("subs",function(t){var e,r,s,o;for(s=t.readUint32(),this.entries=[],e=0;e<s;e++){var a={};if(this.entries[e]=a,a.sample_delta=t.readUint32(),a.subsamples=[],o=t.readUint16(),o>0)for(r=0;r<o;r++){var h={};a.subsamples.push(h),this.version==1?h.size=t.readUint32():h.size=t.readUint16(),h.priority=t.readUint8(),h.discardable=t.readUint8(),h.codec_specific_parameters=t.readUint32()}}});n.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=n.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))});n.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()});n.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&n.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&n.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&n.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&n.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&n.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0});n.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var r=t.readUint32(),s=0;s<r;s++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()});n.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()});n.createBoxCtor("tmax",function(t){this.time=t.readUint32()});n.createBoxCtor("tmin",function(t){this.time=t.readUint32()});n.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()});n.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()});n.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()});n.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()};n.createTrackGroupCtor("msrc");n.TrackReferenceTypeBox=function(t,e,r,s){n.Box.call(this,t,e),this.hdr_size=r,this.start=s};n.TrackReferenceTypeBox.prototype=new n.Box;n.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)};n.trefBox.prototype.parse=function(t){for(var e,r;t.getPosition()<this.start+this.size;)if(e=n.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===n.OK)r=new n.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),r.write===n.Box.prototype.write&&r.type!=="mdat"&&(g.info("BoxParser","TrackReference "+r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),this.boxes.push(r);else return};n.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=n.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===n.OK)box=ret.box,this.boxes.push(box);else return});n.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()});n.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()});n.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&n.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&n.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var r=0;r<this.sample_count;r++)this.flags&n.TRUN_FLAGS_DURATION&&(this.sample_duration[r]=t.readUint32()),this.flags&n.TRUN_FLAGS_SIZE&&(this.sample_size[r]=t.readUint32()),this.flags&n.TRUN_FLAGS_FLAGS&&(this.sample_flags[r]=t.readUint32()),this.flags&n.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[r]=t.readUint32():this.sample_composition_time_offset[r]=t.readInt32())});n.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var r=0;r<e;r++)this.attribute_list[r]=t.readUint32()});n.createFullBoxCtor("txtC",function(t){this.config=t.readCString()});n.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var r=0;r<e;r++)this.compatible_brands[r]=t.readString(4)});n.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()});n.createFullBoxCtor("uncC",function(t){var e;for(this.profile=t.readUint32(),this.component_count=t.readUint16(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var r=t.readUint8();this.component_little_endian=r>>7&1,this.block_pad_lsb=r>>6&1,this.block_little_endian=r>>5&1,this.block_reversed=r>>4&1,this.pad_unknown=r>>3&1,this.pixel_size=t.readUint8(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()});n.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())});n.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())});n.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")});n.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=n.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))});n.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1);n.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=n.parseHex16(t)});n.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var r={},s=0,o=0;this.version===1?(s=t.readUint64(),o=t.readUint64()):(s=t.readUint32(),o=t.readUint32()),r.absolute_time=s,r.absolute_duration=o,this.entries.push(r)}});n.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())});n.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)});n.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))});n.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)});n.createFullBoxCtor("vvcC",function(t){var e,r,s={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(y){this.held_bits=y.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(y){this.held_bits=y.readUint16(),this.num_held_bits=16},extract_bits:function(y){var x=this.held_bits>>this.num_held_bits-y&(1<<y)-1;return this.num_held_bits-=y,x}};if(s.stream_read_1_bytes(t),s.extract_bits(5),this.lengthSizeMinusOne=s.extract_bits(2),this.ptl_present_flag=s.extract_bits(1),this.ptl_present_flag){s.stream_read_2_bytes(t),this.ols_idx=s.extract_bits(9),this.num_sublayers=s.extract_bits(3),this.constant_frame_rate=s.extract_bits(2),this.chroma_format_idc=s.extract_bits(2),s.stream_read_1_bytes(t),this.bit_depth_minus8=s.extract_bits(3),s.extract_bits(5);{if(s.stream_read_2_bytes(t),s.extract_bits(2),this.num_bytes_constraint_info=s.extract_bits(6),this.general_profile_idc=s.extract_bits(7),this.general_tier_flag=s.extract_bits(1),this.general_level_idc=t.readUint8(),s.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=s.extract_bits(1),this.ptl_multilayer_enabled_flag=s.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var o=s.extract_bits(6);s.stream_read_1_bytes(t);var a=s.extract_bits(2);this.general_constraint_info[e]=o<<2|a}this.general_constraint_info[this.num_bytes_constraint_info-1]=s.extract_bits(6)}else s.extract_bits(6);if(this.num_sublayers>1){for(s.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,r=this.num_sublayers-2;r>=0;--r){var h=s.extract_bits(1);this.ptl_sublayer_present_mask|=h<<r}for(r=this.num_sublayers;r<=8&&this.num_sublayers>1;++r)s.extract_bits(1);for(this.sublayer_level_idc=[],r=this.num_sublayers-2;r>=0;--r)this.ptl_sublayer_present_mask&1<<r&&(this.sublayer_level_idc[r]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var d=12,p=13;this.nalu_arrays=[];var l=t.readUint8();for(e=0;e<l;e++){var f=[];this.nalu_arrays.push(f),s.stream_read_1_bytes(t),f.completeness=s.extract_bits(1),s.extract_bits(2),f.nalu_type=s.extract_bits(5);var c=1;for(f.nalu_type!=p&&f.nalu_type!=d&&(c=t.readUint16()),r=0;r<c;r++){var _=t.readUint16();f.push({data:t.readUint8Array(_),length:_})}}});n.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3});n.SampleEntry.prototype.isVideo=function(){return!1};n.SampleEntry.prototype.isAudio=function(){return!1};n.SampleEntry.prototype.isSubtitle=function(){return!1};n.SampleEntry.prototype.isMetadata=function(){return!1};n.SampleEntry.prototype.isHint=function(){return!1};n.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")};n.SampleEntry.prototype.getWidth=function(){return""};n.SampleEntry.prototype.getHeight=function(){return""};n.SampleEntry.prototype.getChannelCount=function(){return""};n.SampleEntry.prototype.getSampleRate=function(){return""};n.SampleEntry.prototype.getSampleSize=function(){return""};n.VisualSampleEntry.prototype.isVideo=function(){return!0};n.VisualSampleEntry.prototype.getWidth=function(){return this.width};n.VisualSampleEntry.prototype.getHeight=function(){return this.height};n.AudioSampleEntry.prototype.isAudio=function(){return!0};n.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count};n.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate};n.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize};n.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0};n.MetadataSampleEntry.prototype.isMetadata=function(){return!0};n.decimalToHex=function(t,e){var r=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;r.length<e;)r="0"+r;return r};n.avc1SampleEntry.prototype.getCodec=n.avc2SampleEntry.prototype.getCodec=n.avc3SampleEntry.prototype.getCodec=n.avc4SampleEntry.prototype.getCodec=function(){var t=n.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+n.decimalToHex(this.avcC.AVCProfileIndication)+n.decimalToHex(this.avcC.profile_compatibility)+n.decimalToHex(this.avcC.AVCLevelIndication):t};n.hev1SampleEntry.prototype.getCodec=n.hvc1SampleEntry.prototype.getCodec=function(){var t,e=n.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var r=this.hvcC.general_profile_compatibility,s=0;for(t=0;t<32&&(s|=r&1,t!=31);t++)s<<=1,r>>=1;e+=n.decimalToHex(s,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var o=!1,a="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||o)&&(a="."+n.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+a,o=!0);e+=a}return e};n.vvc1SampleEntry.prototype.getCodec=n.vvi1SampleEntry.prototype.getCodec=function(){var t,e=n.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var r="";if(this.vvcC.general_constraint_info){var s=[],o=0;o|=this.vvcC.ptl_frame_only_constraint<<7,o|=this.vvcC.ptl_multilayer_enabled<<6;var a;for(t=0;t<this.vvcC.general_constraint_info.length;++t)o|=this.vvcC.general_constraint_info[t]>>2&63,s.push(o),o&&(a=t),o=this.vvcC.general_constraint_info[t]>>2&3;if(a===void 0)r=".CA";else{r=".C";var h="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",d=0,p=0;for(t=0;t<=a;++t)for(d=d<<8|s[t],p+=8;p>=5;){var l=d>>p-5&31;r+=h[l],p-=5,d&=(1<<p)-1}p&&(d<<=5-p,r+=h[d&31])}}e+=r}return e};n.mp4aSampleEntry.prototype.getCodec=function(){var t=n.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),r=this.esds.esd.getAudioConfig();return t+"."+n.decimalToHex(e)+(r?"."+r:"")}else return t};n.stxtSampleEntry.prototype.getCodec=function(){var t=n.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t};n.vp08SampleEntry.prototype.getCodec=n.vp09SampleEntry.prototype.getCodec=function(){var t=n.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var r=this.vpcC.bitDepth;return r==8&&(r="08"),t+".0"+this.vpcC.profile+"."+e+"."+r};n.av01SampleEntry.prototype.getCodec=function(){var t=n.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var r;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?r=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(r=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+r};n.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>O&&(this.size+=8),this.type==="uuid"&&(this.size+=16),g.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>O?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>O&&t.writeUint64(this.size)};n.FullBox.prototype.writeHeader=function(t){this.size+=4,n.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)};n.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))};n.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};n.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)};n.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)};n.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])};n.cslgBox.prototype.write=function(t){var e;this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)};n.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])};n.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};n.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)};n.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var r=this.entries[e];t.writeUint32(r.segment_duration),t.writeInt32(r.media_time),t.writeInt16(r.media_rate_integer),t.writeInt16(r.media_rate_fraction)}};n.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)};n.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)};n.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)};n.hvcCBox.prototype.write=function(t){var e,r;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,r=0;r<this.nalu_arrays[e].length;r++)this.size+=2+this.nalu_arrays[e][r].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.general_profile_space<<6+this.general_tier_flag<<5+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),r=0;r<this.nalu_arrays[e].length;r++)t.writeUint16(this.nalu_arrays[e][r].data.length),t.writeUint8Array(this.nalu_arrays[e][r].data)};n.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)};n.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)};n.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)};n.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)};n.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)};n.SampleEntry.prototype.writeHeader=function(t){this.size=8,n.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)};n.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};n.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};n.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)};n.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)};n.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)};n.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)};n.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var r=this.entries[e];t.writeInt32(r.sample_count),t.writeInt32(r.group_description_index)}};n.sgpdBox.prototype.write=function(t){var e,r;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)r=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=r.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)r=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(r.description_length),r.write(t)};n.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var r=this.references[e];t.writeUint32(r.reference_type<<31|r.referenced_size),t.writeUint32(r.subsegment_duration),t.writeUint32(r.starts_with_SAP<<31|r.SAP_type<<28|r.SAP_delta_time)}};n.smhdBox.prototype.write=function(t){var e;this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)};n.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)};n.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])};n.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};n.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])};n.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)};n.stszBox.prototype.write=function(t){var e,r=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){r=!1;break}else e++;else r=!1;this.size=8,r||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),r?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),r||t.writeUint32Array(this.sample_sizes)};n.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])};n.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)};n.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&n.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&n.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&n.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&n.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&n.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&n.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&n.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&n.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&n.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&n.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)};n.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)};n.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)};n.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&n.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&n.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&n.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&n.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&n.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&n.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&n.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&n.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&n.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&n.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&n.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&n.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))};n["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)};n["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)};n.vmhdBox.prototype.write=function(t){var e;this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)};n.cttsBox.prototype.unpack=function(t){var e,r,s;for(s=0,e=0;e<this.sample_counts.length;e++)for(r=0;r<this.sample_counts[e];r++)t[s].pts=t[s].dts+this.sample_offsets[e],s++};n.sttsBox.prototype.unpack=function(t){var e,r,s;for(s=0,e=0;e<this.sample_counts.length;e++)for(r=0;r<this.sample_counts[e];r++)s===0?t[s].dts=0:t[s].dts=t[s-1].dts+this.sample_deltas[e],s++};n.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]};n.stscBox.prototype.unpack=function(t){var e,r,s,o,a;for(o=0,a=0,e=0;e<this.first_chunk.length;e++)for(r=0;r<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);r++)for(a++,s=0;s<this.samples_per_chunk[e];s++){if(t[o])t[o].description_index=this.sample_description_index[e],t[o].chunk_index=a;else return;o++}};n.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]};n.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"];n.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"];n.boxEqualFields=function(t,e){if(t&&!e)return!1;var r;for(r in t)if(!(n.DIFF_BOXES_PROP_NAMES.indexOf(r)>-1)){if(t[r]instanceof n.Box||e[r]instanceof n.Box)continue;if(typeof t[r]>"u"||typeof e[r]>"u")continue;if(typeof t[r]=="function"||typeof e[r]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(r.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(r.slice(0,4))>-1)continue;if(r==="data"||r==="start"||r==="size"||r==="creation_time"||r==="modification_time")continue;if(n.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(r)>-1)continue;if(t[r]!==e[r])return!1}return!0};n.boxEqual=function(t,e){if(!n.boxEqualFields(t,e))return!1;for(var r=0;r<n.DIFF_BOXES_PROP_NAMES.length;r++){var s=n.DIFF_BOXES_PROP_NAMES[r];if(t[s]&&e[s]&&!n.boxEqual(t[s],e[s]))return!1}return!0};var nt=function(){};nt.prototype.parseSample=function(t){var e,r,s=new b(t.buffer);for(e=[];!s.isEos();)r=n.parseOneBox(s,!1),r.code===n.OK&&r.box.type==="vttc"&&e.push(r.box);return e};nt.prototype.getText=function(t,e,r){function s(l,f,c){return c=c||"0",l=l+"",l.length>=f?l:new Array(f-l.length+1).join(c)+l}function o(l){var f=Math.floor(l/3600),c=Math.floor((l-f*3600)/60),_=Math.floor(l-f*3600-c*60),y=Math.floor((l-f*3600-c*60-_)*1e3);return""+s(f,2)+":"+s(c,2)+":"+s(_,2)+"."+s(y,3)}for(var a=this.parseSample(r),h="",d=0;d<a.length;d++){var p=a[d];h+=o(t)+" --> "+o(e)+`\r
`,h+=p.payl.text}return h};var ot=function(){};ot.prototype.parseSample=function(t){var e={},r;e.resources=[];var s=new b(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=s.readString(t.data.length);else if(e.documentString=s.readString(t.subsamples[0].size),t.subsamples.length>1)for(r=1;r<t.subsamples.length;r++)e.resources[r]=s.readUint8Array(t.subsamples[r].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var Z=function(){};Z.prototype.parseSample=function(t){var e,r=new b(t.data.buffer);return e=r.readString(t.data.length),e};Z.prototype.parseConfig=function(t){var e,r=new b(t.buffer);return r.readUint32(),e=r.readCString(),e};typeof B<"u"&&(B.XMLSubtitlein4Parser=ot,B.Textin4Parser=Z);var m=function(t){this.stream=t||new T,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};m.prototype.setSegmentOptions=function(t,e,r){var s=this.getTrackById(t);if(s){var o={};this.fragmentedTracks.push(o),o.id=t,o.user=e,o.trak=s,s.nextSample=0,o.segmentStream=null,o.nb_samples=1e3,o.rapAlignement=!0,r&&(r.nbSamples&&(o.nb_samples=r.nbSamples),r.rapAlignement&&(o.rapAlignement=r.rapAlignement))}};m.prototype.unsetSegmentOptions=function(t){for(var e=-1,r=0;r<this.fragmentedTracks.length;r++){var s=this.fragmentedTracks[r];s.id==t&&(e=r)}e>-1&&this.fragmentedTracks.splice(e,1)};m.prototype.setExtractionOptions=function(t,e,r){var s=this.getTrackById(t);if(s){var o={};this.extractedTracks.push(o),o.id=t,o.user=e,o.trak=s,s.nextSample=0,o.nb_samples=1e3,o.samples=[],r&&r.nbSamples&&(o.nb_samples=r.nbSamples)}};m.prototype.unsetExtractionOptions=function(t){for(var e=-1,r=0;r<this.extractedTracks.length;r++){var s=this.extractedTracks[r];s.id==t&&(e=r)}e>-1&&this.extractedTracks.splice(e,1)};m.prototype.parse=function(){var t,e,r,s=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),e=n.parseOneBox(this.stream,s),e.code===n.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(e))continue;return}else return;else{var o;switch(r=e.box,o=r.type!=="uuid"?r.type:r.uuid,this.boxes.push(r),o){case"mdat":this.mdats.push(r);break;case"moof":this.moofs.push(r);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[o]!==void 0&&g.warn("ISOFile","Duplicate Box of type: "+o+", overriding previous occurrence"),this[o]=r;break}this.updateUsedBytes&&this.updateUsedBytes(r,e)}};m.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(g.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(g.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(g.warn("ISOFile","Not ready to start parsing"),!1))};m.prototype.appendBuffer=function(t,e){var r;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(r=this.nextSeekPosition,this.nextSeekPosition=void 0):r=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(r=this.stream.getEndFilePositionAfter(r))):this.nextParsePosition?r=this.nextParsePosition:r=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(g.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+r),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),g.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),r};m.prototype.getInfo=function(){var t,e,r={},s,o,a,h,d=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(r.hasMoov=!0,r.duration=this.moov.mvhd.duration,r.timescale=this.moov.mvhd.timescale,r.isFragmented=this.moov.mvex!=null,r.isFragmented&&this.moov.mvex.mehd&&(r.fragment_duration=this.moov.mvex.mehd.fragment_duration),r.isProgressive=this.isProgressive,r.hasIOD=this.moov.iods!=null,r.brands=[],r.brands.push(this.ftyp.major_brand),r.brands=r.brands.concat(this.ftyp.compatible_brands),r.created=new Date(d+this.moov.mvhd.creation_time*1e3),r.modified=new Date(d+this.moov.mvhd.modification_time*1e3),r.tracks=[],r.audioTracks=[],r.videoTracks=[],r.subtitleTracks=[],r.metadataTracks=[],r.hintTracks=[],r.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(s=this.moov.traks[t],h=s.mdia.minf.stbl.stsd.entries[0],o={},r.tracks.push(o),o.id=s.tkhd.track_id,o.name=s.mdia.hdlr.name,o.references=[],s.tref)for(e=0;e<s.tref.boxes.length;e++)a={},o.references.push(a),a.type=s.tref.boxes[e].type,a.track_ids=s.tref.boxes[e].track_ids;s.edts&&(o.edits=s.edts.elst.entries),o.created=new Date(d+s.tkhd.creation_time*1e3),o.modified=new Date(d+s.tkhd.modification_time*1e3),o.movie_duration=s.tkhd.duration,o.movie_timescale=r.timescale,o.layer=s.tkhd.layer,o.alternate_group=s.tkhd.alternate_group,o.volume=s.tkhd.volume,o.matrix=s.tkhd.matrix,o.track_width=s.tkhd.width/65536,o.track_height=s.tkhd.height/65536,o.timescale=s.mdia.mdhd.timescale,o.cts_shift=s.mdia.minf.stbl.cslg,o.duration=s.mdia.mdhd.duration,o.samples_duration=s.samples_duration,o.codec=h.getCodec(),o.kind=s.udta&&s.udta.kinds.length?s.udta.kinds[0]:{schemeURI:"",value:""},o.language=s.mdia.elng?s.mdia.elng.extended_language:s.mdia.mdhd.languageString,o.nb_samples=s.samples.length,o.size=s.samples_size,o.bitrate=o.size*8*o.timescale/o.samples_duration,h.isAudio()?(o.type="audio",r.audioTracks.push(o),o.audio={},o.audio.sample_rate=h.getSampleRate(),o.audio.channel_count=h.getChannelCount(),o.audio.sample_size=h.getSampleSize()):h.isVideo()?(o.type="video",r.videoTracks.push(o),o.video={},o.video.width=h.getWidth(),o.video.height=h.getHeight()):h.isSubtitle()?(o.type="subtitles",r.subtitleTracks.push(o)):h.isHint()?(o.type="metadata",r.hintTracks.push(o)):h.isMetadata()?(o.type="metadata",r.metadataTracks.push(o)):(o.type="metadata",r.otherTracks.push(o))}else r.hasMoov=!1;if(r.mime="",r.hasMoov&&r.tracks){for(r.videoTracks&&r.videoTracks.length>0?r.mime+='video/mp4; codecs="':r.audioTracks&&r.audioTracks.length>0?r.mime+='audio/mp4; codecs="':r.mime+='application/mp4; codecs="',t=0;t<r.tracks.length;t++)t!==0&&(r.mime+=","),r.mime+=r.tracks[t].codec;r.mime+='"; profiles="',r.mime+=this.ftyp.compatible_brands.join(),r.mime+='"'}return r};m.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)};m.prototype.processSamples=function(t){var e,r;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var s=this.fragmentedTracks[e];for(r=s.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){g.debug("ISOFile","Creating media fragment on track #"+s.id+" for sample "+r.nextSample);var o=this.createFragment(s.id,r.nextSample,s.segmentStream);if(o)s.segmentStream=o,r.nextSample++;else break;if((r.nextSample%s.nb_samples===0||t||r.nextSample>=r.samples.length)&&(g.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,r.nextSample-s.nb_samples)+","+(r.nextSample-1)+"]"),g.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,r.nextSample,t||r.nextSample>=r.samples.length),s.segmentStream=null,s!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var a=this.extractedTracks[e];for(r=a.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){g.debug("ISOFile","Exporting on track #"+a.id+" sample #"+r.nextSample);var h=this.getSample(r,r.nextSample);if(h)r.nextSample++,a.samples.push(h);else{this.setNextSeekPositionFromSample(r.samples[r.nextSample]);break}if((r.nextSample%a.nb_samples===0||r.nextSample>=r.samples.length)&&(g.debug("ISOFile","Sending samples on track #"+a.id+" for sample "+r.nextSample),this.onSamples&&this.onSamples(a.id,a.user,a.samples),a.samples=[],a!==this.extractedTracks[e]))break}}}};m.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null};m.prototype.getBoxes=function(t,e){var r=[];return m._sweep.call(this,t,r,e),r};m._sweep=function(t,e,r){this.type&&this.type==t&&e.push(this);for(var s in this.boxes){if(e.length&&r)return;m._sweep.call(this.boxes[s],t,e,r)}};m.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples};m.prototype.getTrackSample=function(t,e){var r=this.getTrackById(t),s=this.getSample(r,e);return s};m.prototype.releaseUsedSamples=function(t,e){var r=0,s=this.getTrackById(t);s.lastValidSample||(s.lastValidSample=0);for(var o=s.lastValidSample;o<e;o++)r+=this.releaseSample(s,o);g.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+r+", remaining: "+this.samplesDataSize+")"),s.lastValidSample=e};m.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)};m.prototype.stop=function(){this.sampleProcessingStarted=!1};m.prototype.flush=function(){g.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)};m.prototype.seekTrack=function(t,e,r){var s,o,a=1/0,h=0,d=0,p;if(r.samples.length===0)return g.info("ISOFile","No sample in track, cannot seek! Using time "+g.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(s=0;s<r.samples.length;s++){if(o=r.samples[s],s===0)d=0,p=o.timescale;else if(o.cts>t*o.timescale){d=s-1;break}e&&o.is_sync&&(h=s)}for(e&&(d=h),t=r.samples[d].cts,r.nextSample=d;r.samples[d].alreadyRead===r.samples[d].size&&r.samples[d+1];)d++;return a=r.samples[d].offset+r.samples[d].alreadyRead,g.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+r.nextSample+" on track "+r.tkhd.track_id+", time "+g.getDurationString(t,p)+" and offset: "+a),{offset:a,time:t/p}};m.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0};m.prototype.seek=function(t,e){var r=this.moov,s,o,a,h={offset:1/0,time:1/0};if(this.moov){for(a=0;a<r.traks.length;a++)s=r.traks[a],!(t>this.getTrackDuration(s))&&(o=this.seekTrack(t,e,s),o.offset<h.offset&&(h.offset=o.offset),o.time<h.time&&(h.time=o.time));return g.info("ISOFile","Seeking at time "+g.getDurationString(h.time,1)+" needs a buffer with a fileStart position of "+h.offset),h.offset===1/0?h={offset:this.nextParsePosition,time:0}:h.offset=this.stream.getEndFilePositionAfter(h.offset),g.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+h.offset),h}else throw"Cannot seek: moov not received!"};m.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var r=this.boxes[e],s=t.boxes[e];if(!n.boxEqual(r,s))return!1;e++}return!0};typeof B<"u"&&(B.ISOFile=m);m.prototype.lastBoxStartPosition=0;m.prototype.parsingMdat=null;m.prototype.nextParsePosition=0;m.prototype.discardMdatData=!1;m.prototype.processIncompleteBox=function(t){var e,r,s;return t.type==="mdat"?(e=new n[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,s=this.stream.seek(e.start+e.size,!1,this.discardMdatData),s?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),r=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,r?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))};m.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null};m.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(g.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)};m.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)};m.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()};m.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))};m.prototype.add=n.Box.prototype.add;m.prototype.addBox=n.Box.prototype.addBox;m.prototype.init=function(t){var e=t||{},r=this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]),s=this.add("moov");return s.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),s.add("mvex"),this};m.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var r=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,r.add("tkhd").set("flags",n.TKHD_FLAG_ENABLED|n.TKHD_FLAG_IN_MOVIE|n.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width<<16).set("height",e.height<<16);var s=r.add("mdia");s.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),s.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),s.add("elng").set("extended_language",e.language||"fr-FR");var o=s.add("minf");if(n[e.type+"SampleEntry"]!==void 0){var a=new n[e.type+"SampleEntry"];a.data_reference_index=1;var h="";for(var d in n.sampleEntryCodes)for(var p=n.sampleEntryCodes[d],l=0;l<p.length;l++)if(p.indexOf(e.type)>-1){h=d;break}switch(h){case"Visual":if(o.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),a.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var f=new n.avcCBox;f.parse(new b(e.avcDecoderConfigRecord)),a.addBox(f)}else if(e.hevcDecoderConfigRecord){var c=new n.hvcCBox;c.parse(new b(e.hevcDecoderConfigRecord)),a.addBox(c)}break;case"Audio":o.add("smhd").set("balance",e.balance||0),a.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":o.add("hmhd");break;case"Subtitle":switch(o.add("sthd"),e.type){case"stpp":a.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":o.add("nmhd");break;case"System":o.add("nmhd");break;default:o.add("nmhd");break}e.description&&a.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(y){a.addBox(y)}),o.add("dinf").add("dref").addEntry(new n["url Box"]().set("flags",1));var _=o.add("stbl");return _.add("stsd").addEntry(a),_.add("stts").set("sample_counts",[]).set("sample_deltas",[]),_.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),_.add("stco").set("chunk_offsets",[]),_.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(r),e.id}};n.Box.prototype.computeSize=function(t){var e=t||new u;e.endianness=u.BIG_ENDIAN,this.write(e)};m.prototype.addSample=function(t,e,r){var s=r||{},o={},a=this.getTrackById(t);if(a!==null){o.number=a.samples.length,o.track_id=a.tkhd.track_id,o.timescale=a.mdia.mdhd.timescale,o.description_index=s.sample_description_index?s.sample_description_index-1:0,o.description=a.mdia.minf.stbl.stsd.entries[o.description_index],o.data=e,o.size=e.byteLength,o.alreadyRead=o.size,o.duration=s.duration||1,o.cts=s.cts||0,o.dts=s.dts||0,o.is_sync=s.is_sync||!1,o.is_leading=s.is_leading||0,o.depends_on=s.depends_on||0,o.is_depended_on=s.is_depended_on||0,o.has_redundancy=s.has_redundancy||0,o.degradation_priority=s.degradation_priority||0,o.offset=0,o.subsamples=s.subsamples,a.samples.push(o),a.samples_size+=o.size,a.samples_duration+=o.duration,a.first_dts===void 0&&(a.first_dts=s.dts),this.processSamples();var h=this.createSingleSampleMoof(o);return this.addBox(h),h.computeSize(),h.trafs[0].truns[0].data_offset=h.size+8,this.add("mdat").data=new Uint8Array(e),o}};m.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var r=new n.moofBox;r.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var s=r.add("traf"),o=this.getTrackById(t.track_id);return s.add("tfhd").set("track_id",t.track_id).set("flags",n.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),s.add("tfdt").set("baseMediaDecodeTime",t.dts-(o.first_dts||0)),s.add("trun").set("flags",n.TRUN_FLAGS_DATA_OFFSET|n.TRUN_FLAGS_DURATION|n.TRUN_FLAGS_SIZE|n.TRUN_FLAGS_FLAGS|n.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),r};m.prototype.lastMoofIndex=0;m.prototype.samplesDataSize=0;m.prototype.resetTables=function(){var t,e,r,s,o,a,h,d;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,r=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,r.chunk_offsets=[],s=e.mdia.minf.stbl.stsc,s.first_chunk=[],s.samples_per_chunk=[],s.sample_description_index=[],o=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,o.sample_sizes=[],a=e.mdia.minf.stbl.stts,a.sample_counts=[],a.sample_deltas=[],h=e.mdia.minf.stbl.ctts,h&&(h.sample_counts=[],h.sample_offsets=[]),d=e.mdia.minf.stbl.stss;var p=e.mdia.minf.stbl.boxes.indexOf(d);p!=-1&&(e.mdia.minf.stbl.boxes[p]=null)}};m.initSampleGroups=function(t,e,r,s,o){var a,h,d,p,l;function f(c,_,y){this.grouping_type=c,this.grouping_type_parameter=_,this.sbgp=y,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),h=0;h<r.length;h++){for(l=r[h].grouping_type+"/"+r[h].grouping_type_parameter,p=new f(r[h].grouping_type,r[h].grouping_type_parameter,r[h]),e&&(e.sample_groups_info[l]=p),t.sample_groups_info[l]||(t.sample_groups_info[l]=p),a=0;a<s.length;a++)s[a].grouping_type===r[h].grouping_type&&(p.description=s[a],p.description.used=!0);if(o)for(a=0;a<o.length;a++)o[a].grouping_type===r[h].grouping_type&&(p.fragment_description=o[a],p.fragment_description.used=!0,p.is_fragment=!0)}if(e){if(o)for(h=0;h<o.length;h++)!o[h].used&&o[h].version>=2&&(l=o[h].grouping_type+"/0",p=new f(o[h].grouping_type,0),p.is_fragment=!0,e.sample_groups_info[l]||(e.sample_groups_info[l]=p))}else for(h=0;h<s.length;h++)!s[h].used&&s[h].version>=2&&(l=s[h].grouping_type+"/0",p=new f(s[h].grouping_type,0),t.sample_groups_info[l]||(t.sample_groups_info[l]=p))};m.setSampleGroupProperties=function(t,e,r,s){var o,a;e.sample_groups=[];for(o in s)if(e.sample_groups[o]={},e.sample_groups[o].grouping_type=s[o].grouping_type,e.sample_groups[o].grouping_type_parameter=s[o].grouping_type_parameter,r>=s[o].last_sample_in_run&&(s[o].last_sample_in_run<0&&(s[o].last_sample_in_run=0),s[o].entry_index++,s[o].entry_index<=s[o].sbgp.entries.length-1&&(s[o].last_sample_in_run+=s[o].sbgp.entries[s[o].entry_index].sample_count)),s[o].entry_index<=s[o].sbgp.entries.length-1?e.sample_groups[o].group_description_index=s[o].sbgp.entries[s[o].entry_index].group_description_index:e.sample_groups[o].group_description_index=-1,e.sample_groups[o].group_description_index!==0){var h;s[o].fragment_description?h=s[o].fragment_description:h=s[o].description,e.sample_groups[o].group_description_index>0?(e.sample_groups[o].group_description_index>65535?a=(e.sample_groups[o].group_description_index>>16)-1:a=e.sample_groups[o].group_description_index-1,h&&a>=0&&(e.sample_groups[o].description=h.entries[a])):h&&h.version>=2&&h.default_group_description_index>0&&(e.sample_groups[o].description=h.entries[h.default_group_description_index-1])}};m.process_sdtp=function(t,e,r){e&&(t?(e.is_leading=t.is_leading[r],e.depends_on=t.sample_depends_on[r],e.is_depended_on=t.sample_is_depended_on[r],e.has_redundancy=t.sample_has_redundancy[r]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))};m.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)};m.prototype.buildTrakSampleLists=function(t){var e,r,s,o,a,h,d,p,l,f,c,_,y,x,v,U,E,w,A,z,F,P,L,M,I,k;if(t.samples=[],t.samples_duration=0,t.samples_size=0,s=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,o=t.mdia.minf.stbl.stsc,a=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,h=t.mdia.minf.stbl.stts,d=t.mdia.minf.stbl.ctts,p=t.mdia.minf.stbl.stss,l=t.mdia.minf.stbl.stsd,f=t.mdia.minf.stbl.subs,y=t.mdia.minf.stbl.stdp,c=t.mdia.minf.stbl.sbgps,_=t.mdia.minf.stbl.sgpds,A=-1,z=-1,F=-1,P=-1,L=0,I=0,k=0,m.initSampleGroups(t,null,c,_),!(typeof a>"u")){for(e=0;e<a.sample_sizes.length;e++){var S={};S.number=e,S.track_id=t.tkhd.track_id,S.timescale=t.mdia.mdhd.timescale,S.alreadyRead=0,t.samples[e]=S,S.size=a.sample_sizes[e],t.samples_size+=S.size,e===0?(v=1,x=0,S.chunk_index=v,S.chunk_run_index=x,w=o.samples_per_chunk[x],E=0,x+1<o.first_chunk.length?U=o.first_chunk[x+1]-1:U=1/0):e<w?(S.chunk_index=v,S.chunk_run_index=x):(v++,S.chunk_index=v,E=0,v<=U||(x++,x+1<o.first_chunk.length?U=o.first_chunk[x+1]-1:U=1/0),S.chunk_run_index=x,w+=o.samples_per_chunk[x]),S.description_index=o.sample_description_index[S.chunk_run_index]-1,S.description=l.entries[S.description_index],S.offset=s.chunk_offsets[S.chunk_index-1]+E,E+=S.size,e>A&&(z++,A<0&&(A=0),A+=h.sample_counts[z]),e>0?(t.samples[e-1].duration=h.sample_deltas[z],t.samples_duration+=t.samples[e-1].duration,S.dts=t.samples[e-1].dts+t.samples[e-1].duration):S.dts=0,d?(e>=F&&(P++,F<0&&(F=0),F+=d.sample_counts[P]),S.cts=t.samples[e].dts+d.sample_offsets[P]):S.cts=S.dts,p?(e==p.sample_numbers[L]-1?(S.is_sync=!0,L++):(S.is_sync=!1,S.degradation_priority=0),f&&f.entries[I].sample_delta+k==e+1&&(S.subsamples=f.entries[I].subsamples,k+=f.entries[I].sample_delta,I++)):S.is_sync=!0,m.process_sdtp(t.mdia.minf.stbl.sdtp,S,S.number),y?S.degradation_priority=y.priority[e]:S.degradation_priority=0,f&&f.entries[I].sample_delta+k==e&&(S.subsamples=f.entries[I].subsamples,k+=f.entries[I].sample_delta),(c.length>0||_.length>0)&&m.setSampleGroupProperties(t,S,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}};m.prototype.updateSampleLists=function(){var t,e,r,s,o,a,h,d,p,l,f,c,_,y,x;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(p=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,p.type=="moof")for(l=p,t=0;t<l.trafs.length;t++){for(f=l.trafs[t],c=this.getTrackById(f.tfhd.track_id),_=this.getTrexById(f.tfhd.track_id),f.tfhd.flags&n.TFHD_FLAG_SAMPLE_DESC?s=f.tfhd.default_sample_description_index:s=_?_.default_sample_description_index:1,f.tfhd.flags&n.TFHD_FLAG_SAMPLE_DUR?o=f.tfhd.default_sample_duration:o=_?_.default_sample_duration:0,f.tfhd.flags&n.TFHD_FLAG_SAMPLE_SIZE?a=f.tfhd.default_sample_size:a=_?_.default_sample_size:0,f.tfhd.flags&n.TFHD_FLAG_SAMPLE_FLAGS?h=f.tfhd.default_sample_flags:h=_?_.default_sample_flags:0,f.sample_number=0,f.sbgps.length>0&&m.initSampleGroups(c,f,f.sbgps,c.mdia.minf.stbl.sgpds,f.sgpds),e=0;e<f.truns.length;e++){var v=f.truns[e];for(r=0;r<v.sample_count;r++){y={},y.moof_number=this.lastMoofIndex,y.number_in_traf=f.sample_number,f.sample_number++,y.number=c.samples.length,f.first_sample_index=c.samples.length,c.samples.push(y),y.track_id=c.tkhd.track_id,y.timescale=c.mdia.mdhd.timescale,y.description_index=s-1,y.description=c.mdia.minf.stbl.stsd.entries[y.description_index],y.size=a,v.flags&n.TRUN_FLAGS_SIZE&&(y.size=v.sample_size[r]),c.samples_size+=y.size,y.duration=o,v.flags&n.TRUN_FLAGS_DURATION&&(y.duration=v.sample_duration[r]),c.samples_duration+=y.duration,c.first_traf_merged||r>0?y.dts=c.samples[c.samples.length-2].dts+c.samples[c.samples.length-2].duration:(f.tfdt?y.dts=f.tfdt.baseMediaDecodeTime:y.dts=0,c.first_traf_merged=!0),y.cts=y.dts,v.flags&n.TRUN_FLAGS_CTS_OFFSET&&(y.cts=y.dts+v.sample_composition_time_offset[r]),x=h,v.flags&n.TRUN_FLAGS_FLAGS?x=v.sample_flags[r]:r===0&&v.flags&n.TRUN_FLAGS_FIRST_FLAG&&(x=v.first_sample_flags),y.is_sync=!(x>>16&1),y.is_leading=x>>26&3,y.depends_on=x>>24&3,y.is_depended_on=x>>22&3,y.has_redundancy=x>>20&3,y.degradation_priority=x&65535;var U=!!(f.tfhd.flags&n.TFHD_FLAG_BASE_DATA_OFFSET),E=!!(f.tfhd.flags&n.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),w=!!(v.flags&n.TRUN_FLAGS_DATA_OFFSET),A=0;U?A=f.tfhd.base_data_offset:E||e===0?A=l.start:A=d,e===0&&r===0?w?y.offset=A+v.data_offset:y.offset=A:y.offset=d,d=y.offset+y.size,(f.sbgps.length>0||f.sgpds.length>0||c.mdia.minf.stbl.sbgps.length>0||c.mdia.minf.stbl.sgpds.length>0)&&m.setSampleGroupProperties(c,y,y.number_in_traf,f.sample_groups_info)}}if(f.subs){c.has_fragment_subsamples=!0;var z=f.first_sample_index;for(e=0;e<f.subs.entries.length;e++)z+=f.subs.entries[e].sample_delta,y=c.samples[z-1],y.subsamples=f.subs.entries[e].subsamples}}}};m.prototype.getSample=function(t,e){var r,s=t.samples[e];if(!this.moov)return null;if(!s.data)s.data=new Uint8Array(s.size),s.alreadyRead=0,this.samplesDataSize+=s.size,g.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+s.size+" (total: "+this.samplesDataSize+")");else if(s.alreadyRead==s.size)return s;for(;;){var o=this.stream.findPosition(!0,s.offset+s.alreadyRead,!1);if(o>-1){r=this.stream.buffers[o];var a=r.byteLength-(s.offset+s.alreadyRead-r.fileStart);if(s.size-s.alreadyRead<=a)return g.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-r.fileStart)+" read size: "+(s.size-s.alreadyRead)+" full size: "+s.size+")"),u.memcpy(s.data.buffer,s.alreadyRead,r,s.offset+s.alreadyRead-r.fileStart,s.size-s.alreadyRead),r.usedBytes+=s.size-s.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead=s.size,s;if(a===0)return null;g.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-r.fileStart)+" read size: "+a+" full size: "+s.size+")"),u.memcpy(s.data.buffer,s.alreadyRead,r,s.offset+s.alreadyRead-r.fileStart,a),s.alreadyRead+=a,r.usedBytes+=a,this.stream.logBufferLevel()}else return null}};m.prototype.releaseSample=function(t,e){var r=t.samples[e];return r.data?(this.samplesDataSize-=r.size,r.data=null,r.alreadyRead=0,r.size):0};m.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize};m.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var r=this.moov.traks[t];t>0&&(e+=","),e+=r.mdia.minf.stbl.stsd.entries[0].getCodec()}return e};m.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var r=this.moov.mvex.trexs[e];if(r.track_id==t)return r}return null};m.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var r=this.moov.traks[e];if(r.tkhd.track_id==t)return r}return null};m.prototype.items=[];m.prototype.itemsDataSize=0;m.prototype.flattenItemInfo=function(){var t=this.items,e,r,s,o=this.meta;if(o!=null&&o.hdlr!==void 0&&o.iinf!==void 0){for(e=0;e<o.iinf.item_infos.length;e++)s={},s.id=o.iinf.item_infos[e].item_ID,t[s.id]=s,s.ref_to=[],s.name=o.iinf.item_infos[e].item_name,o.iinf.item_infos[e].protection_index>0&&(s.protection=o.ipro.protections[o.iinf.item_infos[e].protection_index-1]),o.iinf.item_infos[e].item_type?s.type=o.iinf.item_infos[e].item_type:s.type="mime",s.content_type=o.iinf.item_infos[e].content_type,s.content_encoding=o.iinf.item_infos[e].content_encoding;if(o.iloc)for(e=0;e<o.iloc.items.length;e++){var a,h=o.iloc.items[e];switch(s=t[h.item_ID],h.data_reference_index!==0&&(g.warn("Item storage with reference to other files: not supported"),s.source=o.dinf.boxes[h.data_reference_index-1]),h.construction_method){case 0:break;case 1:g.warn("Item storage with construction_method : not supported");break;case 2:g.warn("Item storage with construction_method : not supported");break}for(s.extents=[],s.size=0,r=0;r<h.extents.length;r++)s.extents[r]={},s.extents[r].offset=h.extents[r].extent_offset+h.base_offset,s.extents[r].length=h.extents[r].extent_length,s.extents[r].alreadyRead=0,s.size+=s.extents[r].length}if(o.pitm&&(t[o.pitm.item_id].primary=!0),o.iref)for(e=0;e<o.iref.references.length;e++){var d=o.iref.references[e];for(r=0;r<d.references.length;r++)t[d.from_item_ID].ref_to.push({type:d.type,id:d.references[r]})}if(o.iprp)for(var p=0;p<o.iprp.ipmas.length;p++){var l=o.iprp.ipmas[p];for(e=0;e<l.associations.length;e++){var f=l.associations[e];for(s=t[f.id],s.properties===void 0&&(s.properties={},s.properties.boxes=[]),r=0;r<f.props.length;r++){var c=f.props[r];if(c.property_index>0&&c.property_index-1<o.iprp.ipco.boxes.length){var _=o.iprp.ipco.boxes[c.property_index-1];s.properties[_.type]=_,s.properties.boxes.push(_)}}}}}};m.prototype.getItem=function(t){var e,r;if(!this.meta)return null;if(r=this.items[t],!r.data&&r.size)r.data=new Uint8Array(r.size),r.alreadyRead=0,this.itemsDataSize+=r.size,g.debug("ISOFile","Allocating item #"+t+" of size "+r.size+" (total: "+this.itemsDataSize+")");else if(r.alreadyRead===r.size)return r;for(var s=0;s<r.extents.length;s++){var o=r.extents[s];if(o.alreadyRead!==o.length){var a=this.stream.findPosition(!0,o.offset+o.alreadyRead,!1);if(a>-1){e=this.stream.buffers[a];var h=e.byteLength-(o.offset+o.alreadyRead-e.fileStart);if(o.length-o.alreadyRead<=h)g.debug("ISOFile","Getting item #"+t+" extent #"+s+" data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-e.fileStart)+" read size: "+(o.length-o.alreadyRead)+" full extent size: "+o.length+" full item size: "+r.size+")"),u.memcpy(r.data.buffer,r.alreadyRead,e,o.offset+o.alreadyRead-e.fileStart,o.length-o.alreadyRead),e.usedBytes+=o.length-o.alreadyRead,this.stream.logBufferLevel(),r.alreadyRead+=o.length-o.alreadyRead,o.alreadyRead=o.length;else return g.debug("ISOFile","Getting item #"+t+" extent #"+s+" partial data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-e.fileStart)+" read size: "+h+" full extent size: "+o.length+" full item size: "+r.size+")"),u.memcpy(r.data.buffer,r.alreadyRead,e,o.offset+o.alreadyRead-e.fileStart,h),o.alreadyRead+=h,r.alreadyRead+=h,e.usedBytes+=h,this.stream.logBufferLevel(),null}else return null}}return r.alreadyRead===r.size?r:null};m.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var r=0;r<e.extents.length;r++){var s=e.extents[r];s.alreadyRead=0}return e.size}else return 0};m.prototype.processItems=function(t){for(var e in this.items){var r=this.items[e];this.getItem(r.id),t&&!r.sent&&(t(r),r.sent=!0,r.data=null)}};m.prototype.hasItem=function(t){for(var e in this.items){var r=this.items[e];if(r.name===t)return r.id}return-1};m.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null};m.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)};m.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},r=null;if(e.itemId?r=this.getItem(e.itemId):r=this.getPrimaryItem(),r==null)return null;var s=new m;s.discardMdatData=!1;var o={type:r.type,description_boxes:r.properties.boxes};r.properties.ispe&&(o.width=r.properties.ispe.image_width,o.height=r.properties.ispe.image_height);var a=s.addTrack(o);return a?(s.addSample(a,r.data),s):null};m.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)};m.prototype.createFragment=function(t,e,r){var s=this.getTrackById(t),o=this.getSample(s,e);if(o==null)return this.setNextSeekPositionFromSample(s.samples[e]),null;var a=r||new u;a.endianness=u.BIG_ENDIAN;var h=this.createSingleSampleMoof(o);h.write(a),h.trafs[0].truns[0].data_offset=h.size+8,g.debug("MP4Box","Adjusting data_offset with new value "+h.trafs[0].truns[0].data_offset),a.adjustUint32(h.trafs[0].truns[0].data_offset_position,h.trafs[0].truns[0].data_offset);var d=new n.mdatBox;return d.data=o.data,d.write(a),a};m.writeInitializationSegment=function(t,e,r,s){var o,a,h,d,p;g.debug("ISOFile","Generating initialization segment");var l=new u;l.endianness=u.BIG_ENDIAN,t.write(l);var f=e.add("mvex");for(r&&f.add("mehd").set("fragment_duration",r),o=0;o<e.traks.length;o++)f.add("trex").set("track_id",e.traks[o].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",s).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(l),l.buffer};m.prototype.save=function(t){var e=new u;e.endianness=u.BIG_ENDIAN,this.write(e),e.save(t)};m.prototype.getBuffer=function(){var t=new u;return t.endianness=u.BIG_ENDIAN,this.write(t),t.buffer};m.prototype.initializeSegmentation=function(){var t,e,r,s,o,a;for(this.onSegment===null&&g.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),s=[],t=0;t<this.fragmentedTracks.length;t++){var h=new n.moovBox;h.mvhd=this.moov.mvhd,h.boxes.push(h.mvhd),o=this.getTrackById(this.fragmentedTracks[t].id),h.boxes.push(o),h.traks.push(o),a={},a.id=o.tkhd.track_id,a.user=this.fragmentedTracks[t].user,a.buffer=m.writeInitializationSegment(this.ftyp,h,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),s.push(a)}return s};n.Box.prototype.printHeader=function(t){this.size+=8,this.size>O&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)};n.FullBox.prototype.printHeader=function(t){this.size+=4,n.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)};n.Box.prototype.print=function(t){this.printHeader(t)};n.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var r=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=r}};m.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)};n.mvhdBox.prototype.print=function(t){n.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)};n.tkhdBox.prototype.print=function(t){n.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var at={};at.createFile=function(t,e){var r=t!==void 0?t:!0,s=new m(e);return s.discardMdatData=!r,s};typeof B<"u"&&(B.createFile=at.createFile)});var Y=st(Q());function It(t,e,r){function s(L,M,I,k,S,R){let N=1-S,C=1-R;return L*N*C+M*S*C+I*N*R+k*S*R}let o,a,h,d,p,l,f,c,_,y,x,v,U,E,w,A,z,F,P;for(o=0;o<e.height;++o)for(h=o/r,d=Math.floor(h),p=Math.ceil(h)>t.height-1?t.height-1:Math.ceil(h),a=0;a<e.width;++a)l=a/r,f=Math.floor(l),c=Math.ceil(l)>t.width-1?t.width-1:Math.ceil(l),_=(a+e.width*o)*4,y=(f+t.width*d)*4,x=(c+t.width*d)*4,v=(f+t.width*p)*4,U=(c+t.width*p)*4,E=l-f,w=h-d,A=s(t.data[y],t.data[x],t.data[v],t.data[U],E,w),e.data[_]=A,z=s(t.data[y+1],t.data[x+1],t.data[v+1],t.data[U+1],E,w),e.data[_+1]=z,F=s(t.data[y+2],t.data[x+2],t.data[v+2],t.data[U+2],E,w),e.data[_+2]=F,P=s(t.data[y+3],t.data[x+3],t.data[v+3],t.data[U+3],E,w),e.data[_+3]=P}var q;function J(t,e,r){return Math.min(Math.floor(t*e),r.maxHeight)}function dt(t,e){let r=e.width/e.height,s=Math.min(e.width,t.maxWidth,r*t.maxHeight);return t.maxSize&&t.maxSize>0&&t.maxSize<e.width*e.height/1e3&&(s=Math.min(s,Math.floor(t.maxSize*1e3/e.height))),t.scaleRatio&&(s=Math.min(s,Math.floor(t.scaleRatio*e.width))),t.debug&&(console.log("browser-image-resizer: original image size = "+e.width+" px (width) X "+e.height+" px (height)"),console.log("browser-image-resizer: scaled image size = "+s+" px (width) X "+J(e.height,s/e.width,t)+" px (height)")),s<=0&&(s=1,console.warn("browser-image-resizer: image size is too small")),s}function $(t,e){let r=t?.getContext("2d")?.getImageData(0,0,t.width,t.height),s=e?.getContext("2d")?.createImageData(e.width,e.height);if(!r||!s)throw Error("Canvas is empty (scaleCanvasWithAlgorithm). You should run this script after the document is ready.");return{srcImgData:r,destImgData:s}}function ht(){q||(q=new kt)}async function Ct(t,e){let r=e.outputWidth/t.width,s=new OffscreenCanvas(Math.floor(e.outputWidth),J(t.height,r,e));switch(e.argorithm){case"hermite":{ht(),await q.resampleAuto(t,s,e);break}case"hermite_single":{let{srcImgData:o,destImgData:a}=$(t,s);ht(),q.resampleSingle(o,a,e),s?.getContext("2d")?.putImageData(a,0,0);break}case"bilinear":{let{srcImgData:o,destImgData:a}=$(t,s);It(o,a,r),s?.getContext("2d")?.putImageData(a,0,0);break}default:{s.getContext("2d")?.drawImage(t,0,0,s.width,s.height);break}}return s}function Ft(t){let e=new OffscreenCanvas(t.width/2,t.height/2);return e?.getContext("2d")?.drawImage(t,0,0,e.width,e.height),e}async function Pt({img:t,config:e}){e.debug&&console.log("browser-image-resizer: Scale: Started",t);let r;if(t instanceof OffscreenCanvas)r=t;else{let a=await createImageBitmap(t);r=new OffscreenCanvas(a.width,a.height),r.getContext("2d")?.drawImage(a,0,0)}if(!r?.getContext("2d"))throw Error("browser-image-resizer: Canvas Context is empty.");let s=dt(e,r);if(!s)throw Error(`browser-image-resizer: maxWidth is ${s}!!`);for(e.debug&&console.log(`browser-image-resizer: scale: maxWidth is ${s}`);e.processByHalf&&r.width>=2*s;)e.debug&&console.log(`browser-image-resizer: scale: Scaling canvas by half from ${r.width}`),r=Ft(r);return r.width>s&&(e.debug&&console.log(`browser-image-resizer: scale: Scaling canvas by ${e.argorithm} from ${r.width} to ${s}`),r=await Ct(r,Object.assign(e,{outputWidth:s}))),e.mimeType===null?r:await r.convertToBlob({type:e.mimeType,quality:e.quality})}var kt=class{constructor(){this.workersArchive=[],this.cores=Math.min(navigator.hardwareConcurrency||4,4),this.workerBlobURL=globalThis.URL.createObjectURL(new Blob(["(",function(){onmessage=function(t){t.data.debug&&(console.log("browser-image-resizer: hermite worker: start",t.data.core,t.data),console.time("work"));let e=t.data.core,r=t.data.srcWidth,s=t.data.srcHeight,o=t.data.destWidth,a=t.data.destHeight,h=r/o,d=s/a,p=Math.ceil(h/2),l=Math.ceil(d/2),f=new Uint8ClampedArray(t.data.source),c=o*a*4,_=new ArrayBuffer(c),y=new Uint8ClampedArray(_,0,c);for(let v=0;v<a;v++)for(let U=0;U<o;U++){let E=(U+v*o)*4,w=0,A=0,z=0,F=0,P=0,L=0,M=0,I=v*d,k=Math.floor(U*h),S=Math.min(Math.ceil((U+1)*h),r),R=Math.floor(v*d),N=Math.min(Math.ceil((v+1)*d),s);for(let C=R;C<N;C++){let D=Math.abs(I-C)/l,St=U*h,Ut=D*D;for(let j=k;j<S;j++){let it=Math.abs(St-j)/p,G=Math.sqrt(Ut+it*it);if(G>=1)continue;w=2*G*G*G-3*G*G+1;let H=4*(j+C*r);M+=w*f[H+3],z+=w,f[H+3]<255&&(w=w*f[H+3]/250),F+=w*f[H],P+=w*f[H+1],L+=w*f[H+2],A+=w}}y[E]=F/A,y[E+1]=P/A,y[E+2]=L/A,y[E+3]=M/z}let x={core:e,target:y};globalThis.postMessage(x,[y.buffer]),t.data.debug&&(console.timeEnd("work"),console.log("browser-image-resizer: Worker: end",t.data.core))}}.toString(),")()"],{type:"application/javascript"}))}resampleAuto(t,e,r){if(globalThis.Worker&&this.cores>1&&r?.argorithm!=="hermite_single")return this.resample(t,e,r);{let{srcImgData:s,destImgData:o}=$(t,e);this.resampleSingle(s,o,r),e.getContext("2d").putImageData(o,0,0);return}}async resample(t,e,r){return new Promise((s,o)=>{r.debug&&console.time("hermite_multi");let a=t.height/e.height;if(this.workersArchive.length>0)for(let _=0;_<this.cores;_++)this.workersArchive[_]!=null&&(this.workersArchive[_].terminate(),delete this.workersArchive[_]);this.workersArchive=new Array(this.cores);let h=t.getContext("2d");if(!h)return o("Canvas is empty (resample)");r.debug&&(console.log("browser-image-resizer: hermite_multi: ",this.cores,"cores"),console.log("browser-image-resizer: source size: ",t.width,t.height,"ratio_h: ",a),console.log("browser-image-resizer: target size: ",e.width,e.height));let d=[],p=Math.ceil(t.height/this.cores/2)*2,l=-1;for(let _=0;_<this.cores;_++){let y=l+1;if(y>=t.height)continue;l=Math.min(y+p-1,t.height-1);let x=Math.min(p,t.height-y);r.debug&&console.log("browser-image-resizer: source split: ","#"+_,y,l,"height: "+x),d.push({source:h.getImageData(0,y,t.width,p),startY:Math.ceil(y/a),height:x})}let f=e.getContext("2d");if(!f)return o("Canvas is empty (resample dest)");let c=d.length;for(let _=0;_<d.length;_++){let y=new Worker(this.workerBlobURL);this.workersArchive[_]=y,y.onmessage=v=>{c--;let U=v.data.core,E=Math.ceil(d[U].height/a),w=f.createImageData(e.width,E);w.data.set(v.data.target),f.putImageData(w,0,d[U].startY),c<=0&&(s(),r.debug&&console.timeEnd("hermite_multi")),this.workersArchive[U].terminate(),delete this.workersArchive[U]},y.onerror=v=>o(v);let x={srcWidth:t.width,srcHeight:d[_].height,destWidth:e.width,destHeight:Math.ceil(d[_].height/a),core:_,source:d[_].source.data.buffer,debug:r.debug};y.postMessage(x,[x.source])}})}resampleSingle(t,e,r){let s=t.width/e.width,o=t.height/e.height,a=Math.ceil(s/2),h=Math.ceil(o/2),d=t.data,p=e.data;r.debug&&(console.log("browser-image-resizer: source size: ",t.width,t.height,"ratio_h: ",o),console.log("browser-image-resizer: target size: ",e.width,e.height),console.time("hermite_single"));for(let l=0;l<e.height;l++)for(let f=0;f<e.width;f++){let c=(f+l*e.width)*4,_=0,y=0,x=0,v=0,U=0,E=0,w=0,A=l*o,z=Math.floor(f*s),F=Math.min(Math.ceil((f+1)*s),t.width),P=Math.floor(l*o),L=Math.min(Math.ceil((l+1)*o),t.height);for(let M=P;M<L;M++){let I=Math.abs(A-M)/h,k=f*s,S=I*I;for(let R=z;R<F;R++){let N=Math.abs(k-R)/a,C=Math.sqrt(S+N*N);if(C>=1)continue;_=2*C*C*C-3*C*C+1;let D=4*(R+M*t.width);w+=_*d[D+3],x+=_,d[D+3]<255&&(_=_*d[D+3]/250),v+=_*d[D],U+=_*d[D+1],E+=_*d[D+2],y+=_}}p[c]=v/y,p[c+1]=U/y,p[c+2]=E/y,p[c+3]=w/x}r.debug&&console.timeEnd("hermite_single")}};var lt={argorithm:"null",processByHalf:!0,quality:.5,maxWidth:800,maxHeight:600,debug:!1,mimeType:"image/jpeg"};async function ft(t,e){let r=Object.assign({},lt,e);return Pt({img:t,config:r})}function pt(t,e){let r=Object.assign({},lt,e),s=dt(r,t),o=J(t.height,s/t.width,r);return{width:Math.floor(s),height:o}}var Lt=32,Mt=16,ut=(t=!1)=>new TransformStream({start(){},transform(e,r){r.enqueue(new EncodedVideoChunk({type:e.is_sync?"key":"delta",timestamp:1e6*e.cts/e.timescale,duration:1e6*e.duration/e.timescale,data:e.data}))},flush(e){t&&console.log("sample: [terminate] sample flush"),e.terminate()}});async function ct(t,e,r=!1){let s=0,o=0,a=t.nb_samples,h,d=null,p=()=>{r&&console.log("decode: emit resolve",d),d&&(d(),d=null)},l=()=>s<=o+Lt;return new TransformStream({start(f){h=new VideoDecoder({output:c=>{c&&(o++,r&&console.log("decode: enqueue frame",c.timestamp,o,a),f.enqueue(c)),l()&&p(),a===o&&(r&&console.log("decode: enqueue frame: [terminate] last frame",a,o),f.terminate())},error:c=>{console.error("decode: decoder error",c),f.error(c)}}),h.configure({codec:t.codec.startsWith("vp08")?"vp8":t.codec,codedHeight:t.track_height,codedWidth:t.track_width,hardwareAcceleration:"prefer-hardware",description:e})},transform(f,c){return s++,h.decode(f),r&&console.log("decode: recieving vchunk",s,o,h.decodeQueueSize),p(),a===s?(r&&console.log("decode: recieving vchunk: last chunk",a,s),h.flush(),Promise.resolve()):l()?(r&&console.log("decode: recieving vchunk: resolve immediate"),Promise.resolve()):(r&&console.log("decode: recieving vchunk: wait for allowWrite"),new Promise(_=>{d=_}))},flush(f){return r&&console.log("decode: [terminate] vchunk flush"),f.terminate(),h.flush()}},{highWaterMark:Mt})}var V=st(Q()),Rt=16,tt=(t,e=!1)=>{let r=0,s,o={track:void 0,tracks:void 0,totalSamples:0,processedSample:0,interval:0,resolve:null},a=()=>{e&&console.log("demux: clearInterval",o.interval),o.interval&&(globalThis.clearInterval(o.interval),o.interval=0)};return new TransformStream({start(h){s=(0,V.createFile)(),s.onError=d=>{h.error(d),console.error("demux: mp4box error",d),s.flush(),a()},s.onReady=d=>{s.setExtractionOptions(t,null,{nbSamples:1}),o.tracks=new Set(d.tracks.map(l=>l.id));let p=d.tracks.find(l=>l.id===t);if(!p){h.error("No track found");return}o.totalSamples=p.nb_samples,e&&console.log("demux: onReady",d,o.totalSamples),s.start()},s.onSamples=(d,p,l)=>{if(!(!l||l.length===0)){e&&console.log("demux: onSamples: desiredSize",h.desiredSize);for(let f of l)h.enqueue(f),o.processedSample=f.number+1,e&&console.log("demux: onSamples: sample",f.track_id,f.number,o.totalSamples,f.cts,f.duration,f.timescale,f.is_sync,f),o.processedSample===o.totalSamples&&(e&&console.log("demux: onSamples: [terminate] last sample",f.number),h.terminate(),s.flush(),a())}},o.interval=globalThis.setInterval(()=>{o.resolve&&(h.desiredSize??0)>=0&&(e&&console.log("demux: recieving chunk resolve!!"),o.resolve(),o.resolve=null)},1)},transform(h,d){if(h){let p=h.buffer;if(p.fileStart=r,s.appendBuffer(p),r+=h.byteLength,e&&console.log("demux: recieving chunk",h.byteLength,r,d.desiredSize),o.processedSample>100){let l=Math.min(d.desiredSize??0,0),f=Rt*5,c=Math.max(o.processedSample+l-f,0);e&&console.log("demux: recieving chunk: release used samples",t,c,o.processedSample,l,f),s.releaseUsedSamples(t,c)}for(let l of o.tracks??[]){let f=s.getTrackSamplesInfo(l).length;l!==t&&f&&s.releaseUsedSamples(l,f)}}if(o.totalSamples!==0)return new Promise(p=>{o.resolve&&o.resolve(),o.resolve=p})},flush(h){e&&console.log("demux: [terminate] file flush"),a(),h.terminate()}},{highWaterMark:1})};function Dt(t){let e=t.avcC||t.hvcC||t.vpcC||t.av1C;if(e){let r=new V.DataStream(void 0,0,V.DataStream.BIG_ENDIAN);return e.write(r),new Uint8Array(r.buffer,8)}throw new Error("avcC, hvcC, vpcC, or av1C box not found")}function _t(t,e=!1){let r={};return new Promise((s,o)=>{let a=(0,V.createFile)();r.file=a;let h=t.stream().getReader(),d=0;async function p(){let{done:l,value:f}=await h.read();if(!l){if(f){let c=f.buffer;c.fileStart=d,a.appendBuffer(c),d+=f.byteLength}return p()}}a.onError=l=>{o(l),a.flush(),h.cancel()},a.onReady=l=>{if(l.videoTracks.length===0)return o("No video track found");r.info=l,r.videoInfo=l.videoTracks[0],r.fps=r.videoInfo.duration?r.videoInfo.timescale*r.videoInfo.nb_samples/r.videoInfo.duration:30;let f=a.getTrackById(r.videoInfo.id);if(!f)return o("No video track found");for(let c of f.mdia.minf.stbl.stsd.entries)try{r.description=Dt(c)}catch(_){e&&console.error("getMP4Info: getDescriptionBuffer error",_)}if(!r.description)return o("No description found");l.audioTracks.length>0&&(r.audioInfo=l.audioTracks[0]),s(r),a.flush(),h.cancel()},p()})}var Ot=[0,-1,1,-2,2];function gt(t,e,r=!1){let s=0,o=new Map,a=0,h=0,d=t.nb_samples;function p(l,f,c){r&&console.log("sort: send: trying to send",s,f,o.keys());let _=c??new Set;o.set(f.timestamp,f);for(let y of Ot){let x=s+y;if(f?.timestamp===x){_.add(f),o.delete(f.timestamp),s=x+(f.duration??0);break}if(o.size&&o.has(x)){let v=o.get(x);if(_.add(v),o.delete(x),v?.duration){s=x+v.duration,p(l,v,_);return}}}if(_.size>0){r&&console.log("sort: send: enqueue buffer",_,_.size);for(let y of _)l.enqueue(y),o.delete(y.timestamp),h++,r&&console.log("sort: send: enqueue buffer: sending frame",y.timestamp,a,h,o.size);return}else r&&console.log("sort: send: no frame to enqueue")}return new TransformStream({start(){},transform(l,f){if(a++,r&&console.log("sort: recieving frame",l.timestamp,a,h,o.size),l.timestamp<s){console.error("sort: recieving frame: drop frame",l.timestamp,s),e.nbSamples--,l.close();return}if(a===d){r&&console.log("sort: recieving frame: last frame",l.timestamp,o);for(let c of Array.from(o.keys()).filter(_=>_>=s).sort((_,y)=>_-y))r&&console.log("sort: recieving frame: enqueue cache",c),f.enqueue(o.get(c)),o.delete(c);l.timestamp>=s?(r&&console.log("sort: recieving frame: enqueue last frame",l.timestamp),f.enqueue(l)):r&&console.error("sort: recieving frame: drop last frame",l.timestamp,s),r&&console.log("sort: recieving frame: [terminate]",d,e.nbSamples),f.terminate();return}if(o.size>=14){console.error("sort: recieving frame: cache is too large",l.timestamp,s,Array.from(o.keys()));for(let c of o.keys())c<s&&(o.get(c)?.close(),o.delete(c),e.nbSamples--);s=Math.min(...o.keys()),r&&console.log("sort: recieving frame: cache is too large (cache and expectedNextTimestamp fixed)",Array.from(o.keys()),s)}p(f,l)},flush(l){r&&console.log("sort: [terminate] frame flush"),l.terminate()}})}function et(t,e){return Math.floor(t/e)*e}function yt(t,e=!1){let r=0;return new TransformStream({start(){},async transform(s,o){r++,e&&(performance.mark("resize start"),console.log("resize: recieved",r,s));let a=await ft(s,{...t,mimeType:null});s.close();let h=new VideoFrame(a,{timestamp:s.timestamp});e&&(performance.mark("resize end"),console.log("resize: transform",r,performance.measure("resize","resize start").duration,h)),o.enqueue(h)},flush(s){e&&console.log("resize: [terminate] videoframe flush"),s.terminate()}})}var Nt=32;function mt(t,e,r=!1){let s,o=0,a=0,h=null,d=()=>{r&&console.log("encode: emit resolve",h),h&&(h(),h=null)},p=()=>o<=a+Nt;return new TransformStream({start(l){s=new VideoEncoder({output:(f,c)=>{a++,c&&Object.keys(c).length&&(l.enqueue({type:"metadata",data:c}),r&&console.log("encode: encoded: metadata",c)),l.enqueue({type:"encodedVideoChunk",data:f}),r&&console.log("encode: encoded",o,f,s.encodeQueueSize,c),a===e.nbSamples&&(r&&console.log("encode: encoded: [terminate] done",o,e.nbSamples),s.flush(),l.terminate()),p()&&d()},error:f=>{console.error("encoder error",f),l.error(f)}}),s.configure(t)},transform(l,f){return o++,r&&console.log("encode: frame",o,l,s.encodeQueueSize),s.encode(l),l.close(),d(),p()?(r&&console.log("encode: recieving vchunk: resolve immediate"),Promise.resolve()):(r&&console.log("encode: recieving vchunk: wait for allowWrite"),new Promise(c=>{h=c}))},flush(l){r&&console.log("encode: [terminate] flush",o,a),s.flush(),l.terminate()}})}function vt(t,e,r,s=!1){let o,a,h=0,d,p,l=r.timescale||9e4,f=l/r.timescale;return new WritableStream({start(){},write(c){if(c.type==="metadata"&&!a){let _=Math.round(r.duration*f);o=t.addTrack({name:"VideoHandle",timescale:l,duration:_,media_duration:_,language:r.language,width:e.width,height:e.height,...e.codec.startsWith("avc")?{avcDecoderConfigRecord:c.data.decoderConfig?.description}:e.codec.startsWith("hevc")?{hevcDecoderConfigRecord:c.data.decoderConfig?.description}:{}}),a=t.getTrackById(o),a.tkhd&&a.tkhd.set("matrix",r.matrix),s&&console.log("write: addTrack",o,a,l,f);return}else{if(h++,!d){d=c.data;return}p=c.data;let _=new ArrayBuffer(d.byteLength);d.copyTo(_);let y=t.addSample(o,_,{cts:Math.round(d.timestamp*l/1e6),dts:Math.round(d.timestamp*l/1e6),duration:Math.round((p.timestamp-d.timestamp)*l/1e6),is_sync:d.type==="key"});d=p,p=null,s&&console.log("write: addSample",h-1,y)}},close(){let c=new ArrayBuffer(d.byteLength);d.copyTo(c);let _=t.addSample(o,c,{cts:Math.round(d.timestamp*l/1e6),dts:Math.round(d.timestamp*l/1e6),duration:Math.round((r.duration/r.timescale*1e6-d.timestamp)*l/1e6)});s&&console.log("write: addSample last",h,_),t.setSegmentOptions(o,null,{nbSamples:h}),s&&console.log("write: close",t)}})}function xt(t,e,r=!1){let s=t.addTrack({type:e.codec.split(".")[0],hdlr:"soun",name:"SoundHandle",timescale:e.timescale,duration:e.duration,media_duration:e.duration,language:e.language,width:0,height:0,channel_count:e.audio.channel_count,samplerate:e.audio.sample_rate,samplesize:e.audio.sample_size});r&&console.log("write audio: addTrack",s);let o=0;return new WritableStream({start(){},write(a){o++;let h=t.addSample(s,a.data,{duration:a.duration,cts:a.cts,dts:a.dts,is_sync:a.is_sync,is_leading:a.is_leading,depends_on:a.depends_on,is_depended_on:a.is_depended_on,has_redundancy:a.has_redundancy,degradation_priority:a.degradation_priority,subsamples:a.subsamples});r&&console.log("write audio: addSample",o,a,h)},close(){t.setSegmentOptions(s,null,{nbSamples:o}),r&&console.log("write audio: close",t)}})}var W={preventCancel:!0,preventClose:!0,preventAbort:!0},K=class extends EventTarget{constructor(){super()}async start(e){let r=e.DEV??!1;Y.Log.setLogLevel(r?Y.Log.LOG_LEVEL_DEBUG:Y.Log.LOG_LEVEL_ERROR);let s=this.dispatchEvent.bind(this),o=await _t(e.file),a=o.fps;r&&console.log("info",o);let h=o.audioInfo?o.videoInfo.nb_samples+o.audioInfo.nb_samples:o.videoInfo.nb_samples,d=0;s(new CustomEvent("progress",{detail:{samplesNumber:h,samplesCount:d}}));let p=pt(o.videoInfo.video,e.resizeConfig),l={width:et(p.width,2),height:et(p.height,2)},f={...e.encoderConfig,codec:(e.codecEntries?.find(v=>v[0]>=a)??[null,"avc1.4d0034"])[1],...l},c=(0,Y.createFile)();function _(){return new TransformStream({start(){},transform(v,U){U.enqueue(v),d++,s(new CustomEvent("progress",{detail:{samplesNumber:h,samplesCount:d}}))},flush(){}})}let y={nbSamples:o.videoInfo.nb_samples};if(await e.file.stream().pipeThrough(tt(o.videoInfo.id,r),W).pipeThrough(ut(r)).pipeThrough(await ct(o.videoInfo,o.description,r),W).pipeThrough(gt(o.videoInfo,y,r),W).pipeThrough(yt(e.resizeConfig,r)).pipeThrough(mt(f,y,r),W).pipeThrough(_()).pipeTo(vt(c,f,o.videoInfo,r)),o.audioInfo&&await e.file.stream().pipeThrough(tt(o.audioInfo.id,r),W).pipeThrough(_()).pipeTo(xt(c,o.audioInfo,r)),d!==h&&(d=h,s(new CustomEvent("progress",{detail:{samplesNumber:h,samplesCount:d}}))),c.moov){let v=new Date("1904-01-01T00:00:00Z").getTime();c.moov.mvhd?.set("creation_time",Math.floor((o.info.created.getTime()-v)/1e3)),c.moov.mvhd?.set("modification_time",Math.floor((Date.now()-v)/1e3)),c.moov.mvhd?.set("timescale",o.info.timescale),c.moov.mvhd?.set("duration",o.info.duration)}let x=c.getBuffer();s(new CustomEvent("result",{detail:{buffer:x}})),c.flush()}};globalThis.onmessage=async t=>{let e=t.data;await new Promise((r,s)=>{let o=new K;function a(p){return l=>{globalThis.postMessage({type:p,...l.detail})}}let h=a("progress"),d=p=>{a("result")(p),r(),o.removeEventListener("progress",h),o.removeEventListener("result",d)};o.addEventListener("progress",h),o.addEventListener("result",d),o.start(e).catch(p=>s(p))})};
