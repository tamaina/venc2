var Ke=Object.create;var be=Object.defineProperty;var Xe=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames;var Ze=Object.getPrototypeOf,Qe=Object.prototype.hasOwnProperty;var Je=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var et=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of $e(t))!Qe.call(e,o)&&o!==r&&be(e,o,{get:()=>t[o],enumerable:!(s=Xe(t,o))||s.enumerable});return e};var K=(e,t,r)=>(r=e!=null?Ke(Ze(e)):{},et(t||!e||!e.__esModule?be(r,"default",{value:e,enumerable:!0}):r,e));var W=Je(I=>{"use strict";var g=function(){var e=new Date,t=4,r=3,s=2,o=1,a=t,h={setLogLevel:function(l){l==this.debug?a=o:l==this.info?a=s:l==this.warn?a=r:(l==this.error,a=t)},debug:function(l,d){console.debug===void 0&&(console.debug=console.log),o>=a&&console.debug("["+g.getDurationString(new Date-e,1e3)+"]","["+l+"]",d)},log:function(l,d){this.debug(l.msg)},info:function(l,d){s>=a&&console.info("["+g.getDurationString(new Date-e,1e3)+"]","["+l+"]",d)},warn:function(l,d){r>=a&&console.warn("["+g.getDurationString(new Date-e,1e3)+"]","["+l+"]",d)},error:function(l,d){t>=a&&console.error("["+g.getDurationString(new Date-e,1e3)+"]","["+l+"]",d)}};return h}();g.getDurationString=function(e,t){var r;function s(c,f){for(var m=""+c,u=m.split(".");u[0].length<f;)u[0]="0"+u[0];return u.join(".")}e<0?(r=!0,e=-e):r=!1;var o=t||1,a=e/o,h=Math.floor(a/3600);a-=h*3600;var l=Math.floor(a/60);a-=l*60;var d=a*1e3;return a=Math.floor(a),d-=a*1e3,d=Math.floor(d),(r?"-":"")+h+":"+s(l,2)+":"+s(a,2)+"."+s(d,3)};g.printRanges=function(e){var t=e.length;if(t>0){for(var r="",s=0;s<t;s++)s>0&&(r+=","),r+="["+g.getDurationString(e.start(s))+","+g.getDurationString(e.end(s))+"]";return r}else return"(empty)"};typeof I<"u"&&(I.Log=g);var B=function(e){if(e instanceof ArrayBuffer)this.buffer=e,this.dataview=new DataView(e);else throw"Needs an array buffer";this.position=0};B.prototype.getPosition=function(){return this.position};B.prototype.getEndPosition=function(){return this.buffer.byteLength};B.prototype.getLength=function(){return this.buffer.byteLength};B.prototype.seek=function(e){var t=Math.max(0,Math.min(this.buffer.byteLength,e));return this.position=isNaN(t)||!isFinite(t)?0:t,!0};B.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()};B.prototype.readAnyInt=function(e,t){var r=0;if(this.position+e<=this.buffer.byteLength){switch(e){case 1:t?r=this.dataview.getInt8(this.position):r=this.dataview.getUint8(this.position);break;case 2:t?r=this.dataview.getInt16(this.position):r=this.dataview.getUint16(this.position);break;case 3:if(t)throw"No method for reading signed 24 bits values";r=this.dataview.getUint8(this.position)<<16,r|=this.dataview.getUint8(this.position+1)<<8,r|=this.dataview.getUint8(this.position+2);break;case 4:t?r=this.dataview.getInt32(this.position):r=this.dataview.getUint32(this.position);break;case 8:if(t)throw"No method for reading signed 64 bits values";r=this.dataview.getUint32(this.position)<<32,r|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+e}return this.position+=e,r}else throw"Not enough bytes in buffer"};B.prototype.readUint8=function(){return this.readAnyInt(1,!1)};B.prototype.readUint16=function(){return this.readAnyInt(2,!1)};B.prototype.readUint24=function(){return this.readAnyInt(3,!1)};B.prototype.readUint32=function(){return this.readAnyInt(4,!1)};B.prototype.readUint64=function(){return this.readAnyInt(8,!1)};B.prototype.readString=function(e){if(this.position+e<=this.buffer.byteLength){for(var t="",r=0;r<e;r++)t+=String.fromCharCode(this.readUint8());return t}else throw"Not enough bytes in buffer"};B.prototype.readCString=function(){for(var e=[];;){var t=this.readUint8();if(t!==0)e.push(t);else break}return String.fromCharCode.apply(null,e)};B.prototype.readInt8=function(){return this.readAnyInt(1,!0)};B.prototype.readInt16=function(){return this.readAnyInt(2,!0)};B.prototype.readInt32=function(){return this.readAnyInt(4,!0)};B.prototype.readInt64=function(){return this.readAnyInt(8,!1)};B.prototype.readUint8Array=function(e){for(var t=new Uint8Array(e),r=0;r<e;r++)t[r]=this.readUint8();return t};B.prototype.readInt16Array=function(e){for(var t=new Int16Array(e),r=0;r<e;r++)t[r]=this.readInt16();return t};B.prototype.readUint16Array=function(e){for(var t=new Int16Array(e),r=0;r<e;r++)t[r]=this.readUint16();return t};B.prototype.readUint32Array=function(e){for(var t=new Uint32Array(e),r=0;r<e;r++)t[r]=this.readUint32();return t};B.prototype.readInt32Array=function(e){for(var t=new Int32Array(e),r=0;r<e;r++)t[r]=this.readInt32();return t};typeof I<"u"&&(I.MP4BoxStream=B);var _=function(e,t,r){this._byteOffset=t||0,e instanceof ArrayBuffer?this.buffer=e:typeof e=="object"?(this.dataView=e,t&&(this._byteOffset+=t)):this.buffer=new ArrayBuffer(e||0),this.position=0,this.endianness=r??_.LITTLE_ENDIAN};_.prototype={};_.prototype.getPosition=function(){return this.position};_.prototype._realloc=function(e){if(this._dynamicSize){var t=this._byteOffset+this.position+e,r=this._buffer.byteLength;if(t<=r){t>this._byteLength&&(this._byteLength=t);return}for(r<1&&(r=1);t>r;)r*=2;var s=new ArrayBuffer(r),o=new Uint8Array(this._buffer),a=new Uint8Array(s,0,o.length);a.set(o),this.buffer=s,this._byteLength=t}};_.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var e=new ArrayBuffer(this._byteLength),t=new Uint8Array(e),r=new Uint8Array(this._buffer,0,t.length);t.set(r),this.buffer=e}};_.BIG_ENDIAN=!1;_.LITTLE_ENDIAN=!0;_.prototype._byteLength=0;Object.defineProperty(_.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}});Object.defineProperty(_.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(e){this._buffer=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}});Object.defineProperty(_.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(e){this._byteOffset=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}});Object.defineProperty(_.prototype,"dataView",{get:function(){return this._dataView},set:function(e){this._byteOffset=e.byteOffset,this._buffer=e.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+e.byteLength}});_.prototype.seek=function(e){var t=Math.max(0,Math.min(this.byteLength,e));this.position=isNaN(t)||!isFinite(t)?0:t};_.prototype.isEof=function(){return this.position>=this._byteLength};_.prototype.mapUint8Array=function(e){this._realloc(e*1);var t=new Uint8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=e*1,t};_.prototype.readInt32Array=function(e,t){e=e??this.byteLength-this.position/4;var r=new Int32Array(e);return _.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),_.arrayToNative(r,t??this.endianness),this.position+=r.byteLength,r};_.prototype.readInt16Array=function(e,t){e=e??this.byteLength-this.position/2;var r=new Int16Array(e);return _.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),_.arrayToNative(r,t??this.endianness),this.position+=r.byteLength,r};_.prototype.readInt8Array=function(e){e=e??this.byteLength-this.position;var t=new Int8Array(e);return _.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT),this.position+=t.byteLength,t};_.prototype.readUint32Array=function(e,t){e=e??this.byteLength-this.position/4;var r=new Uint32Array(e);return _.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),_.arrayToNative(r,t??this.endianness),this.position+=r.byteLength,r};_.prototype.readUint16Array=function(e,t){e=e??this.byteLength-this.position/2;var r=new Uint16Array(e);return _.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),_.arrayToNative(r,t??this.endianness),this.position+=r.byteLength,r};_.prototype.readUint8Array=function(e){e=e??this.byteLength-this.position;var t=new Uint8Array(e);return _.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT),this.position+=t.byteLength,t};_.prototype.readFloat64Array=function(e,t){e=e??this.byteLength-this.position/8;var r=new Float64Array(e);return _.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),_.arrayToNative(r,t??this.endianness),this.position+=r.byteLength,r};_.prototype.readFloat32Array=function(e,t){e=e??this.byteLength-this.position/4;var r=new Float32Array(e);return _.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),_.arrayToNative(r,t??this.endianness),this.position+=r.byteLength,r};_.prototype.readInt32=function(e){var t=this._dataView.getInt32(this.position,e??this.endianness);return this.position+=4,t};_.prototype.readInt16=function(e){var t=this._dataView.getInt16(this.position,e??this.endianness);return this.position+=2,t};_.prototype.readInt8=function(){var e=this._dataView.getInt8(this.position);return this.position+=1,e};_.prototype.readUint32=function(e){var t=this._dataView.getUint32(this.position,e??this.endianness);return this.position+=4,t};_.prototype.readUint16=function(e){var t=this._dataView.getUint16(this.position,e??this.endianness);return this.position+=2,t};_.prototype.readUint8=function(){var e=this._dataView.getUint8(this.position);return this.position+=1,e};_.prototype.readFloat32=function(e){var t=this._dataView.getFloat32(this.position,e??this.endianness);return this.position+=4,t};_.prototype.readFloat64=function(e){var t=this._dataView.getFloat64(this.position,e??this.endianness);return this.position+=8,t};_.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0;_.memcpy=function(e,t,r,s,o){var a=new Uint8Array(e,t,o),h=new Uint8Array(r,s,o);a.set(h)};_.arrayToNative=function(e,t){return t==this.endianness?e:this.flipArrayEndianness(e)};_.nativeToEndian=function(e,t){return this.endianness==t?e:this.flipArrayEndianness(e)};_.flipArrayEndianness=function(e){for(var t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=0;r<e.byteLength;r+=e.BYTES_PER_ELEMENT)for(var s=r+e.BYTES_PER_ELEMENT-1,o=r;s>o;s--,o++){var a=t[o];t[o]=t[s],t[s]=a}return e};_.prototype.failurePosition=0;String.fromCharCodeUint8=function(e){for(var t=[],r=0;r<e.length;r++)t[r]=e[r];return String.fromCharCode.apply(null,t)};_.prototype.readString=function(e,t){return t==null||t=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(e??this.byteLength-this.position)]):new TextDecoder(t).decode(this.mapUint8Array(e))};_.prototype.readCString=function(e){var t=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position),s=t;e!=null&&(s=Math.min(e,t));for(var o=0;o<s&&r[o]!==0;o++);var a=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(o)]);return e!=null?this.position+=s-o:o!=t&&(this.position+=1),a};var H=Math.pow(2,32);_.prototype.readInt64=function(){return this.readInt32()*H+this.readUint32()};_.prototype.readUint64=function(){return this.readUint32()*H+this.readUint32()};_.prototype.readInt64=function(){return this.readUint32()*H+this.readUint32()};_.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()};typeof I<"u"&&(I.DataStream=_);_.prototype.save=function(e){var t=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var r=window.URL.createObjectURL(t),s=document.createElement("a");document.body.appendChild(s),s.setAttribute("href",r),s.setAttribute("download",e),s.setAttribute("target","_self"),s.click(),window.URL.revokeObjectURL(r)}else throw"DataStream.save: Can't create object URL."};_.prototype._dynamicSize=!0;Object.defineProperty(_.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(e){e||this._trimAlloc(),this._dynamicSize=e}});_.prototype.shift=function(e){var t=new ArrayBuffer(this._byteLength-e),r=new Uint8Array(t),s=new Uint8Array(this._buffer,e,r.length);r.set(s),this.buffer=t,this.position-=e};_.prototype.writeInt32Array=function(e,t){if(this._realloc(e.length*4),e instanceof Int32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)_.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapInt32Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeInt32(e[r],t)};_.prototype.writeInt16Array=function(e,t){if(this._realloc(e.length*2),e instanceof Int16Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)_.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapInt16Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeInt16(e[r],t)};_.prototype.writeInt8Array=function(e){if(this._realloc(e.length*1),e instanceof Int8Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)_.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapInt8Array(e.length);else for(var t=0;t<e.length;t++)this.writeInt8(e[t])};_.prototype.writeUint32Array=function(e,t){if(this._realloc(e.length*4),e instanceof Uint32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)_.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapUint32Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeUint32(e[r],t)};_.prototype.writeUint16Array=function(e,t){if(this._realloc(e.length*2),e instanceof Uint16Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)_.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapUint16Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeUint16(e[r],t)};_.prototype.writeUint8Array=function(e){if(this._realloc(e.length*1),e instanceof Uint8Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)_.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapUint8Array(e.length);else for(var t=0;t<e.length;t++)this.writeUint8(e[t])};_.prototype.writeFloat64Array=function(e,t){if(this._realloc(e.length*8),e instanceof Float64Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)_.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapFloat64Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeFloat64(e[r],t)};_.prototype.writeFloat32Array=function(e,t){if(this._realloc(e.length*4),e instanceof Float32Array&&this.byteOffset+this.position%e.BYTES_PER_ELEMENT===0)_.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,0,e.byteLength),this.mapFloat32Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeFloat32(e[r],t)};_.prototype.writeInt32=function(e,t){this._realloc(4),this._dataView.setInt32(this.position,e,t??this.endianness),this.position+=4};_.prototype.writeInt16=function(e,t){this._realloc(2),this._dataView.setInt16(this.position,e,t??this.endianness),this.position+=2};_.prototype.writeInt8=function(e){this._realloc(1),this._dataView.setInt8(this.position,e),this.position+=1};_.prototype.writeUint32=function(e,t){this._realloc(4),this._dataView.setUint32(this.position,e,t??this.endianness),this.position+=4};_.prototype.writeUint16=function(e,t){this._realloc(2),this._dataView.setUint16(this.position,e,t??this.endianness),this.position+=2};_.prototype.writeUint8=function(e){this._realloc(1),this._dataView.setUint8(this.position,e),this.position+=1};_.prototype.writeFloat32=function(e,t){this._realloc(4),this._dataView.setFloat32(this.position,e,t??this.endianness),this.position+=4};_.prototype.writeFloat64=function(e,t){this._realloc(8),this._dataView.setFloat64(this.position,e,t??this.endianness),this.position+=8};_.prototype.writeUCS2String=function(e,t,r){r==null&&(r=e.length);for(var s=0;s<e.length&&s<r;s++)this.writeUint16(e.charCodeAt(s),t);for(;s<r;s++)this.writeUint16(0)};_.prototype.writeString=function(e,t,r){var s=0;if(t==null||t=="ASCII")if(r!=null){var o=Math.min(e.length,r);for(s=0;s<o;s++)this.writeUint8(e.charCodeAt(s));for(;s<r;s++)this.writeUint8(0)}else for(s=0;s<e.length;s++)this.writeUint8(e.charCodeAt(s));else this.writeUint8Array(new TextEncoder(t).encode(e.substring(0,r)))};_.prototype.writeCString=function(e,t){var r=0;if(t!=null){var s=Math.min(e.length,t);for(r=0;r<s;r++)this.writeUint8(e.charCodeAt(r));for(;r<t;r++)this.writeUint8(0)}else{for(r=0;r<e.length;r++)this.writeUint8(e.charCodeAt(r));this.writeUint8(0)}};_.prototype.writeStruct=function(e,t){for(var r=0;r<e.length;r+=2){var s=e[r+1];this.writeType(s,t[e[r]],t)}};_.prototype.writeType=function(e,t,r){var s;if(typeof e=="function")return e(this,t);if(typeof e=="object"&&!(e instanceof Array))return e.set(this,t,r);var o=null,a="ASCII",h=this.position;switch(typeof e=="string"&&/:/.test(e)&&(s=e.split(":"),e=s[0],o=parseInt(s[1])),typeof e=="string"&&/,/.test(e)&&(s=e.split(","),e=s[0],a=parseInt(s[1])),e){case"uint8":this.writeUint8(t);break;case"int8":this.writeInt8(t);break;case"uint16":this.writeUint16(t,this.endianness);break;case"int16":this.writeInt16(t,this.endianness);break;case"uint32":this.writeUint32(t,this.endianness);break;case"int32":this.writeInt32(t,this.endianness);break;case"float32":this.writeFloat32(t,this.endianness);break;case"float64":this.writeFloat64(t,this.endianness);break;case"uint16be":this.writeUint16(t,_.BIG_ENDIAN);break;case"int16be":this.writeInt16(t,_.BIG_ENDIAN);break;case"uint32be":this.writeUint32(t,_.BIG_ENDIAN);break;case"int32be":this.writeInt32(t,_.BIG_ENDIAN);break;case"float32be":this.writeFloat32(t,_.BIG_ENDIAN);break;case"float64be":this.writeFloat64(t,_.BIG_ENDIAN);break;case"uint16le":this.writeUint16(t,_.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(t,_.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(t,_.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(t,_.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(t,_.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(t,_.LITTLE_ENDIAN);break;case"cstring":this.writeCString(t,o);break;case"string":this.writeString(t,a,o);break;case"u16string":this.writeUCS2String(t,this.endianness,o);break;case"u16stringle":this.writeUCS2String(t,_.LITTLE_ENDIAN,o);break;case"u16stringbe":this.writeUCS2String(t,_.BIG_ENDIAN,o);break;default:if(e.length==3){for(var l=e[1],d=0;d<t.length;d++)this.writeType(l,t[d]);break}else{this.writeStruct(e,t);break}}o!=null&&(this.position=h,this._realloc(o),this.position=h+o)};_.prototype.writeUint64=function(e){var t=Math.floor(e/H);this.writeUint32(t),this.writeUint32(e&4294967295)};_.prototype.writeUint24=function(e){this.writeUint8((e&16711680)>>16),this.writeUint8((e&65280)>>8),this.writeUint8(e&255)};_.prototype.adjustUint32=function(e,t){var r=this.position;this.seek(e),this.writeUint32(t),this.seek(r)};_.prototype.mapInt32Array=function(e,t){this._realloc(e*4);var r=new Int32Array(this._buffer,this.byteOffset+this.position,e);return _.arrayToNative(r,t??this.endianness),this.position+=e*4,r};_.prototype.mapInt16Array=function(e,t){this._realloc(e*2);var r=new Int16Array(this._buffer,this.byteOffset+this.position,e);return _.arrayToNative(r,t??this.endianness),this.position+=e*2,r};_.prototype.mapInt8Array=function(e){this._realloc(e*1);var t=new Int8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=e*1,t};_.prototype.mapUint32Array=function(e,t){this._realloc(e*4);var r=new Uint32Array(this._buffer,this.byteOffset+this.position,e);return _.arrayToNative(r,t??this.endianness),this.position+=e*4,r};_.prototype.mapUint16Array=function(e,t){this._realloc(e*2);var r=new Uint16Array(this._buffer,this.byteOffset+this.position,e);return _.arrayToNative(r,t??this.endianness),this.position+=e*2,r};_.prototype.mapFloat64Array=function(e,t){this._realloc(e*8);var r=new Float64Array(this._buffer,this.byteOffset+this.position,e);return _.arrayToNative(r,t??this.endianness),this.position+=e*8,r};_.prototype.mapFloat32Array=function(e,t){this._realloc(e*4);var r=new Float32Array(this._buffer,this.byteOffset+this.position,e);return _.arrayToNative(r,t??this.endianness),this.position+=e*4,r};var F=function(e){this.buffers=[],this.bufferIndex=-1,e&&(this.insertBuffer(e),this.bufferIndex=0)};F.prototype=new _(new ArrayBuffer,0,_.BIG_ENDIAN);F.prototype.initialized=function(){var e;return this.bufferIndex>-1?!0:this.buffers.length>0?(e=this.buffers[0],e.fileStart===0?(this.buffer=e,this.bufferIndex=0,g.debug("MultiBufferStream","Stream ready for parsing"),!0):(g.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(g.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)};ArrayBuffer.concat=function(e,t){g.debug("ArrayBuffer","Trying to create a new buffer of size: "+(e.byteLength+t.byteLength));var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer};F.prototype.reduceBuffer=function(e,t,r){var s;return s=new Uint8Array(r),s.set(new Uint8Array(e,t,r)),s.buffer.fileStart=e.fileStart+t,s.buffer.usedBytes=0,s.buffer};F.prototype.insertBuffer=function(e){for(var t=!0,r=0;r<this.buffers.length;r++){var s=this.buffers[r];if(e.fileStart<=s.fileStart){if(e.fileStart===s.fileStart)if(e.byteLength>s.byteLength){this.buffers.splice(r,1),r--;continue}else g.warn("MultiBufferStream","Buffer (fileStart: "+e.fileStart+" - Length: "+e.byteLength+") already appended, ignoring");else e.fileStart+e.byteLength<=s.fileStart||(e=this.reduceBuffer(e,0,s.fileStart-e.fileStart)),g.debug("MultiBufferStream","Appending new buffer (fileStart: "+e.fileStart+" - Length: "+e.byteLength+")"),this.buffers.splice(r,0,e),r===0&&(this.buffer=e);t=!1;break}else if(e.fileStart<s.fileStart+s.byteLength){var o=s.fileStart+s.byteLength-e.fileStart,a=e.byteLength-o;if(a>0)e=this.reduceBuffer(e,o,a);else{t=!1;break}}}t&&(g.debug("MultiBufferStream","Appending new buffer (fileStart: "+e.fileStart+" - Length: "+e.byteLength+")"),this.buffers.push(e),r===0&&(this.buffer=e))};F.prototype.logBufferLevel=function(e){var t,r,s,o,a=[],h,l="";for(s=0,o=0,t=0;t<this.buffers.length;t++)r=this.buffers[t],t===0?(h={},a.push(h),h.start=r.fileStart,h.end=r.fileStart+r.byteLength,l+="["+h.start+"-"):h.end===r.fileStart?h.end=r.fileStart+r.byteLength:(h={},h.start=r.fileStart,l+=a[a.length-1].end-1+"], ["+h.start+"-",h.end=r.fileStart+r.byteLength,a.push(h)),s+=r.usedBytes,o+=r.byteLength;a.length>0&&(l+=h.end-1+"]");var d=e?g.info:g.debug;this.buffers.length===0?d("MultiBufferStream","No more buffer in memory"):d("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+s+"/"+o+" bytes), continuous ranges: "+l)};F.prototype.cleanBuffers=function(){var e,t;for(e=0;e<this.buffers.length;e++)t=this.buffers[e],t.usedBytes===t.byteLength&&(g.debug("MultiBufferStream","Removing buffer #"+e),this.buffers.splice(e,1),e--)};F.prototype.mergeNextBuffer=function(){var e;if(this.bufferIndex+1<this.buffers.length)if(e=this.buffers[this.bufferIndex+1],e.fileStart===this.buffer.fileStart+this.buffer.byteLength){var t=this.buffer.byteLength,r=this.buffer.usedBytes,s=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,e),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=r,this.buffer.fileStart=s,g.debug("ISOFile","Concatenating buffer for box parsing (length: "+t+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1};F.prototype.findPosition=function(e,t,r){var s,o=null,a=-1;for(e===!0?s=0:s=this.bufferIndex;s<this.buffers.length&&(o=this.buffers[s],o.fileStart<=t);){a=s,r&&(o.fileStart+o.byteLength<=t?o.usedBytes=o.byteLength:o.usedBytes=t-o.fileStart,this.logBufferLevel());s++}return a!==-1?(o=this.buffers[a],o.fileStart+o.byteLength>=t?(g.debug("MultiBufferStream","Found position in existing buffer #"+a),a):-1):-1};F.prototype.findEndContiguousBuf=function(e){var t,r,s,o=e!==void 0?e:this.bufferIndex;if(r=this.buffers[o],this.buffers.length>o+1)for(t=o+1;t<this.buffers.length&&(s=this.buffers[t],s.fileStart===r.fileStart+r.byteLength);t++)r=s;return r.fileStart+r.byteLength};F.prototype.getEndFilePositionAfter=function(e){var t=this.findPosition(!0,e,!1);return t!==-1?this.findEndContiguousBuf(t):e};F.prototype.addUsedBytes=function(e){this.buffer.usedBytes+=e,this.logBufferLevel()};F.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()};F.prototype.seek=function(e,t,r){var s;return s=this.findPosition(t,e,r),s!==-1?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=e-this.buffer.fileStart,g.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(g.debug("MultiBufferStream","Position "+e+" not found in buffered data"),!1)};F.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position};F.prototype.getLength=function(){return this.byteLength};F.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength};typeof I<"u"&&(I.MultiBufferStream=F);var oe=function(){var e=3,t=4,r=5,s=6,o=[];o[e]="ES_Descriptor",o[t]="DecoderConfigDescriptor",o[r]="DecoderSpecificInfo",o[s]="SLConfigDescriptor",this.getDescriptorName=function(l){return o[l]};var a=this,h={};return this.parseOneDescriptor=function(l){var d=0,c=0,f,m,u;for(f=l.readUint8(),d++,u=l.readUint8(),d++;u&128;)c=(u&127)<<7,u=l.readUint8(),d++;return c+=u&127,g.debug("MPEG4DescriptorParser","Found "+(o[f]||"Descriptor "+f)+", size "+c+" at position "+l.getPosition()),o[f]?m=new h[o[f]](c):m=new h.Descriptor(c),m.parse(l),m},h.Descriptor=function(l,d){this.tag=l,this.size=d,this.descs=[]},h.Descriptor.prototype.parse=function(l){this.data=l.readUint8Array(this.size)},h.Descriptor.prototype.findDescriptor=function(l){for(var d=0;d<this.descs.length;d++)if(this.descs[d].tag==l)return this.descs[d];return null},h.Descriptor.prototype.parseRemainingDescriptors=function(l){for(var d=l.position;l.position<d+this.size;){var c=a.parseOneDescriptor(l);this.descs.push(c)}},h.ES_Descriptor=function(l){h.Descriptor.call(this,e,l)},h.ES_Descriptor.prototype=new h.Descriptor,h.ES_Descriptor.prototype.parse=function(l){if(this.ES_ID=l.readUint16(),this.flags=l.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=l.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var d=l.readUint8();this.URL=l.readString(d),this.size-=d+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=l.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(l)},h.ES_Descriptor.prototype.getOTI=function(l){var d=this.findDescriptor(t);return d?d.oti:0},h.ES_Descriptor.prototype.getAudioConfig=function(l){var d=this.findDescriptor(t);if(!d)return null;var c=d.findDescriptor(r);if(c&&c.data){var f=(c.data[0]&248)>>3;return f===31&&c.data.length>=2&&(f=32+((c.data[0]&7)<<3)+((c.data[1]&224)>>5)),f}else return null},h.DecoderConfigDescriptor=function(l){h.Descriptor.call(this,t,l)},h.DecoderConfigDescriptor.prototype=new h.Descriptor,h.DecoderConfigDescriptor.prototype.parse=function(l){this.oti=l.readUint8(),this.streamType=l.readUint8(),this.bufferSize=l.readUint24(),this.maxBitrate=l.readUint32(),this.avgBitrate=l.readUint32(),this.size-=13,this.parseRemainingDescriptors(l)},h.DecoderSpecificInfo=function(l){h.Descriptor.call(this,r,l)},h.DecoderSpecificInfo.prototype=new h.Descriptor,h.SLConfigDescriptor=function(l){h.Descriptor.call(this,s,l)},h.SLConfigDescriptor.prototype=new h.Descriptor,this};typeof I<"u"&&(I.MPEG4DescriptorParser=oe);var n={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){n.FullBox.prototype=new n.Box,n.ContainerBox.prototype=new n.Box,n.SampleEntry.prototype=new n.Box,n.TrackGroupTypeBox.prototype=new n.FullBox,n.BASIC_BOXES.forEach(function(e){n.createBoxCtor(e)}),n.FULL_BOXES.forEach(function(e){n.createFullBoxCtor(e)}),n.CONTAINER_BOXES.forEach(function(e){n.createContainerBoxCtor(e[0],null,e[1])})},Box:function(e,t,r){this.type=e,this.size=t,this.uuid=r},FullBox:function(e,t,r){n.Box.call(this,e,t,r),this.flags=0,this.version=0},ContainerBox:function(e,t,r){n.Box.call(this,e,t,r),this.boxes=[]},SampleEntry:function(e,t,r,s){n.ContainerBox.call(this,e,t),this.hdr_size=r,this.start=s},SampleGroupEntry:function(e){this.grouping_type=e},TrackGroupTypeBox:function(e,t){n.FullBox.call(this,e,t)},createBoxCtor:function(e,t){n.boxCodes.push(e),n[e+"Box"]=function(r){n.Box.call(this,e,r)},n[e+"Box"].prototype=new n.Box,t&&(n[e+"Box"].prototype.parse=t)},createFullBoxCtor:function(e,t){n[e+"Box"]=function(r){n.FullBox.call(this,e,r)},n[e+"Box"].prototype=new n.FullBox,n[e+"Box"].prototype.parse=function(r){this.parseFullHeader(r),t&&t.call(this,r)}},addSubBoxArrays:function(e){if(e){this.subBoxNames=e;for(var t=e.length,r=0;r<t;r++)this[e[r]+"s"]=[]}},createContainerBoxCtor:function(e,t,r){n[e+"Box"]=function(s){n.ContainerBox.call(this,e,s),n.addSubBoxArrays.call(this,r)},n[e+"Box"].prototype=new n.ContainerBox,t&&(n[e+"Box"].prototype.parse=t)},createMediaSampleEntryCtor:function(e,t,r){n.sampleEntryCodes[e]=[],n[e+"SampleEntry"]=function(s,o){n.SampleEntry.call(this,s,o),n.addSubBoxArrays.call(this,r)},n[e+"SampleEntry"].prototype=new n.SampleEntry,t&&(n[e+"SampleEntry"].prototype.parse=t)},createSampleEntryCtor:function(e,t,r,s){n.sampleEntryCodes[e].push(t),n[t+"SampleEntry"]=function(o){n[e+"SampleEntry"].call(this,t,o),n.addSubBoxArrays.call(this,s)},n[t+"SampleEntry"].prototype=new n[e+"SampleEntry"],r&&(n[t+"SampleEntry"].prototype.parse=r)},createEncryptedSampleEntryCtor:function(e,t,r){n.createSampleEntryCtor.call(this,e,t,r,["sinf"])},createSampleGroupCtor:function(e,t){n[e+"SampleGroupEntry"]=function(r){n.SampleGroupEntry.call(this,e,r)},n[e+"SampleGroupEntry"].prototype=new n.SampleGroupEntry,t&&(n[e+"SampleGroupEntry"].prototype.parse=t)},createTrackGroupCtor:function(e,t){n[e+"TrackGroupTypeBox"]=function(r){n.TrackGroupTypeBox.call(this,e,r)},n[e+"TrackGroupTypeBox"].prototype=new n.TrackGroupTypeBox,t&&(n[e+"TrackGroupTypeBox"].prototype.parse=t)},createUUIDBox:function(e,t,r,s){n.UUIDs.push(e),n.UUIDBoxes[e]=function(o){t?n.FullBox.call(this,"uuid",o,e):r?n.ContainerBox.call(this,"uuid",o,e):n.Box.call(this,"uuid",o,e)},n.UUIDBoxes[e].prototype=t?new n.FullBox:r?new n.ContainerBox:new n.Box,s&&(t?n.UUIDBoxes[e].prototype.parse=function(o){this.parseFullHeader(o),s&&s.call(this,o)}:n.UUIDBoxes[e].prototype.parse=s)}};n.initialize();n.TKHD_FLAG_ENABLED=1;n.TKHD_FLAG_IN_MOVIE=2;n.TKHD_FLAG_IN_PREVIEW=4;n.TFHD_FLAG_BASE_DATA_OFFSET=1;n.TFHD_FLAG_SAMPLE_DESC=2;n.TFHD_FLAG_SAMPLE_DUR=8;n.TFHD_FLAG_SAMPLE_SIZE=16;n.TFHD_FLAG_SAMPLE_FLAGS=32;n.TFHD_FLAG_DUR_EMPTY=65536;n.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072;n.TRUN_FLAGS_DATA_OFFSET=1;n.TRUN_FLAGS_FIRST_FLAG=4;n.TRUN_FLAGS_DURATION=256;n.TRUN_FLAGS_SIZE=512;n.TRUN_FLAGS_FLAGS=1024;n.TRUN_FLAGS_CTS_OFFSET=2048;n.Box.prototype.add=function(e){return this.addBox(new n[e+"Box"])};n.Box.prototype.addBox=function(e){return this.boxes.push(e),this[e.type+"s"]?this[e.type+"s"].push(e):this[e.type]=e,e};n.Box.prototype.set=function(e,t){return this[e]=t,this};n.Box.prototype.addEntry=function(e,t){var r=t||"entries";return this[r]||(this[r]=[]),this[r].push(e),this};typeof I<"u"&&(I.BoxParser=n);n.parseUUID=function(e){return n.parseHex16(e)};n.parseHex16=function(e){for(var t="",r=0;r<16;r++){var s=e.readUint8().toString(16);t+=s.length===1?"0"+s:s}return t};n.parseOneBox=function(e,t,r){var s,o=e.getPosition(),a=0,h,l;if(e.getEndPosition()-o<8)return g.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:n.ERR_NOT_ENOUGH_DATA};if(r&&r<8)return g.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:n.ERR_NOT_ENOUGH_DATA};var d=e.readUint32(),c=e.readString(4),f=c;if(g.debug("BoxParser","Found box of type '"+c+"' and size "+d+" at position "+o),a=8,c=="uuid"){if(e.getEndPosition()-e.getPosition()<16||r-a<16)return e.seek(o),g.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:n.ERR_NOT_ENOUGH_DATA};l=n.parseUUID(e),a+=16,f=l}if(d==1){if(e.getEndPosition()-e.getPosition()<8||r&&r-a<8)return e.seek(o),g.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+c+'" box'),{code:n.ERR_NOT_ENOUGH_DATA};d=e.readUint64(),a+=8}else if(d===0){if(r)d=r;else if(c!=="mdat")return g.error("BoxParser","Unlimited box size not supported for type: '"+c+"'"),s=new n.Box(c,d),{code:n.OK,box:s,size:s.size}}return d!==0&&d<a?(g.error("BoxParser","Box of type "+c+" has an invalid size "+d+" (too small to be a box)"),{code:n.ERR_NOT_ENOUGH_DATA,type:c,size:d,hdr_size:a,start:o}):d!==0&&r&&d>r?(g.error("BoxParser","Box of type '"+c+"' has a size "+d+" greater than its container size "+r),{code:n.ERR_NOT_ENOUGH_DATA,type:c,size:d,hdr_size:a,start:o}):d!==0&&o+d>e.getEndPosition()?(e.seek(o),g.info("BoxParser","Not enough data in stream to parse the entire '"+c+"' box"),{code:n.ERR_NOT_ENOUGH_DATA,type:c,size:d,hdr_size:a,start:o}):t?{code:n.OK,type:c,size:d,hdr_size:a,start:o}:(n[c+"Box"]?s=new n[c+"Box"](d):c!=="uuid"?(g.warn("BoxParser","Unknown box type: '"+c+"'"),s=new n.Box(c,d),s.has_unparsed_data=!0):n.UUIDBoxes[l]?s=new n.UUIDBoxes[l](d):(g.warn("BoxParser","Unknown uuid type: '"+l+"'"),s=new n.Box(c,d),s.uuid=l,s.has_unparsed_data=!0),s.hdr_size=a,s.start=o,s.write===n.Box.prototype.write&&s.type!=="mdat"&&(g.info("BoxParser","'"+f+"' box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(e)),s.parse(e),h=e.getPosition()-(s.start+s.size),h<0?(g.warn("BoxParser","Parsing of box '"+f+"' did not read the entire indicated box data size (missing "+-h+" bytes), seeking forward"),e.seek(s.start+s.size)):h>0&&(g.error("BoxParser","Parsing of box '"+f+"' read "+h+" more bytes than the indicated box data size, seeking backwards"),s.size!==0&&e.seek(s.start+s.size)),{code:n.OK,box:s,size:s.size})};n.Box.prototype.parse=function(e){this.type!="mdat"?this.data=e.readUint8Array(this.size-this.hdr_size):this.size===0?e.seek(e.getEndPosition()):e.seek(this.start+this.size)};n.Box.prototype.parseDataAndRewind=function(e){this.data=e.readUint8Array(this.size-this.hdr_size),e.position-=this.size-this.hdr_size};n.FullBox.prototype.parseDataAndRewind=function(e){this.parseFullHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,e.position-=this.size-this.hdr_size};n.FullBox.prototype.parseFullHeader=function(e){this.version=e.readUint8(),this.flags=e.readUint24(),this.hdr_size+=4};n.FullBox.prototype.parse=function(e){this.parseFullHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size)};n.ContainerBox.prototype.parse=function(e){for(var t,r;e.getPosition()<this.start+this.size;)if(t=n.parseOneBox(e,!1,this.size-(e.getPosition()-this.start)),t.code===n.OK)if(r=t.box,this.boxes.push(r),this.subBoxNames&&this.subBoxNames.indexOf(r.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(r.type)]+"s"].push(r);else{var s=r.type!=="uuid"?r.type:r.uuid;this[s]?g.warn("Box of type "+s+" already stored in field of this type"):this[s]=r}else return};n.Box.prototype.parseLanguage=function(e){this.language=e.readUint16();var t=[];t[0]=this.language>>10&31,t[1]=this.language>>5&31,t[2]=this.language&31,this.languageString=String.fromCharCode(t[0]+96,t[1]+96,t[2]+96)};n.SAMPLE_ENTRY_TYPE_VISUAL="Visual";n.SAMPLE_ENTRY_TYPE_AUDIO="Audio";n.SAMPLE_ENTRY_TYPE_HINT="Hint";n.SAMPLE_ENTRY_TYPE_METADATA="Metadata";n.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle";n.SAMPLE_ENTRY_TYPE_SYSTEM="System";n.SAMPLE_ENTRY_TYPE_TEXT="Text";n.SampleEntry.prototype.parseHeader=function(e){e.readUint8Array(6),this.data_reference_index=e.readUint16(),this.hdr_size+=8};n.SampleEntry.prototype.parse=function(e){this.parseHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size)};n.SampleEntry.prototype.parseDataAndRewind=function(e){this.parseHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,e.position-=this.size-this.hdr_size};n.SampleEntry.prototype.parseFooter=function(e){n.ContainerBox.prototype.parse.call(this,e)};n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_HINT);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SYSTEM);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_TEXT);n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,function(e){var t;this.parseHeader(e),e.readUint16(),e.readUint16(),e.readUint32Array(3),this.width=e.readUint16(),this.height=e.readUint16(),this.horizresolution=e.readUint32(),this.vertresolution=e.readUint32(),e.readUint32(),this.frame_count=e.readUint16(),t=Math.min(31,e.readUint8()),this.compressorname=e.readString(t),t<31&&e.readString(31-t),this.depth=e.readUint16(),e.readUint16(),this.parseFooter(e)});n.createMediaSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,function(e){this.parseHeader(e),e.readUint32Array(2),this.channel_count=e.readUint16(),this.samplesize=e.readUint16(),e.readUint16(),e.readUint16(),this.samplerate=e.readUint32()/65536,this.parseFooter(e)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avc1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avc2");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avc3");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avc4");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"av01");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"dav1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"hev1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vp08");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"vp09");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"avs3");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"uncv");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"Opus");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mha1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mha2");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1");n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_VISUAL,"encv");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_AUDIO,"enca");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SYSTEM,"encs");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_TEXT,"enct");n.createEncryptedSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA,"encm");n.createBoxCtor("a1lx",function(e){var t=e.readUint8()&1,r=((t&1)+1)*16;this.layer_size=[];for(var s=0;s<3;s++)r==16?this.layer_size[s]=e.readUint16():this.layer_size[s]=e.readUint32()});n.createBoxCtor("a1op",function(e){this.op_index=e.readUint8()});n.createFullBoxCtor("auxC",function(e){this.aux_type=e.readCString();var t=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=e.readUint8Array(t)});n.createBoxCtor("av1C",function(e){var t,r,s=e.readUint8();if(s>>7&!1){g.error("av1C marker problem");return}if(this.version=s&127,this.version!==1){g.error("av1C version "+this.version+" not supported");return}if(s=e.readUint8(),this.seq_profile=s>>5&7,this.seq_level_idx_0=s&31,s=e.readUint8(),this.seq_tier_0=s>>7&1,this.high_bitdepth=s>>6&1,this.twelve_bit=s>>5&1,this.monochrome=s>>4&1,this.chroma_subsampling_x=s>>3&1,this.chroma_subsampling_y=s>>2&1,this.chroma_sample_position=s&3,s=e.readUint8(),this.reserved_1=s>>5&7,this.reserved_1!==0){g.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=s>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=s&15;else if(this.reserved_2=s&15,this.reserved_2!==0){g.error("av1C reserved_2 parsing problem");return}var o=this.size-this.hdr_size-4;this.configOBUs=e.readUint8Array(o)});n.createBoxCtor("avcC",function(e){var t,r;for(this.configurationVersion=e.readUint8(),this.AVCProfileIndication=e.readUint8(),this.profile_compatibility=e.readUint8(),this.AVCLevelIndication=e.readUint8(),this.lengthSizeMinusOne=e.readUint8()&3,this.nb_SPS_nalus=e.readUint8()&31,r=this.size-this.hdr_size-6,this.SPS=[],t=0;t<this.nb_SPS_nalus;t++)this.SPS[t]={},this.SPS[t].length=e.readUint16(),this.SPS[t].nalu=e.readUint8Array(this.SPS[t].length),r-=2+this.SPS[t].length;for(this.nb_PPS_nalus=e.readUint8(),r--,this.PPS=[],t=0;t<this.nb_PPS_nalus;t++)this.PPS[t]={},this.PPS[t].length=e.readUint16(),this.PPS[t].nalu=e.readUint8Array(this.PPS[t].length),r-=2+this.PPS[t].length;r>0&&(this.ext=e.readUint8Array(r))});n.createBoxCtor("btrt",function(e){this.bufferSizeDB=e.readUint32(),this.maxBitrate=e.readUint32(),this.avgBitrate=e.readUint32()});n.createFullBoxCtor("ccst",function(e){var t=e.readUint8();this.all_ref_pics_intra=(t&128)==128,this.intra_pred_used=(t&64)==64,this.max_ref_per_pic=(t&63)>>2,e.readUint24()});n.createBoxCtor("cdef",function(e){var t;for(this.channel_count=e.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],t=0;t<this.channel_count;t++)this.channel_indexes.push(e.readUint16()),this.channel_types.push(e.readUint16()),this.channel_associations.push(e.readUint16())});n.createBoxCtor("clap",function(e){this.cleanApertureWidthN=e.readUint32(),this.cleanApertureWidthD=e.readUint32(),this.cleanApertureHeightN=e.readUint32(),this.cleanApertureHeightD=e.readUint32(),this.horizOffN=e.readUint32(),this.horizOffD=e.readUint32(),this.vertOffN=e.readUint32(),this.vertOffD=e.readUint32()});n.createBoxCtor("clli",function(e){this.max_content_light_level=e.readUint16(),this.max_pic_average_light_level=e.readUint16()});n.createFullBoxCtor("cmex",function(e){this.flags&1&&(this.pos_x=e.readInt32()),this.flags&2&&(this.pos_y=e.readInt32()),this.flags&4&&(this.pos_z=e.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=e.readInt32(),this.quat_y=e.readInt32(),this.quat_z=e.readInt32()):(this.quat_x=e.readInt16(),this.quat_y=e.readInt16(),this.quat_z=e.readInt16()):this.version==1),this.flags&32&&(this.id=e.readUint32())});n.createFullBoxCtor("cmin",function(e){this.focal_length_x=e.readInt32(),this.principal_point_x=e.readInt32(),this.principal_point_y=e.readInt32(),this.flags&1&&(this.focal_length_y=e.readInt32(),this.skew_factor=e.readInt32())});n.createBoxCtor("cmpd",function(e){for(this.component_count=e.readUint16(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var t=e.readUint16();this.component_types.push(t),t>=32768&&this.component_type_urls.push(e.readCString())}});n.createFullBoxCtor("co64",function(e){var t,r;if(t=e.readUint32(),this.chunk_offsets=[],this.version===0)for(r=0;r<t;r++)this.chunk_offsets.push(e.readUint64())});n.createFullBoxCtor("CoLL",function(e){this.maxCLL=e.readUint16(),this.maxFALL=e.readUint16()});n.createBoxCtor("colr",function(e){if(this.colour_type=e.readString(4),this.colour_type==="nclx"){this.colour_primaries=e.readUint16(),this.transfer_characteristics=e.readUint16(),this.matrix_coefficients=e.readUint16();var t=e.readUint8();this.full_range_flag=t>>7}else this.colour_type==="rICC"?this.ICC_profile=e.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=e.readUint8Array(this.size-4))});n.createFullBoxCtor("cprt",function(e){this.parseLanguage(e),this.notice=e.readCString()});n.createFullBoxCtor("cslg",function(e){var t;this.version===0&&(this.compositionToDTSShift=e.readInt32(),this.leastDecodeToDisplayDelta=e.readInt32(),this.greatestDecodeToDisplayDelta=e.readInt32(),this.compositionStartTime=e.readInt32(),this.compositionEndTime=e.readInt32())});n.createFullBoxCtor("ctts",function(e){var t,r;if(t=e.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(r=0;r<t;r++){this.sample_counts.push(e.readUint32());var s=e.readInt32();s<0&&g.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(s)}else if(this.version==1)for(r=0;r<t;r++)this.sample_counts.push(e.readUint32()),this.sample_offsets.push(e.readInt32())});n.createBoxCtor("dac3",function(e){var t=e.readUint8(),r=e.readUint8(),s=e.readUint8();this.fscod=t>>6,this.bsid=t>>1&31,this.bsmod=(t&1)<<2|r>>6&3,this.acmod=r>>3&7,this.lfeon=r>>2&1,this.bit_rate_code=r&3|s>>5&7});n.createBoxCtor("dec3",function(e){var t=e.readUint16();this.data_rate=t>>3,this.num_ind_sub=t&7,this.ind_subs=[];for(var r=0;r<this.num_ind_sub+1;r++){var s={};this.ind_subs.push(s);var o=e.readUint8(),a=e.readUint8(),h=e.readUint8();s.fscod=o>>6,s.bsid=o>>1&31,s.bsmod=(o&1)<<4|a>>4&15,s.acmod=a>>1&7,s.lfeon=a&1,s.num_dep_sub=h>>1&15,s.num_dep_sub>0&&(s.chan_loc=(h&1)<<8|e.readUint8())}});n.createFullBoxCtor("dfLa",function(e){var t=127,r=128,s=[],o=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];this.parseFullHeader(e);do{var a=e.readUint8(),h=Math.min(a&t,o.length-1);if(h?e.readUint8Array(e.readUint24()):(e.readUint8Array(13),this.samplerate=e.readUint32()>>12,e.readUint8Array(20)),s.push(o[h]),a&r)break}while(!0);this.numMetadataBlocks=s.length+" ("+s.join(", ")+")"});n.createBoxCtor("dimm",function(e){this.bytessent=e.readUint64()});n.createBoxCtor("dmax",function(e){this.time=e.readUint32()});n.createBoxCtor("dmed",function(e){this.bytessent=e.readUint64()});n.createBoxCtor("dOps",function(e){if(this.Version=e.readUint8(),this.OutputChannelCount=e.readUint8(),this.PreSkip=e.readUint16(),this.InputSampleRate=e.readUint32(),this.OutputGain=e.readInt16(),this.ChannelMappingFamily=e.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=e.readUint8(),this.CoupledCount=e.readUint8(),this.ChannelMapping=[];for(var t=0;t<this.OutputChannelCount;t++)this.ChannelMapping[t]=e.readUint8()}});n.createFullBoxCtor("dref",function(e){var t,r;this.entries=[];for(var s=e.readUint32(),o=0;o<s;o++)if(t=n.parseOneBox(e,!1,this.size-(e.getPosition()-this.start)),t.code===n.OK)r=t.box,this.entries.push(r);else return});n.createBoxCtor("drep",function(e){this.bytessent=e.readUint64()});n.createFullBoxCtor("elng",function(e){this.extended_language=e.readString(this.size-this.hdr_size)});n.createFullBoxCtor("elst",function(e){this.entries=[];for(var t=e.readUint32(),r=0;r<t;r++){var s={};this.entries.push(s),this.version===1?(s.segment_duration=e.readUint64(),s.media_time=e.readInt64()):(s.segment_duration=e.readUint32(),s.media_time=e.readInt32()),s.media_rate_integer=e.readInt16(),s.media_rate_fraction=e.readInt16()}});n.createFullBoxCtor("emsg",function(e){this.version==1?(this.timescale=e.readUint32(),this.presentation_time=e.readUint64(),this.event_duration=e.readUint32(),this.id=e.readUint32(),this.scheme_id_uri=e.readCString(),this.value=e.readCString()):(this.scheme_id_uri=e.readCString(),this.value=e.readCString(),this.timescale=e.readUint32(),this.presentation_time_delta=e.readUint32(),this.event_duration=e.readUint32(),this.id=e.readUint32());var t=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(t-=4),this.message_data=e.readUint8Array(t)});n.createEntityToGroupCtor=function(e,t){n[e+"Box"]=function(r){n.FullBox.call(this,e,r)},n[e+"Box"].prototype=new n.FullBox,n[e+"Box"].prototype.parse=function(r){if(this.parseFullHeader(r),t)t.call(this,r);else for(this.group_id=r.readUint32(),this.num_entities_in_group=r.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var s=r.readUint32();this.entity_ids.push(s)}}};n.createEntityToGroupCtor("aebr");n.createEntityToGroupCtor("afbr");n.createEntityToGroupCtor("albc");n.createEntityToGroupCtor("altr");n.createEntityToGroupCtor("brst");n.createEntityToGroupCtor("dobr");n.createEntityToGroupCtor("eqiv");n.createEntityToGroupCtor("favc");n.createEntityToGroupCtor("fobr");n.createEntityToGroupCtor("iaug");n.createEntityToGroupCtor("pano");n.createEntityToGroupCtor("slid");n.createEntityToGroupCtor("ster");n.createEntityToGroupCtor("tsyn");n.createEntityToGroupCtor("wbbr");n.createEntityToGroupCtor("prgr");n.createFullBoxCtor("esds",function(e){var t=e.readUint8Array(this.size-this.hdr_size);if(this.data=t,typeof oe<"u"){var r=new oe;this.esd=r.parseOneDescriptor(new _(t.buffer,0,_.BIG_ENDIAN))}});n.createBoxCtor("fiel",function(e){this.fieldCount=e.readUint8(),this.fieldOrdering=e.readUint8()});n.createBoxCtor("frma",function(e){this.data_format=e.readString(4)});n.createBoxCtor("ftyp",function(e){var t=this.size-this.hdr_size;this.major_brand=e.readString(4),this.minor_version=e.readUint32(),t-=8,this.compatible_brands=[];for(var r=0;t>=4;)this.compatible_brands[r]=e.readString(4),t-=4,r++});n.createFullBoxCtor("hdlr",function(e){this.version===0&&(e.readUint32(),this.handler=e.readString(4),e.readUint32Array(3),this.name=e.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))});n.createBoxCtor("hvcC",function(e){var t,r,s,o,a;this.configurationVersion=e.readUint8(),a=e.readUint8(),this.general_profile_space=a>>6,this.general_tier_flag=(a&32)>>5,this.general_profile_idc=a&31,this.general_profile_compatibility=e.readUint32(),this.general_constraint_indicator=e.readUint8Array(6),this.general_level_idc=e.readUint8(),this.min_spatial_segmentation_idc=e.readUint16()&4095,this.parallelismType=e.readUint8()&3,this.chroma_format_idc=e.readUint8()&3,this.bit_depth_luma_minus8=e.readUint8()&7,this.bit_depth_chroma_minus8=e.readUint8()&7,this.avgFrameRate=e.readUint16(),a=e.readUint8(),this.constantFrameRate=a>>6,this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var h=e.readUint8();for(t=0;t<h;t++){var l=[];this.nalu_arrays.push(l),a=e.readUint8(),l.completeness=(a&128)>>7,l.nalu_type=a&63;var d=e.readUint16();for(r=0;r<d;r++){var c={};l.push(c),o=e.readUint16(),c.data=e.readUint8Array(o)}}});n.createFullBoxCtor("iinf",function(e){var t;this.version===0?this.entry_count=e.readUint16():this.entry_count=e.readUint32(),this.item_infos=[];for(var r=0;r<this.entry_count;r++)if(t=n.parseOneBox(e,!1,this.size-(e.getPosition()-this.start)),t.code===n.OK)t.box.type!=="infe"&&g.error("BoxParser","Expected 'infe' box, got "+t.box.type),this.item_infos[r]=t.box;else return});n.createFullBoxCtor("iloc",function(e){var t;t=e.readUint8(),this.offset_size=t>>4&15,this.length_size=t&15,t=e.readUint8(),this.base_offset_size=t>>4&15,this.version===1||this.version===2?this.index_size=t&15:this.index_size=0,this.items=[];var r=0;if(this.version<2)r=e.readUint16();else if(this.version===2)r=e.readUint32();else throw"version of iloc box not supported";for(var s=0;s<r;s++){var o={};if(this.items.push(o),this.version<2)o.item_ID=e.readUint16();else if(this.version===2)o.item_ID=e.readUint16();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?o.construction_method=e.readUint16()&15:o.construction_method=0,o.data_reference_index=e.readUint16(),this.base_offset_size){case 0:o.base_offset=0;break;case 4:o.base_offset=e.readUint32();break;case 8:o.base_offset=e.readUint64();break;default:throw"Error reading base offset size"}var a=e.readUint16();o.extents=[];for(var h=0;h<a;h++){var l={};if(o.extents.push(l),this.version===1||this.version===2)switch(this.index_size){case 0:l.extent_index=0;break;case 4:l.extent_index=e.readUint32();break;case 8:l.extent_index=e.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:l.extent_offset=0;break;case 4:l.extent_offset=e.readUint32();break;case 8:l.extent_offset=e.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:l.extent_length=0;break;case 4:l.extent_length=e.readUint32();break;case 8:l.extent_length=e.readUint64();break;default:throw"Error reading extent index"}}}});n.createBoxCtor("imir",function(e){var t=e.readUint8();this.reserved=t>>7,this.axis=t&1});n.createFullBoxCtor("infe",function(e){if((this.version===0||this.version===1)&&(this.item_ID=e.readUint16(),this.item_protection_index=e.readUint16(),this.item_name=e.readCString(),this.content_type=e.readCString(),this.content_encoding=e.readCString()),this.version===1){this.extension_type=e.readString(4),g.warn("BoxParser","Cannot parse extension type"),e.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=e.readUint16():this.version===3&&(this.item_ID=e.readUint32()),this.item_protection_index=e.readUint16(),this.item_type=e.readString(4),this.item_name=e.readCString(),this.item_type==="mime"?(this.content_type=e.readCString(),this.content_encoding=e.readCString()):this.item_type==="uri "&&(this.item_uri_type=e.readCString()))});n.createFullBoxCtor("ipma",function(e){var t,r;for(entry_count=e.readUint32(),this.associations=[],t=0;t<entry_count;t++){var s={};this.associations.push(s),this.version<1?s.id=e.readUint16():s.id=e.readUint32();var o=e.readUint8();for(s.props=[],r=0;r<o;r++){var a=e.readUint8(),h={};s.props.push(h),h.essential=(a&128)>>7===1,this.flags&1?h.property_index=(a&127)<<8|e.readUint8():h.property_index=a&127}}});n.createFullBoxCtor("iref",function(e){var t,r,s;for(this.references=[];e.getPosition()<this.start+this.size;)if(t=n.parseOneBox(e,!0,this.size-(e.getPosition()-this.start)),t.code===n.OK)this.version===0?s=new n.SingleItemTypeReferenceBox(t.type,t.size,t.hdr_size,t.start):s=new n.SingleItemTypeReferenceBoxLarge(t.type,t.size,t.hdr_size,t.start),s.write===n.Box.prototype.write&&s.type!=="mdat"&&(g.warn("BoxParser",s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(e)),s.parse(e),this.references.push(s);else return});n.createBoxCtor("irot",function(e){this.angle=e.readUint8()&3});n.createFullBoxCtor("ispe",function(e){this.image_width=e.readUint32(),this.image_height=e.readUint32()});n.createFullBoxCtor("kind",function(e){this.schemeURI=e.readCString(),this.value=e.readCString()});n.createFullBoxCtor("leva",function(e){var t=e.readUint8();this.levels=[];for(var r=0;r<t;r++){var s={};this.levels[r]=s,s.track_ID=e.readUint32();var o=e.readUint8();switch(s.padding_flag=o>>7,s.assignment_type=o&127,s.assignment_type){case 0:s.grouping_type=e.readString(4);break;case 1:s.grouping_type=e.readString(4),s.grouping_type_parameter=e.readUint32();break;case 2:break;case 3:break;case 4:s.sub_track_id=e.readUint32();break;default:g.warn("BoxParser","Unknown leva assignement type")}}});n.createBoxCtor("lsel",function(e){this.layer_id=e.readUint16()});n.createBoxCtor("maxr",function(e){this.period=e.readUint32(),this.bytes=e.readUint32()});n.createBoxCtor("mdcv",function(e){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=e.readUint16(),this.display_primaries[0].y=e.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=e.readUint16(),this.display_primaries[1].y=e.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=e.readUint16(),this.display_primaries[2].y=e.readUint16(),this.white_point={},this.white_point.x=e.readUint16(),this.white_point.y=e.readUint16(),this.max_display_mastering_luminance=e.readUint32(),this.min_display_mastering_luminance=e.readUint32()});n.createFullBoxCtor("mdhd",function(e){this.version==1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.parseLanguage(e),e.readUint16()});n.createFullBoxCtor("mehd",function(e){this.flags&1&&(g.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=e.readUint64():this.fragment_duration=e.readUint32()});n.createFullBoxCtor("meta",function(e){this.boxes=[],n.ContainerBox.prototype.parse.call(this,e)});n.createFullBoxCtor("mfhd",function(e){this.sequence_number=e.readUint32()});n.createFullBoxCtor("mfro",function(e){this._size=e.readUint32()});n.createFullBoxCtor("mvhd",function(e){this.version==1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.rate=e.readUint32(),this.volume=e.readUint16()>>8,e.readUint16(),e.readUint32Array(2),this.matrix=e.readUint32Array(9),e.readUint32Array(6),this.next_track_id=e.readUint32()});n.createBoxCtor("npck",function(e){this.packetssent=e.readUint32()});n.createBoxCtor("nump",function(e){this.packetssent=e.readUint64()});n.createFullBoxCtor("padb",function(e){var t=e.readUint32();this.padbits=[];for(var r=0;r<Math.floor((t+1)/2);r++)this.padbits=e.readUint8()});n.createBoxCtor("pasp",function(e){this.hSpacing=e.readUint32(),this.vSpacing=e.readUint32()});n.createBoxCtor("payl",function(e){this.text=e.readString(this.size-this.hdr_size)});n.createBoxCtor("payt",function(e){this.payloadID=e.readUint32();var t=e.readUint8();this.rtpmap_string=e.readString(t)});n.createFullBoxCtor("pdin",function(e){var t=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var r=0;r<t;r++)this.rate[r]=e.readUint32(),this.initial_delay[r]=e.readUint32()});n.createFullBoxCtor("pitm",function(e){this.version===0?this.item_id=e.readUint16():this.item_id=e.readUint32()});n.createFullBoxCtor("pixi",function(e){var t;for(this.num_channels=e.readUint8(),this.bits_per_channels=[],t=0;t<this.num_channels;t++)this.bits_per_channels[t]=e.readUint8()});n.createBoxCtor("pmax",function(e){this.bytes=e.readUint32()});n.createFullBoxCtor("prdi",function(e){if(this.step_count=e.readUint16(),this.item_count=[],this.flags&2)for(var t=0;t<this.step_count;t++)this.item_count[t]=e.readUint16()});n.createFullBoxCtor("prft",function(e){this.ref_track_id=e.readUint32(),this.ntp_timestamp=e.readUint64(),this.version===0?this.media_time=e.readUint32():this.media_time=e.readUint64()});n.createFullBoxCtor("pssh",function(e){if(this.system_id=n.parseHex16(e),this.version>0){var t=e.readUint32();this.kid=[];for(var r=0;r<t;r++)this.kid[r]=n.parseHex16(e)}var s=e.readUint32();s>0&&(this.data=e.readUint8Array(s))});n.createFullBoxCtor("clef",function(e){this.width=e.readUint32(),this.height=e.readUint32()});n.createFullBoxCtor("enof",function(e){this.width=e.readUint32(),this.height=e.readUint32()});n.createFullBoxCtor("prof",function(e){this.width=e.readUint32(),this.height=e.readUint32()});n.createContainerBoxCtor("tapt",null,["clef","prof","enof"]);n.createBoxCtor("rtp ",function(e){this.descriptionformat=e.readString(4),this.sdptext=e.readString(this.size-this.hdr_size-4)});n.createFullBoxCtor("saio",function(e){this.flags&1&&(this.aux_info_type=e.readUint32(),this.aux_info_type_parameter=e.readUint32());var t=e.readUint32();this.offset=[];for(var r=0;r<t;r++)this.version===0?this.offset[r]=e.readUint32():this.offset[r]=e.readUint64()});n.createFullBoxCtor("saiz",function(e){this.flags&1&&(this.aux_info_type=e.readUint32(),this.aux_info_type_parameter=e.readUint32()),this.default_sample_info_size=e.readUint8();var t=e.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var r=0;r<t;r++)this.sample_info_size[r]=e.readUint8()});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(e){this.parseHeader(e),this.content_encoding=e.readCString(),this.mime_format=e.readCString(),this.parseFooter(e)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(e){this.parseHeader(e),this.content_encoding=e.readCString(),this.namespace=e.readCString(),this.schema_location=e.readCString(),this.parseFooter(e)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(e){this.parseHeader(e),this.content_encoding=e.readCString(),this.mime_format=e.readCString(),this.parseFooter(e)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(e){this.parseHeader(e),this.namespace=e.readCString(),this.schema_location=e.readCString(),this.auxiliary_mime_types=e.readCString(),this.parseFooter(e)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(e){this.parseHeader(e),this.content_encoding=e.readCString(),this.mime_format=e.readCString(),this.parseFooter(e)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(e){this.parseHeader(e),this.displayFlags=e.readUint32(),this.horizontal_justification=e.readInt8(),this.vertical_justification=e.readInt8(),this.bg_color_rgba=e.readUint8Array(4),this.box_record=e.readInt16Array(4),this.style_record=e.readUint8Array(12),this.parseFooter(e)});n.createSampleEntryCtor(n.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(e){this.parseHeader(e),this.parseFooter(e)});n.createSampleGroupCtor("alst",function(e){var t,r=e.readUint16();for(this.first_output_sample=e.readUint16(),this.sample_offset=[],t=0;t<r;t++)this.sample_offset[t]=e.readUint32();var s=this.description_length-4-4*r;for(this.num_output_samples=[],this.num_total_samples=[],t=0;t<s/4;t++)this.num_output_samples[t]=e.readUint16(),this.num_total_samples[t]=e.readUint16()});n.createSampleGroupCtor("avll",function(e){this.layerNumber=e.readUint8(),this.accurateStatisticsFlag=e.readUint8(),this.avgBitRate=e.readUint16(),this.avgFrameRate=e.readUint16()});n.createSampleGroupCtor("avss",function(e){this.subSequenceIdentifier=e.readUint16(),this.layerNumber=e.readUint8();var t=e.readUint8();this.durationFlag=t>>7,this.avgRateFlag=t>>6&1,this.durationFlag&&(this.duration=e.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=e.readUint8(),this.avgBitRate=e.readUint16(),this.avgFrameRate=e.readUint16()),this.dependency=[];for(var r=e.readUint8(),s=0;s<r;s++){var o={};this.dependency.push(o),o.subSeqDirectionFlag=e.readUint8(),o.layerNumber=e.readUint8(),o.subSequenceIdentifier=e.readUint16()}});n.createSampleGroupCtor("dtrt",function(e){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("mvif",function(e){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("prol",function(e){this.roll_distance=e.readInt16()});n.createSampleGroupCtor("rap ",function(e){var t=e.readUint8();this.num_leading_samples_known=t>>7,this.num_leading_samples=t&127});n.createSampleGroupCtor("rash",function(e){if(this.operation_point_count=e.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)g.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=e.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=e.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var t=0;t<this.operation_point_count;t++)this.available_bitrate[t]=e.readUint32(),this.target_rate_share[t]=e.readUint16()}this.maximum_bitrate=e.readUint32(),this.minimum_bitrate=e.readUint32(),this.discard_priority=e.readUint8()}});n.createSampleGroupCtor("roll",function(e){this.roll_distance=e.readInt16()});n.SampleGroupEntry.prototype.parse=function(e){g.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=e.readUint8Array(this.description_length)};n.createSampleGroupCtor("scif",function(e){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("scnm",function(e){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("seig",function(e){this.reserved=e.readUint8();var t=e.readUint8();this.crypt_byte_block=t>>4,this.skip_byte_block=t&15,this.isProtected=e.readUint8(),this.Per_Sample_IV_Size=e.readUint8(),this.KID=n.parseHex16(e),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=e.readUint8(),this.constant_IV=e.readUint8Array(this.constant_IV_size))});n.createSampleGroupCtor("stsa",function(e){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("sync",function(e){var t=e.readUint8();this.NAL_unit_type=t&63});n.createSampleGroupCtor("tele",function(e){var t=e.readUint8();this.level_independently_decodable=t>>7});n.createSampleGroupCtor("tsas",function(e){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("tscl",function(e){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createSampleGroupCtor("vipr",function(e){g.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});n.createFullBoxCtor("sbgp",function(e){this.grouping_type=e.readString(4),this.version===1?this.grouping_type_parameter=e.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var t=e.readUint32(),r=0;r<t;r++){var s={};this.entries.push(s),s.sample_count=e.readInt32(),s.group_description_index=e.readInt32()}});n.createFullBoxCtor("schm",function(e){this.scheme_type=e.readString(4),this.scheme_version=e.readUint32(),this.flags&1&&(this.scheme_uri=e.readString(this.size-this.hdr_size-8))});n.createBoxCtor("sdp ",function(e){this.sdptext=e.readString(this.size-this.hdr_size)});n.createFullBoxCtor("sdtp",function(e){var t,r=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var s=0;s<r;s++)t=e.readUint8(),this.is_leading[s]=t>>6,this.sample_depends_on[s]=t>>4&3,this.sample_is_depended_on[s]=t>>2&3,this.sample_has_redundancy[s]=t&3});n.createFullBoxCtor("senc");n.createFullBoxCtor("sgpd",function(e){this.grouping_type=e.readString(4),g.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=e.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=e.readUint32()),this.entries=[];for(var t=e.readUint32(),r=0;r<t;r++){var s;n[this.grouping_type+"SampleGroupEntry"]?s=new n[this.grouping_type+"SampleGroupEntry"](this.grouping_type):s=new n.SampleGroupEntry(this.grouping_type),this.entries.push(s),this.version===1?this.default_length===0?s.description_length=e.readUint32():s.description_length=this.default_length:s.description_length=this.default_length,s.write===n.SampleGroupEntry.prototype.write&&(g.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),s.data=e.readUint8Array(s.description_length),e.position-=s.description_length),s.parse(e)}});n.createFullBoxCtor("sidx",function(e){this.reference_ID=e.readUint32(),this.timescale=e.readUint32(),this.version===0?(this.earliest_presentation_time=e.readUint32(),this.first_offset=e.readUint32()):(this.earliest_presentation_time=e.readUint64(),this.first_offset=e.readUint64()),e.readUint16(),this.references=[];for(var t=e.readUint16(),r=0;r<t;r++){var s={};this.references.push(s);var o=e.readUint32();s.reference_type=o>>31&1,s.referenced_size=o&2147483647,s.subsegment_duration=e.readUint32(),o=e.readUint32(),s.starts_with_SAP=o>>31&1,s.SAP_type=o>>28&7,s.SAP_delta_time=o&268435455}});n.SingleItemTypeReferenceBox=function(e,t,r,s){n.Box.call(this,e,t),this.hdr_size=r,this.start=s};n.SingleItemTypeReferenceBox.prototype=new n.Box;n.SingleItemTypeReferenceBox.prototype.parse=function(e){this.from_item_ID=e.readUint16();var t=e.readUint16();this.references=[];for(var r=0;r<t;r++)this.references[r]={},this.references[r].to_item_ID=e.readUint16()};n.SingleItemTypeReferenceBoxLarge=function(e,t,r,s){n.Box.call(this,e,t),this.hdr_size=r,this.start=s};n.SingleItemTypeReferenceBoxLarge.prototype=new n.Box;n.SingleItemTypeReferenceBoxLarge.prototype.parse=function(e){this.from_item_ID=e.readUint32();var t=e.readUint16();this.references=[];for(var r=0;r<t;r++)this.references[r]={},this.references[r].to_item_ID=e.readUint32()};n.createFullBoxCtor("SmDm",function(e){this.primaryRChromaticity_x=e.readUint16(),this.primaryRChromaticity_y=e.readUint16(),this.primaryGChromaticity_x=e.readUint16(),this.primaryGChromaticity_y=e.readUint16(),this.primaryBChromaticity_x=e.readUint16(),this.primaryBChromaticity_y=e.readUint16(),this.whitePointChromaticity_x=e.readUint16(),this.whitePointChromaticity_y=e.readUint16(),this.luminanceMax=e.readUint32(),this.luminanceMin=e.readUint32()});n.createFullBoxCtor("smhd",function(e){this.balance=e.readUint16(),e.readUint16()});n.createFullBoxCtor("ssix",function(e){this.subsegments=[];for(var t=e.readUint32(),r=0;r<t;r++){var s={};this.subsegments.push(s),s.ranges=[];for(var o=e.readUint32(),a=0;a<o;a++){var h={};s.ranges.push(h),h.level=e.readUint8(),h.range_size=e.readUint24()}}});n.createFullBoxCtor("stco",function(e){var t;if(t=e.readUint32(),this.chunk_offsets=[],this.version===0)for(var r=0;r<t;r++)this.chunk_offsets.push(e.readUint32())});n.createFullBoxCtor("stdp",function(e){var t=(this.size-this.hdr_size)/2;this.priority=[];for(var r=0;r<t;r++)this.priority[r]=e.readUint16()});n.createFullBoxCtor("sthd");n.createFullBoxCtor("stri",function(e){this.switch_group=e.readUint16(),this.alternate_group=e.readUint16(),this.sub_track_id=e.readUint32();var t=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var r=0;r<t;r++)this.attribute_list[r]=e.readUint32()});n.createFullBoxCtor("stsc",function(e){var t,r;if(t=e.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(r=0;r<t;r++)this.first_chunk.push(e.readUint32()),this.samples_per_chunk.push(e.readUint32()),this.sample_description_index.push(e.readUint32())});n.createFullBoxCtor("stsd",function(e){var t,r,s,o;for(this.entries=[],s=e.readUint32(),t=1;t<=s;t++)if(r=n.parseOneBox(e,!0,this.size-(e.getPosition()-this.start)),r.code===n.OK)n[r.type+"SampleEntry"]?(o=new n[r.type+"SampleEntry"](r.size),o.hdr_size=r.hdr_size,o.start=r.start):(g.warn("BoxParser","Unknown sample entry type: "+r.type),o=new n.SampleEntry(r.type,r.size,r.hdr_size,r.start)),o.write===n.SampleEntry.prototype.write&&(g.info("BoxParser","SampleEntry "+o.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),o.parseDataAndRewind(e)),o.parse(e),this.entries.push(o);else return});n.createFullBoxCtor("stsg",function(e){this.grouping_type=e.readUint32();var t=e.readUint16();this.group_description_index=[];for(var r=0;r<t;r++)this.group_description_index[r]=e.readUint32()});n.createFullBoxCtor("stsh",function(e){var t,r;if(t=e.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(r=0;r<t;r++)this.shadowed_sample_numbers.push(e.readUint32()),this.sync_sample_numbers.push(e.readUint32())});n.createFullBoxCtor("stss",function(e){var t,r;if(r=e.readUint32(),this.version===0)for(this.sample_numbers=[],t=0;t<r;t++)this.sample_numbers.push(e.readUint32())});n.createFullBoxCtor("stsz",function(e){var t;if(this.sample_sizes=[],this.version===0)for(this.sample_size=e.readUint32(),this.sample_count=e.readUint32(),t=0;t<this.sample_count;t++)this.sample_size===0?this.sample_sizes.push(e.readUint32()):this.sample_sizes[t]=this.sample_size});n.createFullBoxCtor("stts",function(e){var t,r,s;if(t=e.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(r=0;r<t;r++)this.sample_counts.push(e.readUint32()),s=e.readInt32(),s<0&&(g.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)});n.createFullBoxCtor("stvi",function(e){var t=e.readUint32();this.single_view_allowed=t&3,this.stereo_scheme=e.readUint32();var r=e.readUint32();this.stereo_indication_type=e.readString(r);var s,o;for(this.boxes=[];e.getPosition()<this.start+this.size;)if(s=n.parseOneBox(e,!1,this.size-(e.getPosition()-this.start)),s.code===n.OK)o=s.box,this.boxes.push(o),this[o.type]=o;else return});n.createBoxCtor("styp",function(e){n.ftypBox.prototype.parse.call(this,e)});n.createFullBoxCtor("stz2",function(e){var t,r,s;if(this.sample_sizes=[],this.version===0)if(this.reserved=e.readUint24(),this.field_size=e.readUint8(),s=e.readUint32(),this.field_size===4)for(t=0;t<s;t+=2){var o=e.readUint8();this.sample_sizes[t]=o>>4&15,this.sample_sizes[t+1]=o&15}else if(this.field_size===8)for(t=0;t<s;t++)this.sample_sizes[t]=e.readUint8();else if(this.field_size===16)for(t=0;t<s;t++)this.sample_sizes[t]=e.readUint16();else g.error("BoxParser","Error in length field in stz2 box")});n.createFullBoxCtor("subs",function(e){var t,r,s,o;for(s=e.readUint32(),this.entries=[],t=0;t<s;t++){var a={};if(this.entries[t]=a,a.sample_delta=e.readUint32(),a.subsamples=[],o=e.readUint16(),o>0)for(r=0;r<o;r++){var h={};a.subsamples.push(h),this.version==1?h.size=e.readUint32():h.size=e.readUint16(),h.priority=e.readUint8(),h.discardable=e.readUint8(),h.codec_specific_parameters=e.readUint32()}}});n.createFullBoxCtor("tenc",function(e){if(e.readUint8(),this.version===0)e.readUint8();else{var t=e.readUint8();this.default_crypt_byte_block=t>>4&15,this.default_skip_byte_block=t&15}this.default_isProtected=e.readUint8(),this.default_Per_Sample_IV_Size=e.readUint8(),this.default_KID=n.parseHex16(e),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=e.readUint8(),this.default_constant_IV=e.readUint8Array(this.default_constant_IV_size))});n.createFullBoxCtor("tfdt",function(e){this.version==1?this.baseMediaDecodeTime=e.readUint64():this.baseMediaDecodeTime=e.readUint32()});n.createFullBoxCtor("tfhd",function(e){var t=0;this.track_id=e.readUint32(),this.size-this.hdr_size>t&&this.flags&n.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=e.readUint64(),t+=8):this.base_data_offset=0,this.size-this.hdr_size>t&&this.flags&n.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=e.readUint32(),t+=4):this.default_sample_description_index=0,this.size-this.hdr_size>t&&this.flags&n.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=e.readUint32(),t+=4):this.default_sample_duration=0,this.size-this.hdr_size>t&&this.flags&n.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=e.readUint32(),t+=4):this.default_sample_size=0,this.size-this.hdr_size>t&&this.flags&n.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=e.readUint32(),t+=4):this.default_sample_flags=0});n.createFullBoxCtor("tfra",function(e){this.track_ID=e.readUint32(),e.readUint24();var t=e.readUint8();this.length_size_of_traf_num=t>>4&3,this.length_size_of_trun_num=t>>2&3,this.length_size_of_sample_num=t&3,this.entries=[];for(var r=e.readUint32(),s=0;s<r;s++)this.version===1?(this.time=e.readUint64(),this.moof_offset=e.readUint64()):(this.time=e.readUint32(),this.moof_offset=e.readUint32()),this.traf_number=e["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=e["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=e["readUint"+8*(this.length_size_of_sample_num+1)]()});n.createFullBoxCtor("tkhd",function(e){this.version==1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.track_id=e.readUint32(),e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.track_id=e.readUint32(),e.readUint32(),this.duration=e.readUint32()),e.readUint32Array(2),this.layer=e.readInt16(),this.alternate_group=e.readInt16(),this.volume=e.readInt16()>>8,e.readUint16(),this.matrix=e.readInt32Array(9),this.width=e.readUint32(),this.height=e.readUint32()});n.createBoxCtor("tmax",function(e){this.time=e.readUint32()});n.createBoxCtor("tmin",function(e){this.time=e.readUint32()});n.createBoxCtor("totl",function(e){this.bytessent=e.readUint32()});n.createBoxCtor("tpay",function(e){this.bytessent=e.readUint32()});n.createBoxCtor("tpyl",function(e){this.bytessent=e.readUint64()});n.TrackGroupTypeBox.prototype.parse=function(e){this.parseFullHeader(e),this.track_group_id=e.readUint32()};n.createTrackGroupCtor("msrc");n.TrackReferenceTypeBox=function(e,t,r,s){n.Box.call(this,e,t),this.hdr_size=r,this.start=s};n.TrackReferenceTypeBox.prototype=new n.Box;n.TrackReferenceTypeBox.prototype.parse=function(e){this.track_ids=e.readUint32Array((this.size-this.hdr_size)/4)};n.trefBox.prototype.parse=function(e){for(var t,r;e.getPosition()<this.start+this.size;)if(t=n.parseOneBox(e,!0,this.size-(e.getPosition()-this.start)),t.code===n.OK)r=new n.TrackReferenceTypeBox(t.type,t.size,t.hdr_size,t.start),r.write===n.Box.prototype.write&&r.type!=="mdat"&&(g.info("BoxParser","TrackReference "+r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(e)),r.parse(e),this.boxes.push(r);else return};n.createFullBoxCtor("trep",function(e){for(this.track_ID=e.readUint32(),this.boxes=[];e.getPosition()<this.start+this.size;)if(ret=n.parseOneBox(e,!1,this.size-(e.getPosition()-this.start)),ret.code===n.OK)box=ret.box,this.boxes.push(box);else return});n.createFullBoxCtor("trex",function(e){this.track_id=e.readUint32(),this.default_sample_description_index=e.readUint32(),this.default_sample_duration=e.readUint32(),this.default_sample_size=e.readUint32(),this.default_sample_flags=e.readUint32()});n.createBoxCtor("trpy",function(e){this.bytessent=e.readUint64()});n.createFullBoxCtor("trun",function(e){var t=0;if(this.sample_count=e.readUint32(),t+=4,this.size-this.hdr_size>t&&this.flags&n.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=e.readInt32(),t+=4):this.data_offset=0,this.size-this.hdr_size>t&&this.flags&n.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=e.readUint32(),t+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>t)for(var r=0;r<this.sample_count;r++)this.flags&n.TRUN_FLAGS_DURATION&&(this.sample_duration[r]=e.readUint32()),this.flags&n.TRUN_FLAGS_SIZE&&(this.sample_size[r]=e.readUint32()),this.flags&n.TRUN_FLAGS_FLAGS&&(this.sample_flags[r]=e.readUint32()),this.flags&n.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[r]=e.readUint32():this.sample_composition_time_offset[r]=e.readInt32())});n.createFullBoxCtor("tsel",function(e){this.switch_group=e.readUint32();var t=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var r=0;r<t;r++)this.attribute_list[r]=e.readUint32()});n.createFullBoxCtor("txtC",function(e){this.config=e.readCString()});n.createBoxCtor("tyco",function(e){var t=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var r=0;r<t;r++)this.compatible_brands[r]=e.readString(4)});n.createFullBoxCtor("udes",function(e){this.lang=e.readCString(),this.name=e.readCString(),this.description=e.readCString(),this.tags=e.readCString()});n.createFullBoxCtor("uncC",function(e){var t;for(this.profile=e.readUint32(),this.component_count=e.readUint16(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],t=0;t<this.component_count;t++)this.component_index.push(e.readUint16()),this.component_bit_depth_minus_one.push(e.readUint8()),this.component_format.push(e.readUint8()),this.component_align_size.push(e.readUint8());this.sampling_type=e.readUint8(),this.interleave_type=e.readUint8(),this.block_size=e.readUint8();var r=e.readUint8();this.component_little_endian=r>>7&1,this.block_pad_lsb=r>>6&1,this.block_little_endian=r>>5&1,this.block_reversed=r>>4&1,this.pad_unknown=r>>3&1,this.pixel_size=e.readUint8(),this.row_align_size=e.readUint32(),this.tile_align_size=e.readUint32(),this.num_tile_cols_minus_one=e.readUint32(),this.num_tile_rows_minus_one=e.readUint32()});n.createFullBoxCtor("url ",function(e){this.flags!==1&&(this.location=e.readCString())});n.createFullBoxCtor("urn ",function(e){this.name=e.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=e.readCString())});n.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(e){this.LiveServerManifest=e.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")});n.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(e){this.system_id=n.parseHex16(e);var t=e.readUint32();t>0&&(this.data=e.readUint8Array(t))});n.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1);n.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(e){this.default_AlgorithmID=e.readUint24(),this.default_IV_size=e.readUint8(),this.default_KID=n.parseHex16(e)});n.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(e){this.fragment_count=e.readUint8(),this.entries=[];for(var t=0;t<this.fragment_count;t++){var r={},s=0,o=0;this.version===1?(s=e.readUint64(),o=e.readUint64()):(s=e.readUint32(),o=e.readUint32()),r.absolute_time=s,r.absolute_duration=o,this.entries.push(r)}});n.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(e){this.version===1?(this.absolute_time=e.readUint64(),this.duration=e.readUint64()):(this.absolute_time=e.readUint32(),this.duration=e.readUint32())});n.createFullBoxCtor("vmhd",function(e){this.graphicsmode=e.readUint16(),this.opcolor=e.readUint16Array(3)});n.createFullBoxCtor("vpcC",function(e){var t;this.version===1?(this.profile=e.readUint8(),this.level=e.readUint8(),t=e.readUint8(),this.bitDepth=t>>4,this.chromaSubsampling=t>>1&7,this.videoFullRangeFlag=t&1,this.colourPrimaries=e.readUint8(),this.transferCharacteristics=e.readUint8(),this.matrixCoefficients=e.readUint8(),this.codecIntializationDataSize=e.readUint16(),this.codecIntializationData=e.readUint8Array(this.codecIntializationDataSize)):(this.profile=e.readUint8(),this.level=e.readUint8(),t=e.readUint8(),this.bitDepth=t>>4&15,this.colorSpace=t&15,t=e.readUint8(),this.chromaSubsampling=t>>4&15,this.transferFunction=t>>1&7,this.videoFullRangeFlag=t&1,this.codecIntializationDataSize=e.readUint16(),this.codecIntializationData=e.readUint8Array(this.codecIntializationDataSize))});n.createBoxCtor("vttC",function(e){this.text=e.readString(this.size-this.hdr_size)});n.createFullBoxCtor("vvcC",function(e){var t,r,s={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(p){this.held_bits=p.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(p){this.held_bits=p.readUint16(),this.num_held_bits=16},extract_bits:function(p){var y=this.held_bits>>this.num_held_bits-p&(1<<p)-1;return this.num_held_bits-=p,y}};if(s.stream_read_1_bytes(e),s.extract_bits(5),this.lengthSizeMinusOne=s.extract_bits(2),this.ptl_present_flag=s.extract_bits(1),this.ptl_present_flag){s.stream_read_2_bytes(e),this.ols_idx=s.extract_bits(9),this.num_sublayers=s.extract_bits(3),this.constant_frame_rate=s.extract_bits(2),this.chroma_format_idc=s.extract_bits(2),s.stream_read_1_bytes(e),this.bit_depth_minus8=s.extract_bits(3),s.extract_bits(5);{if(s.stream_read_2_bytes(e),s.extract_bits(2),this.num_bytes_constraint_info=s.extract_bits(6),this.general_profile_idc=s.extract_bits(7),this.general_tier_flag=s.extract_bits(1),this.general_level_idc=e.readUint8(),s.stream_read_1_bytes(e),this.ptl_frame_only_constraint_flag=s.extract_bits(1),this.ptl_multilayer_enabled_flag=s.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(t=0;t<this.num_bytes_constraint_info-1;t++){var o=s.extract_bits(6);s.stream_read_1_bytes(e);var a=s.extract_bits(2);this.general_constraint_info[t]=o<<2|a}this.general_constraint_info[this.num_bytes_constraint_info-1]=s.extract_bits(6)}else s.extract_bits(6);if(this.num_sublayers>1){for(s.stream_read_1_bytes(e),this.ptl_sublayer_present_mask=0,r=this.num_sublayers-2;r>=0;--r){var h=s.extract_bits(1);this.ptl_sublayer_present_mask|=h<<r}for(r=this.num_sublayers;r<=8&&this.num_sublayers>1;++r)s.extract_bits(1);for(this.sublayer_level_idc=[],r=this.num_sublayers-2;r>=0;--r)this.ptl_sublayer_present_mask&1<<r&&(this.sublayer_level_idc[r]=e.readUint8())}if(this.ptl_num_sub_profiles=e.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(t=0;t<this.ptl_num_sub_profiles;t++)this.general_sub_profile_idc.push(e.readUint32())}this.max_picture_width=e.readUint16(),this.max_picture_height=e.readUint16(),this.avg_frame_rate=e.readUint16()}var l=12,d=13;this.nalu_arrays=[];var c=e.readUint8();for(t=0;t<c;t++){var f=[];this.nalu_arrays.push(f),s.stream_read_1_bytes(e),f.completeness=s.extract_bits(1),s.extract_bits(2),f.nalu_type=s.extract_bits(5);var m=1;for(f.nalu_type!=d&&f.nalu_type!=l&&(m=e.readUint16()),r=0;r<m;r++){var u=e.readUint16();f.push({data:e.readUint8Array(u),length:u})}}});n.createFullBoxCtor("vvnC",function(e){var t=strm.readUint8();this.lengthSizeMinusOne=t&3});n.SampleEntry.prototype.isVideo=function(){return!1};n.SampleEntry.prototype.isAudio=function(){return!1};n.SampleEntry.prototype.isSubtitle=function(){return!1};n.SampleEntry.prototype.isMetadata=function(){return!1};n.SampleEntry.prototype.isHint=function(){return!1};n.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")};n.SampleEntry.prototype.getWidth=function(){return""};n.SampleEntry.prototype.getHeight=function(){return""};n.SampleEntry.prototype.getChannelCount=function(){return""};n.SampleEntry.prototype.getSampleRate=function(){return""};n.SampleEntry.prototype.getSampleSize=function(){return""};n.VisualSampleEntry.prototype.isVideo=function(){return!0};n.VisualSampleEntry.prototype.getWidth=function(){return this.width};n.VisualSampleEntry.prototype.getHeight=function(){return this.height};n.AudioSampleEntry.prototype.isAudio=function(){return!0};n.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count};n.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate};n.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize};n.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0};n.MetadataSampleEntry.prototype.isMetadata=function(){return!0};n.decimalToHex=function(e,t){var r=Number(e).toString(16);for(t=typeof t>"u"||t===null?t=2:t;r.length<t;)r="0"+r;return r};n.avc1SampleEntry.prototype.getCodec=n.avc2SampleEntry.prototype.getCodec=n.avc3SampleEntry.prototype.getCodec=n.avc4SampleEntry.prototype.getCodec=function(){var e=n.SampleEntry.prototype.getCodec.call(this);return this.avcC?e+"."+n.decimalToHex(this.avcC.AVCProfileIndication)+n.decimalToHex(this.avcC.profile_compatibility)+n.decimalToHex(this.avcC.AVCLevelIndication):e};n.hev1SampleEntry.prototype.getCodec=n.hvc1SampleEntry.prototype.getCodec=function(){var e,t=n.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(t+=".",this.hvcC.general_profile_space){case 0:t+="";break;case 1:t+="A";break;case 2:t+="B";break;case 3:t+="C";break}t+=this.hvcC.general_profile_idc,t+=".";var r=this.hvcC.general_profile_compatibility,s=0;for(e=0;e<32&&(s|=r&1,e!=31);e++)s<<=1,r>>=1;t+=n.decimalToHex(s,0),t+=".",this.hvcC.general_tier_flag===0?t+="L":t+="H",t+=this.hvcC.general_level_idc;var o=!1,a="";for(e=5;e>=0;e--)(this.hvcC.general_constraint_indicator[e]||o)&&(a="."+n.decimalToHex(this.hvcC.general_constraint_indicator[e],0)+a,o=!0);t+=a}return t};n.vvc1SampleEntry.prototype.getCodec=n.vvi1SampleEntry.prototype.getCodec=function(){var e,t=n.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){t+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?t+=".H":t+=".L",t+=this.vvcC.general_level_idc;var r="";if(this.vvcC.general_constraint_info){var s=[],o=0;o|=this.vvcC.ptl_frame_only_constraint<<7,o|=this.vvcC.ptl_multilayer_enabled<<6;var a;for(e=0;e<this.vvcC.general_constraint_info.length;++e)o|=this.vvcC.general_constraint_info[e]>>2&63,s.push(o),o&&(a=e),o=this.vvcC.general_constraint_info[e]>>2&3;if(a===void 0)r=".CA";else{r=".C";var h="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",l=0,d=0;for(e=0;e<=a;++e)for(l=l<<8|s[e],d+=8;d>=5;){var c=l>>d-5&31;r+=h[c],d-=5,l&=(1<<d)-1}d&&(l<<=5-d,r+=h[l&31])}}t+=r}return t};n.mp4aSampleEntry.prototype.getCodec=function(){var e=n.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var t=this.esds.esd.getOTI(),r=this.esds.esd.getAudioConfig();return e+"."+n.decimalToHex(t)+(r?"."+r:"")}else return e};n.stxtSampleEntry.prototype.getCodec=function(){var e=n.SampleEntry.prototype.getCodec.call(this);return this.mime_format?e+"."+this.mime_format:e};n.vp08SampleEntry.prototype.getCodec=n.vp09SampleEntry.prototype.getCodec=function(){var e=n.SampleEntry.prototype.getCodec.call(this),t=this.vpcC.level;t==0&&(t="00");var r=this.vpcC.bitDepth;return r==8&&(r="08"),e+".0"+this.vpcC.profile+"."+t+"."+r};n.av01SampleEntry.prototype.getCodec=function(){var e=n.SampleEntry.prototype.getCodec.call(this),t=this.av1C.seq_level_idx_0;t<10&&(t="0"+t);var r;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?r=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(r=this.av1C.high_bitdepth===1?"10":"08"),e+"."+this.av1C.seq_profile+"."+t+(this.av1C.seq_tier_0?"H":"M")+"."+r};n.Box.prototype.writeHeader=function(e,t){this.size+=8,this.size>H&&(this.size+=8),this.type==="uuid"&&(this.size+=16),g.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+e.getPosition()+(t||"")),this.size>H?e.writeUint32(1):(this.sizePosition=e.getPosition(),e.writeUint32(this.size)),e.writeString(this.type,null,4),this.type==="uuid"&&e.writeUint8Array(this.uuid),this.size>H&&e.writeUint64(this.size)};n.FullBox.prototype.writeHeader=function(e){this.size+=4,n.Box.prototype.writeHeader.call(this,e," v="+this.version+" f="+this.flags),e.writeUint8(this.version),e.writeUint24(this.flags)};n.Box.prototype.write=function(e){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(e),e.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(e),this.data&&e.writeUint8Array(this.data))};n.ContainerBox.prototype.write=function(e){this.size=0,this.writeHeader(e);for(var t=0;t<this.boxes.length;t++)this.boxes[t]&&(this.boxes[t].write(e),this.size+=this.boxes[t].size);g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)};n.TrackReferenceTypeBox.prototype.write=function(e){this.size=this.track_ids.length*4,this.writeHeader(e),e.writeUint32Array(this.track_ids)};n.avcCBox.prototype.write=function(e){var t;for(this.size=7,t=0;t<this.SPS.length;t++)this.size+=2+this.SPS[t].length;for(t=0;t<this.PPS.length;t++)this.size+=2+this.PPS[t].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(e),e.writeUint8(this.configurationVersion),e.writeUint8(this.AVCProfileIndication),e.writeUint8(this.profile_compatibility),e.writeUint8(this.AVCLevelIndication),e.writeUint8(this.lengthSizeMinusOne+252),e.writeUint8(this.SPS.length+224),t=0;t<this.SPS.length;t++)e.writeUint16(this.SPS[t].length),e.writeUint8Array(this.SPS[t].nalu);for(e.writeUint8(this.PPS.length),t=0;t<this.PPS.length;t++)e.writeUint16(this.PPS[t].length),e.writeUint8Array(this.PPS[t].nalu);this.ext&&e.writeUint8Array(this.ext)};n.co64Box.prototype.write=function(e){var t;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(e),e.writeUint32(this.chunk_offsets.length),t=0;t<this.chunk_offsets.length;t++)e.writeUint64(this.chunk_offsets[t])};n.cslgBox.prototype.write=function(e){var t;this.version=0,this.flags=0,this.size=4*5,this.writeHeader(e),e.writeInt32(this.compositionToDTSShift),e.writeInt32(this.leastDecodeToDisplayDelta),e.writeInt32(this.greatestDecodeToDisplayDelta),e.writeInt32(this.compositionStartTime),e.writeInt32(this.compositionEndTime)};n.cttsBox.prototype.write=function(e){var t;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(e),e.writeUint32(this.sample_counts.length),t=0;t<this.sample_counts.length;t++)e.writeUint32(this.sample_counts[t]),this.version===1?e.writeInt32(this.sample_offsets[t]):e.writeUint32(this.sample_offsets[t])};n.drefBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.entries.length);for(var t=0;t<this.entries.length;t++)this.entries[t].write(e),this.size+=this.entries[t].size;g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)};n.elngBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(e),e.writeString(this.extended_language)};n.elstBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(e),e.writeUint32(this.entries.length);for(var t=0;t<this.entries.length;t++){var r=this.entries[t];e.writeUint32(r.segment_duration),e.writeInt32(r.media_time),e.writeInt16(r.media_rate_integer),e.writeInt16(r.media_rate_fraction)}};n.emsgBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(e),e.writeCString(this.scheme_id_uri),e.writeCString(this.value),e.writeUint32(this.timescale),e.writeUint32(this.presentation_time_delta),e.writeUint32(this.event_duration),e.writeUint32(this.id),e.writeUint8Array(this.message_data)};n.ftypBox.prototype.write=function(e){this.size=8+4*this.compatible_brands.length,this.writeHeader(e),e.writeString(this.major_brand,null,4),e.writeUint32(this.minor_version);for(var t=0;t<this.compatible_brands.length;t++)e.writeString(this.compatible_brands[t],null,4)};n.hdlrBox.prototype.write=function(e){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(e),e.writeUint32(0),e.writeString(this.handler,null,4),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeCString(this.name)};n.hvcCBox.prototype.write=function(e){var t,r;for(this.size=23,t=0;t<this.nalu_arrays.length;t++)for(this.size+=3,r=0;r<this.nalu_arrays[t].length;r++)this.size+=2+this.nalu_arrays[t][r].data.length;for(this.writeHeader(e),e.writeUint8(this.configurationVersion),e.writeUint8(this.general_profile_space<<6+this.general_tier_flag<<5+this.general_profile_idc),e.writeUint32(this.general_profile_compatibility),e.writeUint8Array(this.general_constraint_indicator),e.writeUint8(this.general_level_idc),e.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),e.writeUint8(this.parallelismType+252),e.writeUint8(this.chroma_format_idc+252),e.writeUint8(this.bit_depth_luma_minus8+248),e.writeUint8(this.bit_depth_chroma_minus8+248),e.writeUint16(this.avgFrameRate),e.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),e.writeUint8(this.nalu_arrays.length),t=0;t<this.nalu_arrays.length;t++)for(e.writeUint8((this.nalu_arrays[t].completeness<<7)+this.nalu_arrays[t].nalu_type),e.writeUint16(this.nalu_arrays[t].length),r=0;r<this.nalu_arrays[t].length;r++)e.writeUint16(this.nalu_arrays[t][r].data.length),e.writeUint8Array(this.nalu_arrays[t][r].data)};n.kindBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(e),e.writeCString(this.schemeURI),e.writeCString(this.value)};n.mdhdBox.prototype.write=function(e){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(e),e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.timescale),e.writeUint32(this.duration),e.writeUint16(this.language),e.writeUint16(0)};n.mehdBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.fragment_duration)};n.mfhdBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.sequence_number)};n.mvhdBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(e),e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.timescale),e.writeUint32(this.duration),e.writeUint32(this.rate),e.writeUint16(this.volume<<8),e.writeUint16(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32Array(this.matrix),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(this.next_track_id)};n.SampleEntry.prototype.writeHeader=function(e){this.size=8,n.Box.prototype.writeHeader.call(this,e),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint16(this.data_reference_index)};n.SampleEntry.prototype.writeFooter=function(e){for(var t=0;t<this.boxes.length;t++)this.boxes[t].write(e),this.size+=this.boxes[t].size;g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)};n.SampleEntry.prototype.write=function(e){this.writeHeader(e),e.writeUint8Array(this.data),this.size+=this.data.length,g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)};n.VisualSampleEntry.prototype.write=function(e){this.writeHeader(e),this.size+=2*7+6*4+32,e.writeUint16(0),e.writeUint16(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint16(this.width),e.writeUint16(this.height),e.writeUint32(this.horizresolution),e.writeUint32(this.vertresolution),e.writeUint32(0),e.writeUint16(this.frame_count),e.writeUint8(Math.min(31,this.compressorname.length)),e.writeString(this.compressorname,null,31),e.writeUint16(this.depth),e.writeInt16(-1),this.writeFooter(e)};n.AudioSampleEntry.prototype.write=function(e){this.writeHeader(e),this.size+=2*4+3*4,e.writeUint32(0),e.writeUint32(0),e.writeUint16(this.channel_count),e.writeUint16(this.samplesize),e.writeUint16(0),e.writeUint16(0),e.writeUint32(this.samplerate<<16),this.writeFooter(e)};n.stppSampleEntry.prototype.write=function(e){this.writeHeader(e),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,e.writeCString(this.namespace),e.writeCString(this.schema_location),e.writeCString(this.auxiliary_mime_types),this.writeFooter(e)};n.SampleGroupEntry.prototype.write=function(e){e.writeUint8Array(this.data)};n.sbgpBox.prototype.write=function(e){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(e),e.writeString(this.grouping_type,null,4),e.writeUint32(this.grouping_type_parameter),e.writeUint32(this.entries.length);for(var t=0;t<this.entries.length;t++){var r=this.entries[t];e.writeInt32(r.sample_count),e.writeInt32(r.group_description_index)}};n.sgpdBox.prototype.write=function(e){var t,r;for(this.flags=0,this.size=12,t=0;t<this.entries.length;t++)r=this.entries[t],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=r.data.length);for(this.writeHeader(e),e.writeString(this.grouping_type,null,4),this.version===1&&e.writeUint32(this.default_length),this.version>=2&&e.writeUint32(this.default_sample_description_index),e.writeUint32(this.entries.length),t=0;t<this.entries.length;t++)r=this.entries[t],this.version===1&&this.default_length===0&&e.writeUint32(r.description_length),r.write(e)};n.sidxBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(e),e.writeUint32(this.reference_ID),e.writeUint32(this.timescale),e.writeUint32(this.earliest_presentation_time),e.writeUint32(this.first_offset),e.writeUint16(0),e.writeUint16(this.references.length);for(var t=0;t<this.references.length;t++){var r=this.references[t];e.writeUint32(r.reference_type<<31|r.referenced_size),e.writeUint32(r.subsegment_duration),e.writeUint32(r.starts_with_SAP<<31|r.SAP_type<<28|r.SAP_delta_time)}};n.smhdBox.prototype.write=function(e){var t;this.version=0,this.flags=1,this.size=4,this.writeHeader(e),e.writeUint16(this.balance),e.writeUint16(0)};n.stcoBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(e),e.writeUint32(this.chunk_offsets.length),e.writeUint32Array(this.chunk_offsets)};n.stscBox.prototype.write=function(e){var t;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(e),e.writeUint32(this.first_chunk.length),t=0;t<this.first_chunk.length;t++)e.writeUint32(this.first_chunk[t]),e.writeUint32(this.samples_per_chunk[t]),e.writeUint32(this.sample_description_index[t])};n.stsdBox.prototype.write=function(e){var t;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(e),e.writeUint32(this.entries.length),this.size+=4,t=0;t<this.entries.length;t++)this.entries[t].write(e),this.size+=this.entries[t].size;g.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)};n.stshBox.prototype.write=function(e){var t;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(e),e.writeUint32(this.shadowed_sample_numbers.length),t=0;t<this.shadowed_sample_numbers.length;t++)e.writeUint32(this.shadowed_sample_numbers[t]),e.writeUint32(this.sync_sample_numbers[t])};n.stssBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(e),e.writeUint32(this.sample_numbers.length),e.writeUint32Array(this.sample_numbers)};n.stszBox.prototype.write=function(e){var t,r=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(t=0;t+1<this.sample_sizes.length;)if(this.sample_sizes[t+1]!==this.sample_sizes[0]){r=!1;break}else t++;else r=!1;this.size=8,r||(this.size+=4*this.sample_sizes.length),this.writeHeader(e),r?e.writeUint32(this.sample_sizes[0]):e.writeUint32(0),e.writeUint32(this.sample_sizes.length),r||e.writeUint32Array(this.sample_sizes)};n.sttsBox.prototype.write=function(e){var t;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(e),e.writeUint32(this.sample_counts.length),t=0;t<this.sample_counts.length;t++)e.writeUint32(this.sample_counts[t]),e.writeUint32(this.sample_deltas[t])};n.tfdtBox.prototype.write=function(e){var t=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>t?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(e),this.version===1?e.writeUint64(this.baseMediaDecodeTime):e.writeUint32(this.baseMediaDecodeTime)};n.tfhdBox.prototype.write=function(e){this.version=0,this.size=4,this.flags&n.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&n.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&n.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&n.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&n.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(e),e.writeUint32(this.track_id),this.flags&n.TFHD_FLAG_BASE_DATA_OFFSET&&e.writeUint64(this.base_data_offset),this.flags&n.TFHD_FLAG_SAMPLE_DESC&&e.writeUint32(this.default_sample_description_index),this.flags&n.TFHD_FLAG_SAMPLE_DUR&&e.writeUint32(this.default_sample_duration),this.flags&n.TFHD_FLAG_SAMPLE_SIZE&&e.writeUint32(this.default_sample_size),this.flags&n.TFHD_FLAG_SAMPLE_FLAGS&&e.writeUint32(this.default_sample_flags)};n.tkhdBox.prototype.write=function(e){this.version=0,this.size=4*18+2*4,this.writeHeader(e),e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.track_id),e.writeUint32(0),e.writeUint32(this.duration),e.writeUint32(0),e.writeUint32(0),e.writeInt16(this.layer),e.writeInt16(this.alternate_group),e.writeInt16(this.volume<<8),e.writeUint16(0),e.writeInt32Array(this.matrix),e.writeUint32(this.width),e.writeUint32(this.height)};n.trexBox.prototype.write=function(e){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(e),e.writeUint32(this.track_id),e.writeUint32(this.default_sample_description_index),e.writeUint32(this.default_sample_duration),e.writeUint32(this.default_sample_size),e.writeUint32(this.default_sample_flags)};n.trunBox.prototype.write=function(e){this.version=0,this.size=4,this.flags&n.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&n.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&n.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&n.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&n.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&n.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(e),e.writeUint32(this.sample_count),this.flags&n.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=e.getPosition(),e.writeInt32(this.data_offset)),this.flags&n.TRUN_FLAGS_FIRST_FLAG&&e.writeUint32(this.first_sample_flags);for(var t=0;t<this.sample_count;t++)this.flags&n.TRUN_FLAGS_DURATION&&e.writeUint32(this.sample_duration[t]),this.flags&n.TRUN_FLAGS_SIZE&&e.writeUint32(this.sample_size[t]),this.flags&n.TRUN_FLAGS_FLAGS&&e.writeUint32(this.sample_flags[t]),this.flags&n.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?e.writeUint32(this.sample_composition_time_offset[t]):e.writeInt32(this.sample_composition_time_offset[t]))};n["url Box"].prototype.write=function(e){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(e),this.location&&e.writeCString(this.location)};n["urn Box"].prototype.write=function(e){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(e),e.writeCString(this.name),this.location&&e.writeCString(this.location)};n.vmhdBox.prototype.write=function(e){var t;this.version=0,this.flags=1,this.size=8,this.writeHeader(e),e.writeUint16(this.graphicsmode),e.writeUint16Array(this.opcolor)};n.cttsBox.prototype.unpack=function(e){var t,r,s;for(s=0,t=0;t<this.sample_counts.length;t++)for(r=0;r<this.sample_counts[t];r++)e[s].pts=e[s].dts+this.sample_offsets[t],s++};n.sttsBox.prototype.unpack=function(e){var t,r,s;for(s=0,t=0;t<this.sample_counts.length;t++)for(r=0;r<this.sample_counts[t];r++)s===0?e[s].dts=0:e[s].dts=e[s-1].dts+this.sample_deltas[t],s++};n.stcoBox.prototype.unpack=function(e){var t;for(t=0;t<this.chunk_offsets.length;t++)e[t].offset=this.chunk_offsets[t]};n.stscBox.prototype.unpack=function(e){var t,r,s,o,a;for(o=0,a=0,t=0;t<this.first_chunk.length;t++)for(r=0;r<(t+1<this.first_chunk.length?this.first_chunk[t+1]:1/0);r++)for(a++,s=0;s<this.samples_per_chunk[t];s++){if(e[o])e[o].description_index=this.sample_description_index[t],e[o].chunk_index=a;else return;o++}};n.stszBox.prototype.unpack=function(e){var t;for(t=0;t<this.sample_sizes.length;t++)e[t].size=this.sample_sizes[t]};n.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"];n.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"];n.boxEqualFields=function(e,t){if(e&&!t)return!1;var r;for(r in e)if(!(n.DIFF_BOXES_PROP_NAMES.indexOf(r)>-1)){if(e[r]instanceof n.Box||t[r]instanceof n.Box)continue;if(typeof e[r]>"u"||typeof t[r]>"u")continue;if(typeof e[r]=="function"||typeof t[r]=="function")continue;if(e.subBoxNames&&e.subBoxNames.indexOf(r.slice(0,4))>-1||t.subBoxNames&&t.subBoxNames.indexOf(r.slice(0,4))>-1)continue;if(r==="data"||r==="start"||r==="size"||r==="creation_time"||r==="modification_time")continue;if(n.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(r)>-1)continue;if(e[r]!==t[r])return!1}return!0};n.boxEqual=function(e,t){if(!n.boxEqualFields(e,t))return!1;for(var r=0;r<n.DIFF_BOXES_PROP_NAMES.length;r++){var s=n.DIFF_BOXES_PROP_NAMES[r];if(e[s]&&t[s]&&!n.boxEqual(e[s],t[s]))return!1}return!0};var Se=function(){};Se.prototype.parseSample=function(e){var t,r,s=new B(e.buffer);for(t=[];!s.isEos();)r=n.parseOneBox(s,!1),r.code===n.OK&&r.box.type==="vttc"&&t.push(r.box);return t};Se.prototype.getText=function(e,t,r){function s(c,f,m){return m=m||"0",c=c+"",c.length>=f?c:new Array(f-c.length+1).join(m)+c}function o(c){var f=Math.floor(c/3600),m=Math.floor((c-f*3600)/60),u=Math.floor(c-f*3600-m*60),p=Math.floor((c-f*3600-m*60-u)*1e3);return""+s(f,2)+":"+s(m,2)+":"+s(u,2)+"."+s(p,3)}for(var a=this.parseSample(r),h="",l=0;l<a.length;l++){var d=a[l];h+=o(e)+" --> "+o(t)+`\r
`,h+=d.payl.text}return h};var we=function(){};we.prototype.parseSample=function(e){var t={},r;t.resources=[];var s=new B(e.data.buffer);if(!e.subsamples||e.subsamples.length===0)t.documentString=s.readString(e.data.length);else if(t.documentString=s.readString(e.subsamples[0].size),e.subsamples.length>1)for(r=1;r<e.subsamples.length;r++)t.resources[r]=s.readUint8Array(e.subsamples[r].size);return typeof DOMParser<"u"&&(t.document=new DOMParser().parseFromString(t.documentString,"application/xml")),t};var ae=function(){};ae.prototype.parseSample=function(e){var t,r=new B(e.data.buffer);return t=r.readString(e.data.length),t};ae.prototype.parseConfig=function(e){var t,r=new B(e.buffer);return r.readUint32(),t=r.readCString(),t};typeof I<"u"&&(I.XMLSubtitlein4Parser=we,I.Textin4Parser=ae);var v=function(e){this.stream=e||new F,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};v.prototype.setSegmentOptions=function(e,t,r){var s=this.getTrackById(e);if(s){var o={};this.fragmentedTracks.push(o),o.id=e,o.user=t,o.trak=s,s.nextSample=0,o.segmentStream=null,o.nb_samples=1e3,o.rapAlignement=!0,r&&(r.nbSamples&&(o.nb_samples=r.nbSamples),r.rapAlignement&&(o.rapAlignement=r.rapAlignement))}};v.prototype.unsetSegmentOptions=function(e){for(var t=-1,r=0;r<this.fragmentedTracks.length;r++){var s=this.fragmentedTracks[r];s.id==e&&(t=r)}t>-1&&this.fragmentedTracks.splice(t,1)};v.prototype.setExtractionOptions=function(e,t,r){var s=this.getTrackById(e);if(s){var o={};this.extractedTracks.push(o),o.id=e,o.user=t,o.trak=s,s.nextSample=0,o.nb_samples=1e3,o.samples=[],r&&r.nbSamples&&(o.nb_samples=r.nbSamples)}};v.prototype.unsetExtractionOptions=function(e){for(var t=-1,r=0;r<this.extractedTracks.length;r++){var s=this.extractedTracks[r];s.id==e&&(t=r)}t>-1&&this.extractedTracks.splice(t,1)};v.prototype.parse=function(){var e,t,r,s=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=n.parseOneBox(this.stream,s),t.code===n.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var o;switch(r=t.box,o=r.type!=="uuid"?r.type:r.uuid,this.boxes.push(r),o){case"mdat":this.mdats.push(r);break;case"moof":this.moofs.push(r);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[o]!==void 0&&g.warn("ISOFile","Duplicate Box of type: "+o+", overriding previous occurrence"),this[o]=r;break}this.updateUsedBytes&&this.updateUsedBytes(r,t)}};v.prototype.checkBuffer=function(e){if(e==null)throw"Buffer must be defined and non empty";if(e.fileStart===void 0)throw"Buffer must have a fileStart property";return e.byteLength===0?(g.warn("ISOFile","Ignoring empty buffer (fileStart: "+e.fileStart+")"),this.stream.logBufferLevel(),!1):(g.info("ISOFile","Processing buffer (fileStart: "+e.fileStart+")"),e.usedBytes=0,this.stream.insertBuffer(e),this.stream.logBufferLevel(),this.stream.initialized()?!0:(g.warn("ISOFile","Not ready to start parsing"),!1))};v.prototype.appendBuffer=function(e,t){var r;if(this.checkBuffer(e))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(t),this.nextSeekPosition?(r=this.nextSeekPosition,this.nextSeekPosition=void 0):r=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(r=this.stream.getEndFilePositionAfter(r))):this.nextParsePosition?r=this.nextParsePosition:r=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(g.info("ISOFile","Done processing buffer (fileStart: "+e.fileStart+") - next buffer to fetch should have a fileStart position of "+r),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),g.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),r};v.prototype.getInfo=function(){var e,t,r={},s,o,a,h,l=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(r.hasMoov=!0,r.duration=this.moov.mvhd.duration,r.timescale=this.moov.mvhd.timescale,r.isFragmented=this.moov.mvex!=null,r.isFragmented&&this.moov.mvex.mehd&&(r.fragment_duration=this.moov.mvex.mehd.fragment_duration),r.isProgressive=this.isProgressive,r.hasIOD=this.moov.iods!=null,r.brands=[],r.brands.push(this.ftyp.major_brand),r.brands=r.brands.concat(this.ftyp.compatible_brands),r.created=new Date(l+this.moov.mvhd.creation_time*1e3),r.modified=new Date(l+this.moov.mvhd.modification_time*1e3),r.tracks=[],r.audioTracks=[],r.videoTracks=[],r.subtitleTracks=[],r.metadataTracks=[],r.hintTracks=[],r.otherTracks=[],e=0;e<this.moov.traks.length;e++){if(s=this.moov.traks[e],h=s.mdia.minf.stbl.stsd.entries[0],o={},r.tracks.push(o),o.id=s.tkhd.track_id,o.name=s.mdia.hdlr.name,o.references=[],s.tref)for(t=0;t<s.tref.boxes.length;t++)a={},o.references.push(a),a.type=s.tref.boxes[t].type,a.track_ids=s.tref.boxes[t].track_ids;s.edts&&(o.edits=s.edts.elst.entries),o.created=new Date(l+s.tkhd.creation_time*1e3),o.modified=new Date(l+s.tkhd.modification_time*1e3),o.movie_duration=s.tkhd.duration,o.movie_timescale=r.timescale,o.layer=s.tkhd.layer,o.alternate_group=s.tkhd.alternate_group,o.volume=s.tkhd.volume,o.matrix=s.tkhd.matrix,o.track_width=s.tkhd.width/65536,o.track_height=s.tkhd.height/65536,o.timescale=s.mdia.mdhd.timescale,o.cts_shift=s.mdia.minf.stbl.cslg,o.duration=s.mdia.mdhd.duration,o.samples_duration=s.samples_duration,o.codec=h.getCodec(),o.kind=s.udta&&s.udta.kinds.length?s.udta.kinds[0]:{schemeURI:"",value:""},o.language=s.mdia.elng?s.mdia.elng.extended_language:s.mdia.mdhd.languageString,o.nb_samples=s.samples.length,o.size=s.samples_size,o.bitrate=o.size*8*o.timescale/o.samples_duration,h.isAudio()?(o.type="audio",r.audioTracks.push(o),o.audio={},o.audio.sample_rate=h.getSampleRate(),o.audio.channel_count=h.getChannelCount(),o.audio.sample_size=h.getSampleSize()):h.isVideo()?(o.type="video",r.videoTracks.push(o),o.video={},o.video.width=h.getWidth(),o.video.height=h.getHeight()):h.isSubtitle()?(o.type="subtitles",r.subtitleTracks.push(o)):h.isHint()?(o.type="metadata",r.hintTracks.push(o)):h.isMetadata()?(o.type="metadata",r.metadataTracks.push(o)):(o.type="metadata",r.otherTracks.push(o))}else r.hasMoov=!1;if(r.mime="",r.hasMoov&&r.tracks){for(r.videoTracks&&r.videoTracks.length>0?r.mime+='video/mp4; codecs="':r.audioTracks&&r.audioTracks.length>0?r.mime+='audio/mp4; codecs="':r.mime+='application/mp4; codecs="',e=0;e<r.tracks.length;e++)e!==0&&(r.mime+=","),r.mime+=r.tracks[e].codec;r.mime+='"; profiles="',r.mime+=this.ftyp.compatible_brands.join(),r.mime+='"'}return r};v.prototype.setNextSeekPositionFromSample=function(e){e&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(e.offset+e.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=e.offset+e.alreadyRead)};v.prototype.processSamples=function(e){var t,r;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(t=0;t<this.fragmentedTracks.length;t++){var s=this.fragmentedTracks[t];for(r=s.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){g.debug("ISOFile","Creating media fragment on track #"+s.id+" for sample "+r.nextSample);var o=this.createFragment(s.id,r.nextSample,s.segmentStream);if(o)s.segmentStream=o,r.nextSample++;else break;if((r.nextSample%s.nb_samples===0||e||r.nextSample>=r.samples.length)&&(g.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,r.nextSample-s.nb_samples)+","+(r.nextSample-1)+"]"),g.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,r.nextSample,e||r.nextSample>=r.samples.length),s.segmentStream=null,s!==this.fragmentedTracks[t]))break}}if(this.onSamples!==null)for(t=0;t<this.extractedTracks.length;t++){var a=this.extractedTracks[t];for(r=a.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){g.debug("ISOFile","Exporting on track #"+a.id+" sample #"+r.nextSample);var h=this.getSample(r,r.nextSample);if(h)r.nextSample++,a.samples.push(h);else{this.setNextSeekPositionFromSample(r.samples[r.nextSample]);break}if((r.nextSample%a.nb_samples===0||r.nextSample>=r.samples.length)&&(g.debug("ISOFile","Sending samples on track #"+a.id+" for sample "+r.nextSample),this.onSamples&&this.onSamples(a.id,a.user,a.samples),a.samples=[],a!==this.extractedTracks[t]))break}}}};v.prototype.getBox=function(e){var t=this.getBoxes(e,!0);return t.length?t[0]:null};v.prototype.getBoxes=function(e,t){var r=[];return v._sweep.call(this,e,r,t),r};v._sweep=function(e,t,r){this.type&&this.type==e&&t.push(this);for(var s in this.boxes){if(t.length&&r)return;v._sweep.call(this.boxes[s],e,t,r)}};v.prototype.getTrackSamplesInfo=function(e){var t=this.getTrackById(e);if(t)return t.samples};v.prototype.getTrackSample=function(e,t){var r=this.getTrackById(e),s=this.getSample(r,t);return s};v.prototype.releaseUsedSamples=function(e,t){var r=0,s=this.getTrackById(e);s.lastValidSample||(s.lastValidSample=0);for(var o=s.lastValidSample;o<t;o++)r+=this.releaseSample(s,o);g.info("ISOFile","Track #"+e+" released samples up to "+t+" (released size: "+r+", remaining: "+this.samplesDataSize+")"),s.lastValidSample=t};v.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)};v.prototype.stop=function(){this.sampleProcessingStarted=!1};v.prototype.flush=function(){g.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)};v.prototype.seekTrack=function(e,t,r){var s,o,a=1/0,h=0,l=0,d;if(r.samples.length===0)return g.info("ISOFile","No sample in track, cannot seek! Using time "+g.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(s=0;s<r.samples.length;s++){if(o=r.samples[s],s===0)l=0,d=o.timescale;else if(o.cts>e*o.timescale){l=s-1;break}t&&o.is_sync&&(h=s)}for(t&&(l=h),e=r.samples[l].cts,r.nextSample=l;r.samples[l].alreadyRead===r.samples[l].size&&r.samples[l+1];)l++;return a=r.samples[l].offset+r.samples[l].alreadyRead,g.info("ISOFile","Seeking to "+(t?"RAP":"")+" sample #"+r.nextSample+" on track "+r.tkhd.track_id+", time "+g.getDurationString(e,d)+" and offset: "+a),{offset:a,time:e/d}};v.prototype.getTrackDuration=function(e){var t;return e.samples?(t=e.samples[e.samples.length-1],(t.cts+t.duration)/t.timescale):1/0};v.prototype.seek=function(e,t){var r=this.moov,s,o,a,h={offset:1/0,time:1/0};if(this.moov){for(a=0;a<r.traks.length;a++)s=r.traks[a],!(e>this.getTrackDuration(s))&&(o=this.seekTrack(e,t,s),o.offset<h.offset&&(h.offset=o.offset),o.time<h.time&&(h.time=o.time));return g.info("ISOFile","Seeking at time "+g.getDurationString(h.time,1)+" needs a buffer with a fileStart position of "+h.offset),h.offset===1/0?h={offset:this.nextParsePosition,time:0}:h.offset=this.stream.getEndFilePositionAfter(h.offset),g.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+h.offset),h}else throw"Cannot seek: moov not received!"};v.prototype.equal=function(e){for(var t=0;t<this.boxes.length&&t<e.boxes.length;){var r=this.boxes[t],s=e.boxes[t];if(!n.boxEqual(r,s))return!1;t++}return!0};typeof I<"u"&&(I.ISOFile=v);v.prototype.lastBoxStartPosition=0;v.prototype.parsingMdat=null;v.prototype.nextParsePosition=0;v.prototype.discardMdatData=!1;v.prototype.processIncompleteBox=function(e){var t,r,s;return e.type==="mdat"?(t=new n[e.type+"Box"](e.size),this.parsingMdat=t,this.boxes.push(t),this.mdats.push(t),t.start=e.start,t.hdr_size=e.hdr_size,this.stream.addUsedBytes(t.hdr_size),this.lastBoxStartPosition=t.start+t.size,s=this.stream.seek(t.start+t.size,!1,this.discardMdatData),s?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=t.start+t.size,!1)):(e.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),r=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,r?(this.nextParsePosition=this.stream.getEndPosition(),!0):(e.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+e.size:this.nextParsePosition=this.stream.getEndPosition(),!1))};v.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null};v.prototype.processIncompleteMdat=function(){var e,t;return e=this.parsingMdat,t=this.stream.seek(e.start+e.size,!1,this.discardMdatData),t?(g.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)};v.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)};v.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()};v.prototype.updateUsedBytes=function(e,t){this.stream.addUsedBytes&&(e.type==="mdat"?(this.stream.addUsedBytes(e.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(e.size-e.hdr_size)):this.stream.addUsedBytes(e.size))};v.prototype.add=n.Box.prototype.add;v.prototype.addBox=n.Box.prototype.addBox;v.prototype.init=function(e){var t=e||{},r=this.add("ftyp").set("major_brand",t.brands&&t.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",t.brands||["iso4"]),s=this.add("moov");return s.add("mvhd").set("timescale",t.timescale||600).set("rate",t.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",t.duration||0).set("volume",t.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),s.add("mvex"),this};v.prototype.addTrack=function(e){this.moov||this.init(e);var t=e||{};t.width=t.width||320,t.height=t.height||320,t.id=t.id||this.moov.mvhd.next_track_id,t.type=t.type||"avc1";var r=this.moov.add("trak");this.moov.mvhd.next_track_id=t.id+1,r.add("tkhd").set("flags",n.TKHD_FLAG_ENABLED|n.TKHD_FLAG_IN_MOVIE|n.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",t.id).set("duration",t.duration||0).set("layer",t.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",t.width<<16).set("height",t.height<<16);var s=r.add("mdia");s.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",t.timescale||1).set("duration",t.media_duration||0).set("language",t.language||"und"),s.add("hdlr").set("handler",t.hdlr||"vide").set("name",t.name||"Track created with MP4Box.js"),s.add("elng").set("extended_language",t.language||"fr-FR");var o=s.add("minf");if(n[t.type+"SampleEntry"]!==void 0){var a=new n[t.type+"SampleEntry"];a.data_reference_index=1;var h="";for(var l in n.sampleEntryCodes)for(var d=n.sampleEntryCodes[l],c=0;c<d.length;c++)if(d.indexOf(t.type)>-1){h=l;break}switch(h){case"Visual":if(o.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),a.set("width",t.width).set("height",t.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",t.type+" Compressor").set("depth",24),t.avcDecoderConfigRecord){var f=new n.avcCBox;f.parse(new B(t.avcDecoderConfigRecord)),a.addBox(f)}else if(t.hevcDecoderConfigRecord){var m=new n.hvcCBox;m.parse(new B(t.hevcDecoderConfigRecord)),a.addBox(m)}break;case"Audio":o.add("smhd").set("balance",t.balance||0),a.set("channel_count",t.channel_count||2).set("samplesize",t.samplesize||16).set("samplerate",t.samplerate||65536);break;case"Hint":o.add("hmhd");break;case"Subtitle":switch(o.add("sthd"),t.type){case"stpp":a.set("namespace",t.namespace||"nonamespace").set("schema_location",t.schema_location||"").set("auxiliary_mime_types",t.auxiliary_mime_types||"");break}break;case"Metadata":o.add("nmhd");break;case"System":o.add("nmhd");break;default:o.add("nmhd");break}t.description&&a.addBox(t.description),t.description_boxes&&t.description_boxes.forEach(function(p){a.addBox(p)}),o.add("dinf").add("dref").addEntry(new n["url Box"]().set("flags",1));var u=o.add("stbl");return u.add("stsd").addEntry(a),u.add("stts").set("sample_counts",[]).set("sample_deltas",[]),u.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),u.add("stco").set("chunk_offsets",[]),u.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",t.id).set("default_sample_description_index",t.default_sample_description_index||1).set("default_sample_duration",t.default_sample_duration||0).set("default_sample_size",t.default_sample_size||0).set("default_sample_flags",t.default_sample_flags||0),this.buildTrakSampleLists(r),t.id}};n.Box.prototype.computeSize=function(e){var t=e||new _;t.endianness=_.BIG_ENDIAN,this.write(t)};v.prototype.addSample=function(e,t,r){var s=r||{},o={},a=this.getTrackById(e);if(a!==null){o.number=a.samples.length,o.track_id=a.tkhd.track_id,o.timescale=a.mdia.mdhd.timescale,o.description_index=s.sample_description_index?s.sample_description_index-1:0,o.description=a.mdia.minf.stbl.stsd.entries[o.description_index],o.data=t,o.size=t.byteLength,o.alreadyRead=o.size,o.duration=s.duration||1,o.cts=s.cts||0,o.dts=s.dts||0,o.is_sync=s.is_sync||!1,o.is_leading=s.is_leading||0,o.depends_on=s.depends_on||0,o.is_depended_on=s.is_depended_on||0,o.has_redundancy=s.has_redundancy||0,o.degradation_priority=s.degradation_priority||0,o.offset=0,o.subsamples=s.subsamples,a.samples.push(o),a.samples_size+=o.size,a.samples_duration+=o.duration,a.first_dts===void 0&&(a.first_dts=s.dts),this.processSamples();var h=this.createSingleSampleMoof(o);return this.addBox(h),h.computeSize(),h.trafs[0].truns[0].data_offset=h.size+8,this.add("mdat").data=new Uint8Array(t),o}};v.prototype.createSingleSampleMoof=function(e){var t=0;e.is_sync?t=1<<25:t=65536;var r=new n.moofBox;r.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var s=r.add("traf"),o=this.getTrackById(e.track_id);return s.add("tfhd").set("track_id",e.track_id).set("flags",n.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),s.add("tfdt").set("baseMediaDecodeTime",e.dts-(o.first_dts||0)),s.add("trun").set("flags",n.TRUN_FLAGS_DATA_OFFSET|n.TRUN_FLAGS_DURATION|n.TRUN_FLAGS_SIZE|n.TRUN_FLAGS_FLAGS|n.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[e.duration]).set("sample_size",[e.size]).set("sample_flags",[t]).set("sample_composition_time_offset",[e.cts-e.dts]),r};v.prototype.lastMoofIndex=0;v.prototype.samplesDataSize=0;v.prototype.resetTables=function(){var e,t,r,s,o,a,h,l;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,e=0;e<this.moov.traks.length;e++){t=this.moov.traks[e],t.tkhd.duration=0,t.mdia.mdhd.duration=0,r=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,r.chunk_offsets=[],s=t.mdia.minf.stbl.stsc,s.first_chunk=[],s.samples_per_chunk=[],s.sample_description_index=[],o=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,o.sample_sizes=[],a=t.mdia.minf.stbl.stts,a.sample_counts=[],a.sample_deltas=[],h=t.mdia.minf.stbl.ctts,h&&(h.sample_counts=[],h.sample_offsets=[]),l=t.mdia.minf.stbl.stss;var d=t.mdia.minf.stbl.boxes.indexOf(l);d!=-1&&(t.mdia.minf.stbl.boxes[d]=null)}};v.initSampleGroups=function(e,t,r,s,o){var a,h,l,d,c;function f(m,u,p){this.grouping_type=m,this.grouping_type_parameter=u,this.sbgp=p,this.last_sample_in_run=-1,this.entry_index=-1}for(t&&(t.sample_groups_info=[]),e.sample_groups_info||(e.sample_groups_info=[]),h=0;h<r.length;h++){for(c=r[h].grouping_type+"/"+r[h].grouping_type_parameter,d=new f(r[h].grouping_type,r[h].grouping_type_parameter,r[h]),t&&(t.sample_groups_info[c]=d),e.sample_groups_info[c]||(e.sample_groups_info[c]=d),a=0;a<s.length;a++)s[a].grouping_type===r[h].grouping_type&&(d.description=s[a],d.description.used=!0);if(o)for(a=0;a<o.length;a++)o[a].grouping_type===r[h].grouping_type&&(d.fragment_description=o[a],d.fragment_description.used=!0,d.is_fragment=!0)}if(t){if(o)for(h=0;h<o.length;h++)!o[h].used&&o[h].version>=2&&(c=o[h].grouping_type+"/0",d=new f(o[h].grouping_type,0),d.is_fragment=!0,t.sample_groups_info[c]||(t.sample_groups_info[c]=d))}else for(h=0;h<s.length;h++)!s[h].used&&s[h].version>=2&&(c=s[h].grouping_type+"/0",d=new f(s[h].grouping_type,0),e.sample_groups_info[c]||(e.sample_groups_info[c]=d))};v.setSampleGroupProperties=function(e,t,r,s){var o,a;t.sample_groups=[];for(o in s)if(t.sample_groups[o]={},t.sample_groups[o].grouping_type=s[o].grouping_type,t.sample_groups[o].grouping_type_parameter=s[o].grouping_type_parameter,r>=s[o].last_sample_in_run&&(s[o].last_sample_in_run<0&&(s[o].last_sample_in_run=0),s[o].entry_index++,s[o].entry_index<=s[o].sbgp.entries.length-1&&(s[o].last_sample_in_run+=s[o].sbgp.entries[s[o].entry_index].sample_count)),s[o].entry_index<=s[o].sbgp.entries.length-1?t.sample_groups[o].group_description_index=s[o].sbgp.entries[s[o].entry_index].group_description_index:t.sample_groups[o].group_description_index=-1,t.sample_groups[o].group_description_index!==0){var h;s[o].fragment_description?h=s[o].fragment_description:h=s[o].description,t.sample_groups[o].group_description_index>0?(t.sample_groups[o].group_description_index>65535?a=(t.sample_groups[o].group_description_index>>16)-1:a=t.sample_groups[o].group_description_index-1,h&&a>=0&&(t.sample_groups[o].description=h.entries[a])):h&&h.version>=2&&h.default_group_description_index>0&&(t.sample_groups[o].description=h.entries[h.default_group_description_index-1])}};v.process_sdtp=function(e,t,r){t&&(e?(t.is_leading=e.is_leading[r],t.depends_on=e.sample_depends_on[r],t.is_depended_on=e.sample_is_depended_on[r],t.has_redundancy=e.sample_has_redundancy[r]):(t.is_leading=0,t.depends_on=0,t.is_depended_on=0,t.has_redundancy=0))};v.prototype.buildSampleLists=function(){var e,t;for(e=0;e<this.moov.traks.length;e++)t=this.moov.traks[e],this.buildTrakSampleLists(t)};v.prototype.buildTrakSampleLists=function(e){var t,r,s,o,a,h,l,d,c,f,m,u,p,y,x,S,w,T,E,P,z,M,O,U,A,k;if(e.samples=[],e.samples_duration=0,e.samples_size=0,s=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,o=e.mdia.minf.stbl.stsc,a=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,h=e.mdia.minf.stbl.stts,l=e.mdia.minf.stbl.ctts,d=e.mdia.minf.stbl.stss,c=e.mdia.minf.stbl.stsd,f=e.mdia.minf.stbl.subs,p=e.mdia.minf.stbl.stdp,m=e.mdia.minf.stbl.sbgps,u=e.mdia.minf.stbl.sgpds,E=-1,P=-1,z=-1,M=-1,O=0,A=0,k=0,v.initSampleGroups(e,null,m,u),!(typeof a>"u")){for(t=0;t<a.sample_sizes.length;t++){var b={};b.number=t,b.track_id=e.tkhd.track_id,b.timescale=e.mdia.mdhd.timescale,b.alreadyRead=0,e.samples[t]=b,b.size=a.sample_sizes[t],e.samples_size+=b.size,t===0?(x=1,y=0,b.chunk_index=x,b.chunk_run_index=y,T=o.samples_per_chunk[y],w=0,y+1<o.first_chunk.length?S=o.first_chunk[y+1]-1:S=1/0):t<T?(b.chunk_index=x,b.chunk_run_index=y):(x++,b.chunk_index=x,w=0,x<=S||(y++,y+1<o.first_chunk.length?S=o.first_chunk[y+1]-1:S=1/0),b.chunk_run_index=y,T+=o.samples_per_chunk[y]),b.description_index=o.sample_description_index[b.chunk_run_index]-1,b.description=c.entries[b.description_index],b.offset=s.chunk_offsets[b.chunk_index-1]+w,w+=b.size,t>E&&(P++,E<0&&(E=0),E+=h.sample_counts[P]),t>0?(e.samples[t-1].duration=h.sample_deltas[P],e.samples_duration+=e.samples[t-1].duration,b.dts=e.samples[t-1].dts+e.samples[t-1].duration):b.dts=0,l?(t>=z&&(M++,z<0&&(z=0),z+=l.sample_counts[M]),b.cts=e.samples[t].dts+l.sample_offsets[M]):b.cts=b.dts,d?(t==d.sample_numbers[O]-1?(b.is_sync=!0,O++):(b.is_sync=!1,b.degradation_priority=0),f&&f.entries[A].sample_delta+k==t+1&&(b.subsamples=f.entries[A].subsamples,k+=f.entries[A].sample_delta,A++)):b.is_sync=!0,v.process_sdtp(e.mdia.minf.stbl.sdtp,b,b.number),p?b.degradation_priority=p.priority[t]:b.degradation_priority=0,f&&f.entries[A].sample_delta+k==t&&(b.subsamples=f.entries[A].subsamples,k+=f.entries[A].sample_delta),(m.length>0||u.length>0)&&v.setSampleGroupProperties(e,b,t,e.sample_groups_info)}t>0&&(e.samples[t-1].duration=Math.max(e.mdia.mdhd.duration-e.samples[t-1].dts,0),e.samples_duration+=e.samples[t-1].duration)}};v.prototype.updateSampleLists=function(){var e,t,r,s,o,a,h,l,d,c,f,m,u,p,y;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(d=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,d.type=="moof")for(c=d,e=0;e<c.trafs.length;e++){for(f=c.trafs[e],m=this.getTrackById(f.tfhd.track_id),u=this.getTrexById(f.tfhd.track_id),f.tfhd.flags&n.TFHD_FLAG_SAMPLE_DESC?s=f.tfhd.default_sample_description_index:s=u?u.default_sample_description_index:1,f.tfhd.flags&n.TFHD_FLAG_SAMPLE_DUR?o=f.tfhd.default_sample_duration:o=u?u.default_sample_duration:0,f.tfhd.flags&n.TFHD_FLAG_SAMPLE_SIZE?a=f.tfhd.default_sample_size:a=u?u.default_sample_size:0,f.tfhd.flags&n.TFHD_FLAG_SAMPLE_FLAGS?h=f.tfhd.default_sample_flags:h=u?u.default_sample_flags:0,f.sample_number=0,f.sbgps.length>0&&v.initSampleGroups(m,f,f.sbgps,m.mdia.minf.stbl.sgpds,f.sgpds),t=0;t<f.truns.length;t++){var x=f.truns[t];for(r=0;r<x.sample_count;r++){p={},p.moof_number=this.lastMoofIndex,p.number_in_traf=f.sample_number,f.sample_number++,p.number=m.samples.length,f.first_sample_index=m.samples.length,m.samples.push(p),p.track_id=m.tkhd.track_id,p.timescale=m.mdia.mdhd.timescale,p.description_index=s-1,p.description=m.mdia.minf.stbl.stsd.entries[p.description_index],p.size=a,x.flags&n.TRUN_FLAGS_SIZE&&(p.size=x.sample_size[r]),m.samples_size+=p.size,p.duration=o,x.flags&n.TRUN_FLAGS_DURATION&&(p.duration=x.sample_duration[r]),m.samples_duration+=p.duration,m.first_traf_merged||r>0?p.dts=m.samples[m.samples.length-2].dts+m.samples[m.samples.length-2].duration:(f.tfdt?p.dts=f.tfdt.baseMediaDecodeTime:p.dts=0,m.first_traf_merged=!0),p.cts=p.dts,x.flags&n.TRUN_FLAGS_CTS_OFFSET&&(p.cts=p.dts+x.sample_composition_time_offset[r]),y=h,x.flags&n.TRUN_FLAGS_FLAGS?y=x.sample_flags[r]:r===0&&x.flags&n.TRUN_FLAGS_FIRST_FLAG&&(y=x.first_sample_flags),p.is_sync=!(y>>16&1),p.is_leading=y>>26&3,p.depends_on=y>>24&3,p.is_depended_on=y>>22&3,p.has_redundancy=y>>20&3,p.degradation_priority=y&65535;var S=!!(f.tfhd.flags&n.TFHD_FLAG_BASE_DATA_OFFSET),w=!!(f.tfhd.flags&n.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),T=!!(x.flags&n.TRUN_FLAGS_DATA_OFFSET),E=0;S?E=f.tfhd.base_data_offset:w||t===0?E=c.start:E=l,t===0&&r===0?T?p.offset=E+x.data_offset:p.offset=E:p.offset=l,l=p.offset+p.size,(f.sbgps.length>0||f.sgpds.length>0||m.mdia.minf.stbl.sbgps.length>0||m.mdia.minf.stbl.sgpds.length>0)&&v.setSampleGroupProperties(m,p,p.number_in_traf,f.sample_groups_info)}}if(f.subs){m.has_fragment_subsamples=!0;var P=f.first_sample_index;for(t=0;t<f.subs.entries.length;t++)P+=f.subs.entries[t].sample_delta,p=m.samples[P-1],p.subsamples=f.subs.entries[t].subsamples}}}};v.prototype.getSample=function(e,t){var r,s=e.samples[t];if(!this.moov)return null;if(!s.data)s.data=new Uint8Array(s.size),s.alreadyRead=0,this.samplesDataSize+=s.size,g.debug("ISOFile","Allocating sample #"+t+" on track #"+e.tkhd.track_id+" of size "+s.size+" (total: "+this.samplesDataSize+")");else if(s.alreadyRead==s.size)return s;for(;;){var o=this.stream.findPosition(!0,s.offset+s.alreadyRead,!1);if(o>-1){r=this.stream.buffers[o];var a=r.byteLength-(s.offset+s.alreadyRead-r.fileStart);if(s.size-s.alreadyRead<=a)return g.debug("ISOFile","Getting sample #"+t+" data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-r.fileStart)+" read size: "+(s.size-s.alreadyRead)+" full size: "+s.size+")"),_.memcpy(s.data.buffer,s.alreadyRead,r,s.offset+s.alreadyRead-r.fileStart,s.size-s.alreadyRead),r.usedBytes+=s.size-s.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead=s.size,s;if(a===0)return null;g.debug("ISOFile","Getting sample #"+t+" partial data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-r.fileStart)+" read size: "+a+" full size: "+s.size+")"),_.memcpy(s.data.buffer,s.alreadyRead,r,s.offset+s.alreadyRead-r.fileStart,a),s.alreadyRead+=a,r.usedBytes+=a,this.stream.logBufferLevel()}else return null}};v.prototype.releaseSample=function(e,t){var r=e.samples[t];return r.data?(this.samplesDataSize-=r.size,r.data=null,r.alreadyRead=0,r.size):0};v.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize};v.prototype.getCodecs=function(){var e,t="";for(e=0;e<this.moov.traks.length;e++){var r=this.moov.traks[e];e>0&&(t+=","),t+=r.mdia.minf.stbl.stsd.entries[0].getCodec()}return t};v.prototype.getTrexById=function(e){var t;if(!this.moov||!this.moov.mvex)return null;for(t=0;t<this.moov.mvex.trexs.length;t++){var r=this.moov.mvex.trexs[t];if(r.track_id==e)return r}return null};v.prototype.getTrackById=function(e){if(this.moov===void 0)return null;for(var t=0;t<this.moov.traks.length;t++){var r=this.moov.traks[t];if(r.tkhd.track_id==e)return r}return null};v.prototype.items=[];v.prototype.itemsDataSize=0;v.prototype.flattenItemInfo=function(){var e=this.items,t,r,s,o=this.meta;if(o!=null&&o.hdlr!==void 0&&o.iinf!==void 0){for(t=0;t<o.iinf.item_infos.length;t++)s={},s.id=o.iinf.item_infos[t].item_ID,e[s.id]=s,s.ref_to=[],s.name=o.iinf.item_infos[t].item_name,o.iinf.item_infos[t].protection_index>0&&(s.protection=o.ipro.protections[o.iinf.item_infos[t].protection_index-1]),o.iinf.item_infos[t].item_type?s.type=o.iinf.item_infos[t].item_type:s.type="mime",s.content_type=o.iinf.item_infos[t].content_type,s.content_encoding=o.iinf.item_infos[t].content_encoding;if(o.iloc)for(t=0;t<o.iloc.items.length;t++){var a,h=o.iloc.items[t];switch(s=e[h.item_ID],h.data_reference_index!==0&&(g.warn("Item storage with reference to other files: not supported"),s.source=o.dinf.boxes[h.data_reference_index-1]),h.construction_method){case 0:break;case 1:g.warn("Item storage with construction_method : not supported");break;case 2:g.warn("Item storage with construction_method : not supported");break}for(s.extents=[],s.size=0,r=0;r<h.extents.length;r++)s.extents[r]={},s.extents[r].offset=h.extents[r].extent_offset+h.base_offset,s.extents[r].length=h.extents[r].extent_length,s.extents[r].alreadyRead=0,s.size+=s.extents[r].length}if(o.pitm&&(e[o.pitm.item_id].primary=!0),o.iref)for(t=0;t<o.iref.references.length;t++){var l=o.iref.references[t];for(r=0;r<l.references.length;r++)e[l.from_item_ID].ref_to.push({type:l.type,id:l.references[r]})}if(o.iprp)for(var d=0;d<o.iprp.ipmas.length;d++){var c=o.iprp.ipmas[d];for(t=0;t<c.associations.length;t++){var f=c.associations[t];for(s=e[f.id],s.properties===void 0&&(s.properties={},s.properties.boxes=[]),r=0;r<f.props.length;r++){var m=f.props[r];if(m.property_index>0&&m.property_index-1<o.iprp.ipco.boxes.length){var u=o.iprp.ipco.boxes[m.property_index-1];s.properties[u.type]=u,s.properties.boxes.push(u)}}}}}};v.prototype.getItem=function(e){var t,r;if(!this.meta)return null;if(r=this.items[e],!r.data&&r.size)r.data=new Uint8Array(r.size),r.alreadyRead=0,this.itemsDataSize+=r.size,g.debug("ISOFile","Allocating item #"+e+" of size "+r.size+" (total: "+this.itemsDataSize+")");else if(r.alreadyRead===r.size)return r;for(var s=0;s<r.extents.length;s++){var o=r.extents[s];if(o.alreadyRead!==o.length){var a=this.stream.findPosition(!0,o.offset+o.alreadyRead,!1);if(a>-1){t=this.stream.buffers[a];var h=t.byteLength-(o.offset+o.alreadyRead-t.fileStart);if(o.length-o.alreadyRead<=h)g.debug("ISOFile","Getting item #"+e+" extent #"+s+" data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-t.fileStart)+" read size: "+(o.length-o.alreadyRead)+" full extent size: "+o.length+" full item size: "+r.size+")"),_.memcpy(r.data.buffer,r.alreadyRead,t,o.offset+o.alreadyRead-t.fileStart,o.length-o.alreadyRead),t.usedBytes+=o.length-o.alreadyRead,this.stream.logBufferLevel(),r.alreadyRead+=o.length-o.alreadyRead,o.alreadyRead=o.length;else return g.debug("ISOFile","Getting item #"+e+" extent #"+s+" partial data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-t.fileStart)+" read size: "+h+" full extent size: "+o.length+" full item size: "+r.size+")"),_.memcpy(r.data.buffer,r.alreadyRead,t,o.offset+o.alreadyRead-t.fileStart,h),o.alreadyRead+=h,r.alreadyRead+=h,t.usedBytes+=h,this.stream.logBufferLevel(),null}else return null}}return r.alreadyRead===r.size?r:null};v.prototype.releaseItem=function(e){var t=this.items[e];if(t.data){this.itemsDataSize-=t.size,t.data=null,t.alreadyRead=0;for(var r=0;r<t.extents.length;r++){var s=t.extents[r];s.alreadyRead=0}return t.size}else return 0};v.prototype.processItems=function(e){for(var t in this.items){var r=this.items[t];this.getItem(r.id),e&&!r.sent&&(e(r),r.sent=!0,r.data=null)}};v.prototype.hasItem=function(e){for(var t in this.items){var r=this.items[t];if(r.name===e)return r.id}return-1};v.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null};v.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)};v.prototype.itemToFragmentedTrackFile=function(e){var t=e||{},r=null;if(t.itemId?r=this.getItem(t.itemId):r=this.getPrimaryItem(),r==null)return null;var s=new v;s.discardMdatData=!1;var o={type:r.type,description_boxes:r.properties.boxes};r.properties.ispe&&(o.width=r.properties.ispe.image_width,o.height=r.properties.ispe.image_height);var a=s.addTrack(o);return a?(s.addSample(a,r.data),s):null};v.prototype.write=function(e){for(var t=0;t<this.boxes.length;t++)this.boxes[t].write(e)};v.prototype.createFragment=function(e,t,r){var s=this.getTrackById(e),o=this.getSample(s,t);if(o==null)return this.setNextSeekPositionFromSample(s.samples[t]),null;var a=r||new _;a.endianness=_.BIG_ENDIAN;var h=this.createSingleSampleMoof(o);h.write(a),h.trafs[0].truns[0].data_offset=h.size+8,g.debug("MP4Box","Adjusting data_offset with new value "+h.trafs[0].truns[0].data_offset),a.adjustUint32(h.trafs[0].truns[0].data_offset_position,h.trafs[0].truns[0].data_offset);var l=new n.mdatBox;return l.data=o.data,l.write(a),a};v.writeInitializationSegment=function(e,t,r,s){var o,a,h,l,d;g.debug("ISOFile","Generating initialization segment");var c=new _;c.endianness=_.BIG_ENDIAN,e.write(c);var f=t.add("mvex");for(r&&f.add("mehd").set("fragment_duration",r),o=0;o<t.traks.length;o++)f.add("trex").set("track_id",t.traks[o].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",s).set("default_sample_size",0).set("default_sample_flags",65536);return t.write(c),c.buffer};v.prototype.save=function(e){var t=new _;t.endianness=_.BIG_ENDIAN,this.write(t),t.save(e)};v.prototype.getBuffer=function(){var e=new _;return e.endianness=_.BIG_ENDIAN,this.write(e),e.buffer};v.prototype.initializeSegmentation=function(){var e,t,r,s,o,a;for(this.onSegment===null&&g.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),s=[],e=0;e<this.fragmentedTracks.length;e++){var h=new n.moovBox;h.mvhd=this.moov.mvhd,h.boxes.push(h.mvhd),o=this.getTrackById(this.fragmentedTracks[e].id),h.boxes.push(o),h.traks.push(o),a={},a.id=o.tkhd.track_id,a.user=this.fragmentedTracks[e].user,a.buffer=v.writeInitializationSegment(this.ftyp,h,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[e].samples.length>0?this.moov.traks[e].samples[0].duration:0),s.push(a)}return s};n.Box.prototype.printHeader=function(e){this.size+=8,this.size>H&&(this.size+=8),this.type==="uuid"&&(this.size+=16),e.log(e.indent+"size:"+this.size),e.log(e.indent+"type:"+this.type)};n.FullBox.prototype.printHeader=function(e){this.size+=4,n.Box.prototype.printHeader.call(this,e),e.log(e.indent+"version:"+this.version),e.log(e.indent+"flags:"+this.flags)};n.Box.prototype.print=function(e){this.printHeader(e)};n.ContainerBox.prototype.print=function(e){this.printHeader(e);for(var t=0;t<this.boxes.length;t++)if(this.boxes[t]){var r=e.indent;e.indent+=" ",this.boxes[t].print(e),e.indent=r}};v.prototype.print=function(e){e.indent="";for(var t=0;t<this.boxes.length;t++)this.boxes[t]&&this.boxes[t].print(e)};n.mvhdBox.prototype.print=function(e){n.FullBox.prototype.printHeader.call(this,e),e.log(e.indent+"creation_time: "+this.creation_time),e.log(e.indent+"modification_time: "+this.modification_time),e.log(e.indent+"timescale: "+this.timescale),e.log(e.indent+"duration: "+this.duration),e.log(e.indent+"rate: "+this.rate),e.log(e.indent+"volume: "+(this.volume>>8)),e.log(e.indent+"matrix: "+this.matrix.join(", ")),e.log(e.indent+"next_track_id: "+this.next_track_id)};n.tkhdBox.prototype.print=function(e){n.FullBox.prototype.printHeader.call(this,e),e.log(e.indent+"creation_time: "+this.creation_time),e.log(e.indent+"modification_time: "+this.modification_time),e.log(e.indent+"track_id: "+this.track_id),e.log(e.indent+"duration: "+this.duration),e.log(e.indent+"volume: "+(this.volume>>8)),e.log(e.indent+"matrix: "+this.matrix.join(", ")),e.log(e.indent+"layer: "+this.layer),e.log(e.indent+"alternate_group: "+this.alternate_group),e.log(e.indent+"width: "+this.width),e.log(e.indent+"height: "+this.height)};var Ue={};Ue.createFile=function(e,t){var r=e!==void 0?e:!0,s=new v(t);return s.discardMdatData=!r,s};typeof I<"u"&&(I.createFile=Ue.createFile)});var X=K(W());function tt(e,t,r){function s(O,U,A,k,b,R){let Y=1-b,D=1-R;return O*Y*D+U*b*D+A*Y*R+k*b*R}let o,a,h,l,d,c,f,m,u,p,y,x,S,w,T,E,P,z,M;for(o=0;o<t.height;++o)for(h=o/r,l=Math.floor(h),d=Math.ceil(h)>e.height-1?e.height-1:Math.ceil(h),a=0;a<t.width;++a)c=a/r,f=Math.floor(c),m=Math.ceil(c)>e.width-1?e.width-1:Math.ceil(c),u=(a+t.width*o)*4,p=(f+e.width*l)*4,y=(m+e.width*l)*4,x=(f+e.width*d)*4,S=(m+e.width*d)*4,w=c-f,T=h-l,E=s(e.data[p],e.data[y],e.data[x],e.data[S],w,T),t.data[u]=E,P=s(e.data[p+1],e.data[y+1],e.data[x+1],e.data[S+1],w,T),t.data[u+1]=P,z=s(e.data[p+2],e.data[y+2],e.data[x+2],e.data[S+2],w,T),t.data[u+2]=z,M=s(e.data[p+3],e.data[y+3],e.data[x+3],e.data[S+3],w,T),t.data[u+3]=M}var J;function le(e,t,r){return Math.min(Math.floor(e*t),r.maxHeight)}function Te(e,t){let r=t.width/t.height,s=Math.min(t.width,e.maxWidth,r*e.maxHeight);return e.maxSize&&e.maxSize>0&&e.maxSize<t.width*t.height/1e3&&(s=Math.min(s,Math.floor(e.maxSize*1e3/t.height))),e.scaleRatio&&(s=Math.min(s,Math.floor(e.scaleRatio*t.width))),e.debug&&(console.log("browser-image-resizer: original image size = "+t.width+" px (width) X "+t.height+" px (height)"),console.log("browser-image-resizer: scaled image size = "+s+" px (width) X "+le(t.height,s/t.width,e)+" px (height)")),s<=0&&(s=1,console.warn("browser-image-resizer: image size is too small")),s}function he(e,t){let r=e?.getContext("2d")?.getImageData(0,0,e.width,e.height),s=t?.getContext("2d")?.createImageData(t.width,t.height);if(!r||!s)throw Error("Canvas is empty (scaleCanvasWithAlgorithm). You should run this script after the document is ready.");return{srcImgData:r,destImgData:s}}function Ee(){J||(J=new nt)}async function it(e,t){let r=t.outputWidth/e.width,s=new OffscreenCanvas(Math.floor(t.outputWidth),le(e.height,r,t));switch(t.argorithm){case"hermite":{Ee(),await J.resampleAuto(e,s,t);break}case"hermite_single":{let{srcImgData:o,destImgData:a}=he(e,s);Ee(),J.resampleSingle(o,a,t),s?.getContext("2d")?.putImageData(a,0,0);break}case"bilinear":{let{srcImgData:o,destImgData:a}=he(e,s);tt(o,a,r),s?.getContext("2d")?.putImageData(a,0,0);break}default:{s.getContext("2d")?.drawImage(e,0,0,s.width,s.height);break}}return s}function rt(e){let t=new OffscreenCanvas(e.width/2,e.height/2);return t?.getContext("2d")?.drawImage(e,0,0,t.width,t.height),t}async function st({img:e,config:t}){t.debug&&console.log("browser-image-resizer: Scale: Started",e);let r;if(e instanceof OffscreenCanvas)r=e;else{let a=await createImageBitmap(e);r=new OffscreenCanvas(a.width,a.height),r.getContext("2d")?.drawImage(a,0,0)}if(!r?.getContext("2d"))throw Error("browser-image-resizer: Canvas Context is empty.");let s=Te(t,r);if(!s)throw Error(`browser-image-resizer: maxWidth is ${s}!!`);for(t.debug&&console.log(`browser-image-resizer: scale: maxWidth is ${s}`);t.processByHalf&&r.width>=2*s;)t.debug&&console.log(`browser-image-resizer: scale: Scaling canvas by half from ${r.width}`),r=rt(r);return r.width>s&&(t.debug&&console.log(`browser-image-resizer: scale: Scaling canvas by ${t.argorithm} from ${r.width} to ${s}`),r=await it(r,Object.assign(t,{outputWidth:s}))),t.mimeType===null?r:await r.convertToBlob({type:t.mimeType,quality:t.quality})}var nt=class{constructor(){this.workersArchive=[],this.cores=Math.min(navigator.hardwareConcurrency||4,4),this.workerBlobURL=globalThis.URL.createObjectURL(new Blob(["(",function(){onmessage=function(e){e.data.debug&&(console.log("browser-image-resizer: hermite worker: start",e.data.core,e.data),console.time("work"));let t=e.data.core,r=e.data.srcWidth,s=e.data.srcHeight,o=e.data.destWidth,a=e.data.destHeight,h=r/o,l=s/a,d=Math.ceil(h/2),c=Math.ceil(l/2),f=new Uint8ClampedArray(e.data.source),m=o*a*4,u=new ArrayBuffer(m),p=new Uint8ClampedArray(u,0,m);for(let x=0;x<a;x++)for(let S=0;S<o;S++){let w=(S+x*o)*4,T=0,E=0,P=0,z=0,M=0,O=0,U=0,A=x*l,k=Math.floor(S*h),b=Math.min(Math.ceil((S+1)*h),r),R=Math.floor(x*l),Y=Math.min(Math.ceil((x+1)*l),s);for(let D=R;D<Y;D++){let V=Math.abs(A-D)/c,qe=S*h,je=V*V;for(let Q=k;Q<b;Q++){let xe=Math.abs(qe-Q)/d,q=Math.sqrt(je+xe*xe);if(q>=1)continue;T=2*q*q*q-3*q*q+1;let j=4*(Q+D*r);U+=T*f[j+3],P+=T,f[j+3]<255&&(T=T*f[j+3]/250),z+=T*f[j],M+=T*f[j+1],O+=T*f[j+2],E+=T}}p[w]=z/E,p[w+1]=M/E,p[w+2]=O/E,p[w+3]=U/P}let y={core:t,target:p};globalThis.postMessage(y,[p.buffer]),e.data.debug&&(console.timeEnd("work"),console.log("browser-image-resizer: Worker: end",e.data.core))}}.toString(),")()"],{type:"application/javascript"}))}resampleAuto(e,t,r){if(globalThis.Worker&&this.cores>1&&r?.argorithm!=="hermite_single")return this.resample(e,t,r);{let{srcImgData:s,destImgData:o}=he(e,t);this.resampleSingle(s,o,r),t.getContext("2d").putImageData(o,0,0);return}}async resample(e,t,r){return new Promise((s,o)=>{r.debug&&console.time("hermite_multi");let a=e.height/t.height;if(this.workersArchive.length>0)for(let u=0;u<this.cores;u++)this.workersArchive[u]!=null&&(this.workersArchive[u].terminate(),delete this.workersArchive[u]);this.workersArchive=new Array(this.cores);let h=e.getContext("2d");if(!h)return o("Canvas is empty (resample)");r.debug&&(console.log("browser-image-resizer: hermite_multi: ",this.cores,"cores"),console.log("browser-image-resizer: source size: ",e.width,e.height,"ratio_h: ",a),console.log("browser-image-resizer: target size: ",t.width,t.height));let l=[],d=Math.ceil(e.height/this.cores/2)*2,c=-1;for(let u=0;u<this.cores;u++){let p=c+1;if(p>=e.height)continue;c=Math.min(p+d-1,e.height-1);let y=Math.min(d,e.height-p);r.debug&&console.log("browser-image-resizer: source split: ","#"+u,p,c,"height: "+y),l.push({source:h.getImageData(0,p,e.width,d),startY:Math.ceil(p/a),height:y})}let f=t.getContext("2d");if(!f)return o("Canvas is empty (resample dest)");let m=l.length;for(let u=0;u<l.length;u++){let p=new Worker(this.workerBlobURL);this.workersArchive[u]=p,p.onmessage=x=>{m--;let S=x.data.core,w=Math.ceil(l[S].height/a),T=f.createImageData(t.width,w);T.data.set(x.data.target),f.putImageData(T,0,l[S].startY),m<=0&&(s(),r.debug&&console.timeEnd("hermite_multi")),this.workersArchive[S].terminate(),delete this.workersArchive[S]},p.onerror=x=>o(x);let y={srcWidth:e.width,srcHeight:l[u].height,destWidth:t.width,destHeight:Math.ceil(l[u].height/a),core:u,source:l[u].source.data.buffer,debug:r.debug};p.postMessage(y,[y.source])}})}resampleSingle(e,t,r){let s=e.width/t.width,o=e.height/t.height,a=Math.ceil(s/2),h=Math.ceil(o/2),l=e.data,d=t.data;r.debug&&(console.log("browser-image-resizer: source size: ",e.width,e.height,"ratio_h: ",o),console.log("browser-image-resizer: target size: ",t.width,t.height),console.time("hermite_single"));for(let c=0;c<t.height;c++)for(let f=0;f<t.width;f++){let m=(f+c*t.width)*4,u=0,p=0,y=0,x=0,S=0,w=0,T=0,E=c*o,P=Math.floor(f*s),z=Math.min(Math.ceil((f+1)*s),e.width),M=Math.floor(c*o),O=Math.min(Math.ceil((c+1)*o),e.height);for(let U=M;U<O;U++){let A=Math.abs(E-U)/h,k=f*s,b=A*A;for(let R=P;R<z;R++){let Y=Math.abs(k-R)/a,D=Math.sqrt(b+Y*Y);if(D>=1)continue;u=2*D*D*D-3*D*D+1;let V=4*(R+U*e.width);T+=u*l[V+3],y+=u,l[V+3]<255&&(u=u*l[V+3]/250),x+=u*l[V],S+=u*l[V+1],w+=u*l[V+2],p+=u}}d[m]=x/p,d[m+1]=S/p,d[m+2]=w/p,d[m+3]=T/y}r.debug&&console.timeEnd("hermite_single")}};var Be={argorithm:"null",processByHalf:!0,quality:.5,maxWidth:800,maxHeight:600,debug:!1,mimeType:"image/jpeg"};async function Ae(e,t){let r=Object.assign({},Be,t);return st({img:e,config:r})}function Ce(e,t){let r=Object.assign({},Be,t),s=Te(r,e),o=le(e.height,s/e.width,r);return{width:Math.floor(s),height:o}}var pe=K(W());var de=K(W());function fe(e){let t=new de.DataStream(void 0,0,de.DataStream.BIG_ENDIAN);return e.write(t),t.buffer}function Ie(e){let t=e.avcC||e.hvcC||e.vpcC||e.av1C;if(t){let r=fe(t);return new Uint8Array(r,8)}throw new Error("avcC, hvcC, vpcC or av1C box not found")}function ee(e){return e?.mdia?.minf?.stbl?.stsd?.entries??[]}var ce=50,te=(e,t=!1)=>{let r=0,s,o=(()=>{let l;return{allSamplesEnqueuedPromise:new Promise(c=>{l=c}),allSamplesEnqueuedCallback:l}})(),a={track:void 0,tracks:void 0,processedSample:0,flashCalled:!1,interval:0,resolve:null},h=()=>{t&&console.log("demux: clearInterval",a.interval),a.interval&&(globalThis.clearInterval(a.interval),a.interval=0)};return new TransformStream({start(l){s=(0,pe.createFile)(),s.onError=d=>{l.error(d),console.error("demux: mp4box error",d),s.flush(),h()},s.onReady=d=>{if(s.setExtractionOptions(e,null,{nbSamples:1}),a.tracks=new Set(d.tracks.map(c=>c.id)),a.track=d.tracks.find(c=>c.id===e),!a.track){l.error("No track found");return}t&&console.log("demux: onReady",d,a.track.nb_samples),s.start()},s.onSamples=(d,c,f)=>{if(!(!f||f.length===0)){t&&console.log("demux: onSamples: desiredSize",l.desiredSize);for(let m of f)l.enqueue(m),a.processedSample=m.number+1,t&&console.log("demux: onSamples: sample",m.track_id,m.number,a.track.nb_samples,m.cts,m.duration,m.timescale,m.is_sync,m),a.flashCalled&&a.processedSample>=a.track.nb_samples&&(t&&console.log("demux: onSamples: [terminate] last sample",m.number,a.processedSample,a.track.nb_samples),o.allSamplesEnqueuedCallback())}},a.interval=globalThis.setInterval(()=>{a.resolve&&(l.desiredSize??0)>=0&&(t&&console.log("demux: recieving chunk resolve!!"),a.resolve(),a.resolve=null)},1)},async transform(l,d){try{if(l){let c=l.buffer;if(c.fileStart=r,s.appendBuffer(c),r+=l.byteLength,t&&console.log("demux: recieving chunk",l.byteLength,r,d.desiredSize),a.processedSample>=ce){let f=Math.min(d.desiredSize??0,0),m=Math.max(a.processedSample+f-ce,0);t&&console.log("demux: recieving chunk: release used samples",e,m,a.processedSample,f,ce),s.releaseUsedSamples(e,m)}for(let f of a.tracks??[]){let m=s.getTrackSamplesInfo(f).length;f!==e&&m&&s.releaseUsedSamples(f,m)}}return a.track?.nb_samples?new Promise(c=>{a.resolve&&a.resolve(),a.resolve=c}):void 0}catch(c){return console.error("demux: caught error",c),Promise.resolve()}},async flush(l){t&&console.log("demux: [terminate] file flush"),a.flashCalled=!0,a.processedSample>=a.track.nb_samples?(t&&console.log("demux: [terminate] all samples already processed"),o.allSamplesEnqueuedCallback()):await o.allSamplesEnqueuedPromise,h(),l.terminate(),s.flush(),h()}},{highWaterMark:1})},ot=[9,15,23.94,24,25,29.97,30,59.94,60,119.88,120];function at(e){let t=Math.round(e*100)/100;for(let r of ot)if(t<=r)return r;return t}function Fe(e,t=!1){let r={};return new Promise((s,o)=>{let a=(0,pe.createFile)();r.file=a;let h=e.stream().getReader(),l=0;async function d(){let{done:c,value:f}=await h.read();if(!c){if(f){let m=f.buffer;m.fileStart=l,a.appendBuffer(m),l+=f.byteLength}return d()}}a.onError=c=>{o(c),a.flush(),h.cancel()},a.onReady=c=>{if(h.cancel(),r.info=c,c.videoTracks.length>0){r.videoInfo=c.videoTracks[0],r.videoInfo.edits&&r.videoInfo.edits.length&&r.videoInfo.edits[0].media_time?(r.fps=r.videoInfo.timescale/r.videoInfo.edits[0].media_time,r.defaultSampleDuration=r.videoInfo.edits[0].media_time):(r.defaultSampleDuration=r.videoInfo.duration/r.videoInfo.nb_samples,r.fps=r.videoInfo.duration?r.videoInfo.timescale/r.defaultSampleDuration:30),r.fps=at(r.fps);let f=a.getTrackById(r.videoInfo.id);for(let m of ee(f))try{r.description=Ie(m)}catch(u){t&&console.error("getMP4Info: getDescriptionBuffer error",u)}}s(r),a.flush()},d()})}var ht=32,lt=16,Pe=(e=!1)=>new TransformStream({start(){},transform(t,r){try{let s=new EncodedVideoChunk({type:t.is_sync?"key":"delta",timestamp:1e6*t.cts/t.timescale,duration:1e6*t.duration/t.timescale,data:t.data});e&&console.log("sample: transform from sample to EncodedVideoChunk",t,s),r.enqueue(s)}catch(s){console.error("sample: caught error",s)}},flush(t){e&&console.log("sample: [terminate] sample flush"),t.terminate()}});async function ze(e,t,r,s,o=!1){let a=0,h=0,l,d={codec:e.codec.startsWith("vp08")?"vp8":e.codec,hardwareAcceleration:"prefer-software",optimizeForLatency:!1,...r,codedHeight:e.video.height,codedWidth:e.video.width,description:t};o&&console.log("decode: configure",d),await VideoDecoder.isConfigSupported(d);let c=null,f=()=>{o&&console.log("decode: emit resolve",c),c&&(c(),c=null)},m=()=>a<=h+ht,u=new Set;return new TransformStream({start(p){l=new VideoDecoder({output:y=>{if(y)try{o&&console.log("decode: enqueue frame:",y.timestamp,u.has(h),h,e.nb_samples,l.decodeQueueSize),h++,p.enqueue({frame:y,isKeyFrame:u.has(y.timestamp)})}catch(x){console.error("decode: enqueue frame: caught error",x)}else console.error("decode: enqueue frame: no frame output??");m()&&f()},error:y=>{console.error("decode: decoder error",y),p.error(y)}}),l.configure(d)},transform(p,y){try{return a++,p.type==="key"&&u.add(p.timestamp),o&&console.log("decode: recieving vchunk:",a,h,l.decodeQueueSize),l.state!=="configured"?(console.error("decode: recieving vchunk: decoder state is strange",l.state),Promise.resolve()):(l.decode(p),f(),m()?(o&&console.log("decode: recieving vchunk: resolve immediate"),Promise.resolve()):(o&&console.log("decode: recieving vchunk: wait for allowWrite"),new Promise(x=>{c=x})))}catch(x){return console.error("decode: caught error",x),Promise.resolve()}},async flush(p){return o&&console.log("decode: [terminate] vchunk flush"),l.flush().then(()=>{o&&console.log("decode: [terminate] decoder flushed!!!",e.nb_samples,h),s.dropFramesOnDecoding=e.nb_samples-h,p.terminate()});p.terminate()}},{highWaterMark:lt})}var dt=[0,-1,-2,-3,-4,-5,-6,-7,-8,-9,1,2,3,4,5,6,7,8,9];function ke(e,t,r=!1){let s=0,o=0,a=new Map,h=0,l=0;function d(u){a.get(u)?.frame.close(),a.delete(u),t.dropFrames++}function c(u,p){l++;let y=u.frame.timestamp-o;if(r&&console.log("sort: enqueue: prefferedDuration",l,y,o,u.frame.timestamp,u.frame.duration,u.frame),o=u.frame.timestamp,u.frame.duration!==y){let x=new VideoFrame(u.frame,{timestamp:u.frame.timestamp,duration:y,visibleRect:u.frame.visibleRect??void 0});u.frame.close(),p.enqueue({frame:x,isKeyFrame:u.isKeyFrame})}else p.enqueue(u)}function f(u,p){let y=a.get(u);c(y,p),a.delete(u)}function m(u,p,y){r&&console.log("sort: send: trying to send",s,p,a.keys());let x=y??new Set;a.set(p.frame.timestamp,p);for(let S of dt){let w=s+S;if(p?.frame.timestamp===w){x.add(p.frame.timestamp),s=w+(p.frame.duration??0);break}if(a.size&&a.has(w)){x.add(w);let T=a.get(w);if(T.frame.duration){s=w+T.frame.duration,m(u,T,x);return}}}if(x.size>0){r&&console.log("sort: send: enqueue buffer",x,x.size);for(let S of x)f(S,u),r&&console.log("sort: send: enqueue buffer: sending frame",S,h,l,a.size);return}else r&&console.log("sort: send: no frame to enqueue")}return new TransformStream({start(){},transform(u,p){try{if(h++,r&&console.log("sort: recieving frame",u.frame.timestamp,h,e.nb_samples,l,t,a.size),a.has(u.frame.timestamp)&&(console.error("sort: recieving frame: timestamp duplicated",u.frame.timestamp),d(u.frame.timestamp)),u.frame.timestamp<s){console.error("sort: recieving frame: drop frame",u.frame.timestamp,s),u.frame.close();return}if(a.size>=13){console.error("sort: recieving frame: cache is too large",u.frame.timestamp,s,Array.from(a.keys()));for(let y of a.keys())y<s&&d(y);s=Math.min(...a.keys()),"startTimeShift"in t||(t.startTimeShift=s),r&&console.log("sort: recieving frame: cache is too large (cache and expectedNextTimestamp fixed)",Array.from(a.keys()),s)}m(p,u)}catch(y){console.error("sort: recieving frame: caught error",y)}},flush(u){r&&console.log("sort: [terminate] frame flush");let p=Array.from(a.keys()).sort((y,x)=>y-x);r&&console.log("sort: recieving frame: last frame:",p);for(let y of p)if(y<s)r&&console.error("sort: recieving frame: last framee: drop frame",y,s,l),d(y);else{let x=a.get(y);s=y+(x.frame.duration??0),r&&console.log("sort: recieving frame: last frame: enqueue",y,s,l),c(x,u),a.delete(y)}r&&console.log("sort: recieving frame: [terminate]",l,t,t.getResultSamples()),u.terminate()}},{highWaterMark:16})}function ue(e,t){return Math.floor(e/t)*t}function Le(e,t=!1){let r=0;return new TransformStream({start(){},async transform(s,o){try{r++,t&&(performance.mark("resize start"),console.log("resize: recieved",r,s));let a=await Ae(s.frame,{...e,mimeType:null});s.frame.close();let h=new VideoFrame(a,{timestamp:s.frame.timestamp,duration:s.frame.duration??void 0});t&&(performance.mark("resize end"),console.log("resize: transform",r,performance.measure("resize","resize start").duration,h)),o.enqueue({frame:h,isKeyFrame:s.isKeyFrame})}catch(a){console.error("resize: caught error",a)}},flush(s){t&&console.log("resize: [terminate] flush"),s.terminate()}})}var ft=32;function ct(e){if(e&&e.type==="microseconds"&&e.interval<0)throw new Error("videoKeyframeConfig.interval must be positive")}function Me(e,t,r=!1){let s,o=0,a=0,h=0;ct(t);let l=null,d=()=>{r&&console.log("encode: emit resolve",l),l&&(l(),l=null)},c=()=>o<=a+ft;return new TransformStream({start(f){s=new VideoEncoder({output:(m,u)=>{a++,u&&Object.keys(u).length&&(f.enqueue({type:"metadata",data:u}),r&&console.log("encode: encoded: metadata",u,Array.from(new Uint8Array(u.decoderConfig?.description??new ArrayBuffer(0))).map(p=>p.toString(16).padStart(2,"0")).join(" "))),f.enqueue({type:"encodedVideoChunk",data:m}),r&&console.log("encode: encoded",m.timestamp,a-1,o,m,s.encodeQueueSize,u),c()&&d()},error:m=>{console.error("encode: encoder error",m),f.error(m)}});try{s.configure(e)}catch(m){console.error("encoder configure error",m),f.error(m)}},async transform(f,m){try{o++;let u=(()=>(r&&console.log("encode: keyframe decision:",o,f.frame.timestamp,t),o===1?!0:t&&t.type==="microseconds"?t.interval===0?f.isKeyFrame:f.frame.timestamp-h>=t.interval?(r&&console.log("encode: keyframe decision: microseconds true:",o,f.frame.timestamp,h,t.interval),h=f.frame.timestamp,!0):!1:f.isKeyFrame))();return r&&console.log("encode: frame:",o,f,u,s.encodeQueueSize),s.encode(f.frame,{keyFrame:u}),f.frame.close(),d(),c()?(r&&console.log("encode: recieving vchunk: resolve immediate"),Promise.resolve()):(r&&console.log("encode: recieving vchunk: wait for allowWrite"),new Promise(p=>{l=p}))}catch(u){return console.error("encode: caught error",u),Promise.resolve()}},async flush(f){return r&&console.log("encode: [terminate] flush",o,a),s.flush().then(()=>{r&&console.log("encode: [terminate] done",o,a),f.terminate()});f.terminate()}})}var ie=K(W());var $=K(W());function Re(e,t=new Uint8Array(0)){if(!e.startsWith("av01."))throw new Error(`codec ${e} is not supported`);let[,r,s,o,a,h]=e.split("."),l=new $.DataStream;return l.endianness=$.DataStream.BIG_ENDIAN,l.writeUint8(129),l.writeUint8((parseInt(r)<<5)+parseInt(s.slice(0,-1))),l.writeUint8(((s.slice(0,-1)==="M"?0:1)<<7)+((parseInt(o)>8?1:0)<<6)+((parseInt(o)===12?1:0)<<5)+(parseInt(a)<<4)+(parseInt((h??"110").slice(0,2),2)<<2)+0),l.writeUint8(0),l.writeUint8Array(t),l.buffer}$.BoxParser.av1CBox.prototype.write=function(e){this.size=4+(this.configOBUs?.byteLength??0),this.writeHeader(e),e.writeUint8(128+this.version),e.writeUint8((this.seq_profile<<5)+this.seq_level_idx_0),e.writeUint8((this.seq_tier_0<<7)+(this.high_bitdepth<<6)+(this.twelve_bit<<5)+(this.monochrome<<4)+(this.chroma_subsampling_x<<3)+(this.chroma_subsampling_y<<2)+this.chroma_sample_position),e.writeUint8((this.reserved_1<<5)+(this.initial_presentation_delay_present<<4)+this.initial_presentation_delay_present?this.initial_presentation_delay_minus_one:this.reserved_2),e.writeUint8Array(this.configOBUs)};function De(e,t){if(t.edits){let s=e.add("edts").add("elst");t.edits.forEach(o=>{s.addEntry(o)})}}function pt(e,t=!1){let r=Re(e),s=new ie.BoxParser.av1CBox(r.byteLength);return s.parse(new ie.MP4BoxStream(r)),t&&console.log("write: metadata: getAv1CBox",e,r,s),s}function Oe(e,t,r,s,o,a,h=!1){let l,d,c=0,f=0;return new TransformStream({start(){},async transform(m,u){try{if(m.type==="metadata"&&!d){let p=r.duration;l=e.addTrack({name:"VideoHandle",type:t.codec.split(".")[0],timescale:r.timescale,duration:p,media_duration:p,language:r.language,width:t.width,height:t.height,...t.codec.startsWith("avc")?{avcDecoderConfigRecord:m.data.decoderConfig?.description}:t.codec.startsWith("hevc")?{hevcDecoderConfigRecord:m.data.decoderConfig?.description}:t.codec.startsWith("av01")?{description:pt(m.data.decoderConfig?.codec??t.codec,h)}:{}}),d=e.getTrackById(l),d.tkhd&&d.tkhd.set("matrix",r.matrix),De(d,r),e.setSegmentOptions(l,null,{nbSamples:s.getResultSamples()}),h&&console.log("write: addTrack",l,d,r.timescale),o(l),await a;return}else if(m.type==="encodedVideoChunk"){c++;let p=m.data,y=new ArrayBuffer(p.byteLength);p.copyTo(y);let x={cts:Math.round(p.timestamp*r.timescale/1e6),dts:Math.round(f*r.timescale/1e6),duration:Math.round((p.duration??1)*r.timescale/1e6)},S=e.addSample(l,y,{...x,is_sync:p.type==="key"});h&&console.log("write: addSample",c,x,S),u.enqueue(S),f+=p.duration??1}}catch(p){console.error("write: caught error",p)}},flush(m){h&&console.log("write: flush",e),m.terminate()}})}function ut(e,t,r,s={},o=!1){let a=e.getTrackById(t);De(a,r),e.setSegmentOptions(t,null,{nbSamples:r.nb_samples}),o&&console.log("write samples to file: addTrack",`#${t}`,a,r.nb_samples);let h=0;return new WritableStream({start(){},write(l){h++;let d=e.addSample(t,l.data,{duration:l.duration,cts:l.cts,dts:l.dts,is_sync:l.is_sync,is_leading:l.is_leading,depends_on:l.depends_on,is_depended_on:l.is_depended_on,has_redundancy:l.has_redundancy,degradation_priority:l.degradation_priority,subsamples:l.subsamples,...s});o&&console.log("write samples to file: addSample",`#${t}`,h,l,d)},close(){o&&console.log("write samples to file: close",`#${t}`,e)}})}function _e(e,t,r,s=!1){let a=ee(r).reduce((l,d)=>{if(l)return l;if(d.type==="mp4a"&&"esds"in d)return d.esds},void 0),h=e.addTrack({type:t.codec.split(".")[0],hdlr:"soun",name:"SoundHandle",timescale:t.timescale,duration:0,media_duration:0,language:t.language,width:0,height:0,channel_count:t.audio.channel_count,samplerate:t.audio.sample_rate,samplesize:t.audio.sample_size,description:a});return{writable:ut(e,h,t,{},s),trackId:h}}var me={constrained_baseline:"4240",baseline:"4200",extended:"5800",constrained_main:"4d40",main:"4d00",constrained_high:"640c",high:"6400",high_progressive:"6408",high_10:"6e00",high_10_intra:"6e10",high_422:"7a00",high_422_intra:"7a10",high_444_predictive:"f400",high_444_intra:"f410",cavlc_444_intra:"2c00"},N=class{constructor(t,r,s){this.profileIdc=t;this.cpbBrVclFactor=r;this.cpbBrNalFactor=s}},_t=[new N(66,1e3,1200),new N(77,1e3,1200),new N(88,1e3,1200),new N(100,1250,1500),new N(110,3e3,3600),new N(122,4e3,4800),new N(244,4e3,4800),new N(44,4e3,4800)];function mt(e){let t=parseInt(me[e].substring(0,2),16),r=_t.find(({profileIdc:s})=>s===t);if(!r)throw new Error(`profile ${e} is not supported`);return r.cpbBrNalFactor}var C=class{constructor(t,r,s,o,a,h,l,d,c,f,m){this.name=t;this.levelIdc=r;this.cs3fFlag=s;this.maxMBPS=o;this.maxFS=a;this.maxDpbMbs=h;this.maxBR=l;this.maxCPB=d;this.maxVmvR=c;this.minCR=f;this.maxMvsPer2Mb=m}},Ne=[new C("1",10,0,1485,99,396,64,175,64,2,0),new C("1b",9,0,1485,99,396,128,350,64,2,0),new C("1.1",11,0,3e3,396,900,192,500,128,2,0),new C("1.2",12,0,6e3,396,2376,384,1e3,128,2,0),new C("1.3",13,0,11880,396,2376,768,2e3,128,2,0),new C("2",20,0,11880,396,2376,2e3,2e3,128,2,0),new C("2.1",21,0,19800,792,4752,4e3,4e3,256,2,0),new C("2.2",22,0,20250,1620,8100,4e3,4e3,256,2,0),new C("3",30,0,40500,1620,8100,1e4,1e4,256,2,32),new C("3.1",31,0,108e3,3600,18e3,14e3,14e3,512,4,16),new C("3.2",32,0,216e3,5120,20480,2e4,2e4,512,4,16),new C("4",40,0,245760,8192,32768,2e4,25e3,512,4,16),new C("4.1",41,0,245760,8192,32768,5e4,62500,512,2,16),new C("4.2",42,0,522240,8704,34816,5e4,62500,512,2,16),new C("5",50,0,589824,22080,110400,135e3,135e3,512,2,16),new C("5.1",51,0,983040,36864,184320,24e4,24e4,512,2,16),new C("5.2",52,0,2073600,36864,184320,24e4,24e4,512,2,16),new C("6",60,0,4177920,139264,696320,24e4,24e4,8192,2,16),new C("6.1",61,0,8355840,139264,696320,48e4,48e4,8192,2,16),new C("6.2",62,0,16711680,139264,696320,8e5,8e5,8192,2,16)];function gt({profile:e,width:t,height:r,fps:s,prefferedAllowingMaxBitrate:o,maxDecFrameBuffering:a},h=!1){let l=me[e];if(!l)throw new Error(`avc1 guess lv: profile ${e} is not supported`);if(!Math.max(t,0)||!Math.max(r,0)||!Math.max(s,0))throw new Error("avc1 guess lv: width, heighta and fps must be positive number");let d=l.startsWith("42")||l.startsWith("4d")||l.startsWith("58"),c=mt(e),f=Math.ceil(t/16),m=Math.ceil(r/16),u=f*m,p=u*s,y=u*(a??0),x=f**2,S=m**2,w;for(let T=0;T<Ne.length;T++){let E=Ne[T];if(!(E.cs3fFlag&&!d)&&!(u>E.maxFS)&&!(x>8*E.maxFS)&&!(S>8*E.maxFS)&&!(p>E.maxMBPS)&&!(a&&y>E.maxDpbMbs)){if(h&&console.log("avc1 guess lv: level choosing: bitrate",E.name,(o??0)/1e3,E.maxBR,c,E.maxBR*c/1e3),o&&o>E.maxBR*c){w=E.levelIdc;continue}return h&&console.log("avc1 guess lv: level choosing: level chosen",E.name,E.levelIdc),E.levelIdc}}if(w)return h&&console.log("avc1 guess lv: level choosing: anti-preffered level chosen",w),w;throw new Error("avc1 guess lv: suitable level is not found")}function yt(e){return e.toString(16).padStart(2,"0")}function vt(e,t){return`avc1.${me[e]}${yt(t)}`}function Ge(e,t=!1){return vt(e.profile,gt(e,t))}var xt={Main:0,High:1,Professional:2},bt={"4:0:0":"111","4:2:0":"110","4:2:2":"100","4:4:4":"000"},St={BT_709:1,UNSPECIFIED:2,BT_470_M:4,BT_470_B_G:5,BT_601:6,SMPTE_240:7,GENERIC_FILM:8,BT_2020:9,XYZ:10,SMPTE_431:11,SMPTE_432:12,EBU_3213:22},wt={RESERVED_0:0,BT_709:1,UNSPECIFIED:2,RESERVED_3:3,BT_470_M:4,BT_470_B_G:5,BT_601:6,SMPTE_240:7,LINEAR:8,LOG_100:9,LOG_100_SQRT10:10,IEC_61966:11,BT_1361:12,SRGB:13,BT_2020_10_BIT:14,BT_2020_12_BIT:15,SMPTE_2084:16,SMPTE_428:17,HLG:18},Ut={IDENTITY:0,BT_709:1,UNSPECIFIED:2,RESERVED_3:3,FCC:4,BT_470_B_G:5,BT_601:6,SMPTE_240:7,SMPTE_YCGCO:8,BT_2020_NCL:9,BT_2020_CL:10,SMPTE_2085:11,CHROMAT_NCL:12,CHROMAT_CL:13,ICTCP:14},G=void 0,L=class{constructor(t,r,s,o,a,h,l,d,c,f,m,u,p,y){this.name=t;this.levelIdx=r;this.maxPicSize=s;this.maxHSize=o;this.maxVSize=a;this.maxDisplayRate=h;this.maxDecodeRate=l;this.maxHeaderRate=d;this.mainMbps=c;this.highMbps=f;this.mainCR=m;this.highCR=u;this.maxTiles=p;this.maxTileCols=y}},Ve=[new L("2.0",0,147456,2048,1152,4423680,5529600,150,1.5,G,2,G,8,4),new L("2.1",1,278784,2816,1584,8363520,10454400,150,3,G,2,G,8,4),new L("3.0",4,665856,4352,2448,19975680,24969600,150,6,G,2,G,16,6),new L("3.1",5,1065024,5504,3096,31950720,39938400,150,10,G,2,G,16,6),new L("4.0",8,2359296,6144,3456,70778880,77856768,300,12,30,4,4,32,8),new L("4.1",9,2359296,6144,3456,141557760,155713536,300,20,50,4,4,32,8),new L("5.0",12,8912896,8192,4352,267386880,273715200,300,30,100,6,4,64,8),new L("5.1",13,8912896,8192,4352,534773760,547430400,300,40,160,8,4,64,8),new L("5.2",14,8912896,8192,4352,1069547520,1094860800,300,60,240,8,4,64,8),new L("5.3",15,8912896,8192,4352,1069547520,1176502272,300,60,240,8,4,64,8),new L("6.0",16,35651584,16384,8704,1069547520,1176502272,300,60,240,8,4,128,16),new L("6.1",17,35651584,16384,8704,2139095040,2189721600,300,100,480,8,4,128,16),new L("6.2",18,35651584,16384,8704,4278190080,4379443200,300,160,800,8,4,128,16),new L("6.3",19,35651584,16384,8704,4278190080,4706009088,300,160,800,8,4,128,16)];function Et({profile:e,width:t,height:r,tiles:s,tileCols:o,fps:a,prefferedAllowingMaxBitrate:h},l=!1){let d=G,c,f=t*r,m=f*a;for(let u=0;u<Ve.length;u++){let p=Ve[u];if(!(f>p.maxPicSize)&&!(t>p.maxHSize)&&!(r>p.maxVSize)&&!(m>p.maxDisplayRate)&&(d=e==="Main"?p.mainMbps:p.highMbps,d!==G)){if(h&&(l&&console.log(`av01 guess lv: maxBrMbps: ${d}Mbps, prefferedAllowingMaxBitrate: ${h/1e6}Mbps`),h>1e6*d)){c=p;continue}if(!(s??0>p.maxTiles)&&!(o??0>p.maxTileCols))return p}}if(c)return l&&console.log("av01 guess lv: level choosing: anti-preffered level chosen",c),c;throw new Error("av01 guess lv: suitable level is not found")}function Tt(e,t){return t>7?e:"M"}function re(e,t){return e.toString().padStart(t,"0")}function He(e,t=8,r="M",s,o=!1){let a=Et(e,o),h=`av01.${xt[e.profile]}.${re(a.levelIdx,2)}${Tt(r,a.levelIdx)}.${t.toString().padStart(2,"0")}`;return s?[h,s.monoChrome?"1":"0",bt[s.chromaSubsampling],re(St[s.colorPrimary],2),re(wt[s.transferCharacteristics],2),re(Ut[s.matrixCoefficients],2),s.videoFullRange?"1":"0"].join("."):h}var ge=K(W());function ye({startPositionMap:e,fileSize:t}){let r=new ge.DataStream;r.endianness=ge.DataStream.BIG_ENDIAN,r.writeUint32(0),r.writeString("mfra",null,4);for(let[o,a]of e)r.writeUint32(43),r.writeString("tfra",null,4),r.writeUint8(1),r.writeUint24(0),r.writeUint32(o),r.writeUint32(0),r.writeUint32(1),r.writeUint64(0),r.writeUint64(a),r.writeUint8(1),r.writeUint8(1),r.writeUint8(1);r.writeUint32(16),r.writeString("mfro",null,4),r.writeUint8(0),r.writeUint24(0);let s=r.getPosition()+4;return r.writeUint32(s),r.adjustUint32(0,s),t&&(r.buffer.fileStart=t),r}function Ye(e,t){let r=(0,X.createFile)();if(r.init({brands:Array.from(e).filter(s=>s&&typeof s=="string"&&s.length===4),timescale:t.timescale,duration:0}),r.moov){let s=new Date("1904-01-01T00:00:00Z").getTime();r.moov.mvhd?.set("creation_time",Math.floor((t.created.getTime()-s)/1e3)),r.moov.mvhd?.set("modification_time",Math.floor((Date.now()-s)/1e3)),(r.moov.mvex?.add("mehd")).set("fragment_duration",t.duration)}return r}var se=class{constructor(t,r,s=!1){this.dstFile=t;this.cb=r;this.DEV=s}nextBox=0;fileSize=0;startPositionMap=new Map;send(){this.DEV&&console.log("index: send box called",this.nextBox,this.dstFile.boxes.length);for(let t=this.nextBox;t<this.dstFile.boxes.length;t++){this.DEV&&console.log("index: send box",this.nextBox,t,this.dstFile.boxes[t]);let r=this.dstFile.boxes[t];if(r.type==="moof"){let o=r.trafs[0].tfhd.track_id;this.startPositionMap.has(o)||(this.startPositionMap.set(o,this.fileSize),this.DEV&&console.log("index: send box: set start position",o,this.fileSize))}let s=fe(r);this.fileSize+=s.byteLength,this.cb(s),r.data&&(r.data=void 0)}this.DEV&&console.log("index: send box: next",this.dstFile.boxes.length),this.nextBox=this.dstFile.boxes.length}},Z=class{count=0;constructor(){}countingTransformStream(t){let r=this;return new TransformStream({start(){},transform(s,o){o.enqueue(s),r.count++,t&&t()},flush(){}})}},ne=class extends EventTarget{processes=new Map;constructor(){super()}async waitForAllProcesses(){await Promise.all(this.processes.values())}async getProcesses(){return new Map(this.processes)}async start(t){let r=t.identifier??crypto.randomUUID();if(this.processes.has(t.identifier))throw new Error("Already started");let s=this._start({...t,identifier:r});this.processes.set(r,s);try{await s}catch(o){t.DEV&&console.error("start root: error caught",o),this.dispatchEvent(new CustomEvent("error",{detail:{identifier:r,error:o}}))}finally{this.processes.delete(r)}}async _start(t){let r=t.DEV??!1;X.Log.setLogLevel(r?X.Log.LOG_LEVEL_DEBUG:X.Log.LOG_LEVEL_ERROR);let s=t.identifier;r&&console.log("index: start",t);let o=this.dispatchEvent.bind(this),a=(()=>{let U,A=new Promise(R=>{U=R}),k,b=new Promise(R=>{k=R});return{videoTrackAddedCallback:U,videoTrackAddedPromise:A,startToWriteVideoChunksCallback:k,startToWriteVideoChunksPromise:b}})(),h=await Fe(t.file);if(r&&console.log("index: info",h),!("videoInfo"in h)){if(h.info.audioTracks.length>0)return this._audioOnly(s,t,h,r);throw new Error("No video track found")}let l=(h.videoInfo.nb_samples??0)+h.info.audioTracks.reduce((U,A)=>U+A.nb_samples,0),d=new Z;function c(U){o(new CustomEvent("progress",{detail:{identifier:s,samplesNumber:l,samplesCount:typeof U=="number"?U:d.count}}))}c();let f=Ce(h.videoInfo.video,t.resizeConfig),m={width:ue(f.width,2),height:ue(f.height,2)},u=(()=>t.videoEncoderConfig.codec?t.videoEncoderConfig.codec:t.videoEncodeCodecRequest&&t.videoEncodeCodecRequest.type==="av01"?He({width:m.width,height:m.height,profile:t.videoEncodeCodecRequest?.profile??"Main",fps:h.fps,prefferedAllowingMaxBitrate:t.videoEncoderConfig?.bitrate??void 0},t.videoEncodeCodecRequest.depth??8,t.videoEncodeCodecRequest.seqTier??"M",t.videoEncodeCodecRequest.additional,r):Ge({width:m.width,height:m.height,profile:t.videoEncodeCodecRequest?.profile??"constrained_baseline",fps:h.fps,prefferedAllowingMaxBitrate:t.videoEncoderConfig?.bitrate??void 0},r))(),p={...t.videoEncoderConfig,...m,codec:u.startsWith("vp08")?"vp8":u,framerate:Math.round(h.fps*100)/100,...u.startsWith("avc")?{avc:{format:"avc"}}:{}};r&&console.log("index: start: encoderConfig",p);try{let U=await VideoEncoder.isConfigSupported(p);if(r&&console.log("index: start: isConfigSupported",JSON.parse(JSON.stringify(U))),!U||!U.supported)throw console.error("Your encoding config is not supported.",U),new Error(`Your encoding config is not supported. ${JSON.stringify(U)}`)}catch(U){throw o(new CustomEvent("error",{detail:{identifier:s,error:U}})),U}let y=Ye(["isom","iso6","iso2",p.codec.split(".")[0],...h.info.audioTracks.map(U=>U.codec.split(".")[0])],h.info);r&&console.log("index: prepare",l,d.count,m,p,y);let x=new se(y,U=>{o(new CustomEvent("segment",{detail:{identifier:s,buffer:U}}))},r),S=new Z,w={dropFramesOnDecoding:0,dropFrames:0,getResultSamples:()=>Math.max(h.videoInfo.nb_samples,S.count)-w.dropFrames-w.dropFramesOnDecoding},E=(()=>new WritableStream({start(){},write(){x.send()},close(){x.send()}}))(),P=t.file.stream().pipeThrough(te(h.videoInfo.id,r)).pipeThrough(d.countingTransformStream()).pipeThrough(Pe(r)).pipeThrough(await ze(h.videoInfo,h.description,t.videoDecoderConfig??{},w,r)).pipeThrough(ke(h.videoInfo,w,r)).pipeThrough(Le(t.resizeConfig,r)).pipeThrough(Me(p,t.videoKeyframeConfig,r)).pipeThrough(d.countingTransformStream(c)).pipeThrough(Oe(y,p,h.videoInfo,w,a.videoTrackAddedCallback,Promise.resolve(),r)).pipeTo(E).catch(U=>{console.error("video stream error",U),o(new CustomEvent("error",{detail:{identifier:s,error:U}}))});await a.videoTrackAddedPromise;let z=[],M=[];for(let U of h.info.audioTracks){let{writable:A,trackId:k}=_e(y,U,h.file.getTrackById(U.id),r);M.push(k),z.push(()=>t.file.stream().pipeThrough(te(U.id,r)).pipeThrough(d.countingTransformStream(c)).pipeTo(A).catch(b=>{o(new CustomEvent("error",{detail:{identifier:s,error:b}}))}))}r&&console.log("index: send first boxes",y),x.send();for(let U=0;U<z.length;U++){let A=z[U];await A(),x.send()}r&&console.log("index: start writing video chunks"),a.startToWriteVideoChunksCallback(),await P,r&&console.log("index: writing video chunks finished");let O=ye({startPositionMap:x.startPositionMap,fileSize:x.fileSize});o(new CustomEvent("segment",{detail:{identifier:s,buffer:O.buffer}})),d.count!==l&&c(l),r&&console.log("index: mux finish",l,d.count,y),o(new CustomEvent("complete",{detail:{identifier:s}})),y.flush()}async _audioOnly(t,r,s,o=!1){o&&console.log("index: THIS IS AUDIO FILE");let a=this.dispatchEvent.bind(this),h=s.info.audioTracks.reduce((y,x)=>y+x.nb_samples,0),l=new Z;function d(y){a(new CustomEvent("progress",{detail:{identifier:t,samplesNumber:h,samplesCount:typeof y=="number"?y:l.count}}))}d();let c=Ye(["isom","iso6","iso2",...s.info.audioTracks.map(y=>y.codec.split(".")[0])],s.info);o&&console.log("index: prepare",h,l.count,c);let f=new se(c,y=>{a(new CustomEvent("segment",{detail:{identifier:t,buffer:y}}))},o),m=[],u=[];for(let y of s.info.audioTracks){let{writable:x,trackId:S}=_e(c,y,s.file.getTrackById(y.id),o);u.push(S),m.push(()=>r.file.stream().pipeThrough(te(y.id,o)).pipeThrough(l.countingTransformStream(d)).pipeTo(x).catch(w=>{a(new CustomEvent("error",{detail:{identifier:t,error:w}}))}))}o&&console.log("index: send first boxes",c),f.send();for(let y=0;y<m.length;y++){let x=m[y];await x(),f.send()}let p=ye({startPositionMap:f.startPositionMap,fileSize:f.fileSize});a(new CustomEvent("segment",{detail:{identifier:t,buffer:p.buffer}})),l.count!==h&&d(h),o&&console.log("index: mux finish",h,l.count,c),a(new CustomEvent("complete",{detail:{identifier:t}})),c.flush()}};var Bt=["progress","error"];function We(e){return t=>{globalThis.postMessage({type:e,...t.detail})}}var ve=new ne;globalThis.onmessage=async e=>{let t=e.data;if(!t.identifier)throw new Error("You must specify identifier");if(typeof t.identifier!="string")throw new Error("identifier must be string");let o=await(await(await navigator.storage.getDirectory()).getFileHandle(t.identifier,{create:!0})).createSyncAccessHandle();globalThis.postMessage({type:"opfs-file-created",identifier:t.identifier}),await new Promise((a,h)=>{let l=new Map(Bt.map(d=>[d,We(d)]));l.set("segment",async d=>{o.write(d.detail.buffer,{at:o.getSize()})}),l.set("complete",async d=>{o.flush(),We("complete")(d),a();for(let[c,f]of l)ve.removeEventListener(c,f)});for(let[d,c]of l)ve.addEventListener(d,c);ve.start(t).catch(d=>h(d))})};
